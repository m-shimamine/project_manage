<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç† - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"><\/script>')</script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚»ãƒ« - 1æ—¥ã‚ãŸã‚Š40px */
        .gantt-cell {
            min-width: 40px;
            width: 40px;
            height: 32px;
        }
        /* ã‚¿ã‚¹ã‚¯è¡Œã®é«˜ã• - ã‚¬ãƒ³ãƒˆã¨åŒã˜44px */
        .task-row {
            height: 44px;
            min-height: 44px;
        }
        .task-bar {
            height: 28px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .task-bar span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: calc(100% - 20px);
        }
        /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ãƒ›ãƒãƒ¼åŠ¹æœã‚’æœ‰åŠ¹åŒ– */
        body.edit-mode .task-bar {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: grab;
        }
        body.edit-mode .task-bar:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        /* è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ãƒ›ãƒãƒ¼åŠ¹æœãªã— */
        body:not(.edit-mode) .task-bar {
            cursor: default;
        }
        .scroll-sync {
            scrollbar-width: thin;
            scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
        }
        .scroll-sync::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        .scroll-sync::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .scroll-sync::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.6);
            border-radius: 5px;
        }
        .scroll-sync::-webkit-scrollbar-thumb:hover {
            background-color: rgba(156, 163, 175, 0.8);
        }
        .weekend-sat {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }
        .weekend-sun {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }
        .today-marker {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            font-weight: 700;
            color: #92400e;
        }
        .sidebar-gradient {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
        }
        .card-shadow {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .card-shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }
        .nav-item {
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 2px 8px;
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }
        .nav-item.active {
            background: rgba(59, 130, 246, 0.15);
            border-left: 3px solid #3b82f6;
        }

        /* ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .sidebar-modal {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            z-index: 200;
            display: none;
            box-shadow: 4px 0 24px rgba(0,0,0,0.3);
        }
        .sidebar-modal.show {
            display: block;
        }
        .sidebar-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 199;
            display: none;
        }
        .sidebar-modal-overlay.show {
            display: block;
        }
        .sidebar-modal .nav-item {
            margin: 4px 12px;
            padding: 12px 16px;
        }
        .sidebar-modal .nav-item:hover {
            background: rgba(59, 130, 246, 0.15);
        }
        .progress-bar {
            transition: width 0.5s ease;
        }
        /* ã‚¿ã‚¹ã‚¯åãƒªãƒ³ã‚¯ï¼ˆã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰ */
        .task-name-link {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.15s ease;
            color: #334155;
            text-decoration: none;
            position: relative;
        }
        .task-name-link::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 0;
            height: 1px;
            background: #3b82f6;
            transition: width 0.2s ease;
        }
        .task-name-link:hover {
            color: #2563eb;
        }
        .task-name-link:hover::after {
            width: 100%;
        }
        .task-name-link i {
            font-size: 10px;
            margin-left: 4px;
            opacity: 0;
            transform: translateX(-4px);
            transition: all 0.15s ease;
            color: #3b82f6;
        }
        .task-name-link:hover i {
            opacity: 1;
            transform: translateX(0);
        }
        .task-name-link.parent {
            font-weight: 600;
            color: #1e293b;
        }
        .task-name-link.parent:hover {
            color: #1d4ed8;
        }
        /* åˆ—å¹…ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« */
        .column-resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            cursor: col-resize;
            background: transparent;
            z-index: 10;
        }
        .column-resize-handle:hover {
            background: #3b82f6;
        }
        .resizable-column {
            position: relative;
            min-width: 60px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿ */
        .sidebar-expanded { width: 240px; }
        .sidebar-collapsed { width: 48px !important; }
        .sidebar-collapsed .nav-text { display: none; }
        .sidebar-collapsed .sidebar-title { display: none; }
        .sidebar-collapsed .nav-item {
            justify-content: center;
            padding: 12px 0;
            margin: 2px 4px;
        }
        .sidebar-collapsed .nav-item i { margin: 0; }
        .sidebar-collapsed .sidebar-header {
            justify-content: center;
            padding: 12px 0;
        }
        .sidebar-collapsed .sidebar-header a {
            justify-content: center;
        }
        .sidebar-collapsed .sidebar-header a i { margin: 0; }
        .sidebar-collapsed .toggle-btn { display: none; }
        .sidebar-collapsed .toggle-btn-collapsed { display: flex !important; }
        .sidebar-transition { transition: width 0.2s ease; }

        /* ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªã‚¿ã‚¹ã‚¯ãƒãƒ¼ */
        .task-bar-draggable {
            cursor: grab;
            user-select: none;
        }
        .task-bar-draggable:active {
            cursor: grabbing;
        }
        .task-bar-draggable .resize-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: ew-resize;
            background: transparent;
        }
        .task-bar-draggable .resize-handle:hover {
            background: rgba(255,255,255,0.3);
        }
        .task-bar-draggable .resize-left { left: 0; }
        .task-bar-draggable .resize-right { right: 0; }

        /* ã‚¿ã‚¹ã‚¯ãƒãƒ¼é¸æŠçŠ¶æ…‹ */
        .task-bar-selected {
            outline: 3px solid #f59e0b !important;
            outline-offset: 1px;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
            z-index: 20 !important;
        }
        .task-row-selected {
            background-color: #fef3c7 !important;
        }

        /* é¸æŠãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
        #selection-toolbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }

        /* æœˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®é«˜ã• */
        .month-header-row {
            height: 32px;
        }
        .date-header-row {
            height: 32px;
        }
        .weekday-header-row {
            height: 24px;
        }

        /* å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 180px;
            padding: 4px 0;
            display: none;
        }
        .context-menu.show {
            display: block;
        }
        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #475569;
        }
        .context-menu-item:hover {
            background: #f1f5f9;
        }
        .context-menu-item i {
            width: 20px;
            margin-right: 8px;
            color: #94a3b8;
        }
        .context-menu-separator {
            height: 1px;
            background: #e2e8f0;
            margin: 4px 0;
        }

        /* ã‚«ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆä¸¦ã³æ›¿ãˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ï¼‰ */
        .column-header {
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: background 0.2s;
        }
        .column-header:hover {
            background: #f1f5f9;
        }
        .column-header.active {
            background: #eff6ff;
        }
        .column-header .sort-icon {
            margin-left: 2px;
            font-size: 9px;
            opacity: 0.5;
        }
        .column-header.sorted .sort-icon {
            opacity: 1;
            color: #3b82f6;
        }

        /* ã‚«ãƒ©ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆä¸¦ã³æ›¿ãˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ï¼‰ */
        .column-menu {
            position: fixed;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 180px;
            padding: 8px 0;
            display: none;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.15s ease, visibility 0.15s ease;
        }
        .column-menu.show {
            display: block;
            visibility: visible;
            opacity: 1;
        }
        .column-menu-item {
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            color: #475569;
        }
        .column-menu-item:hover {
            background: #f8fafc;
        }
        .column-menu-item i {
            width: 16px;
            margin-right: 8px;
            color: #94a3b8;
        }
        .column-menu-item.active {
            background: #eff6ff;
            color: #3b82f6;
        }
        .column-menu-item.active i {
            color: #3b82f6;
        }
        .column-menu-separator {
            height: 1px;
            background: #e2e8f0;
            margin: 4px 0;
        }
        .column-menu-filter {
            padding: 8px 12px;
        }
        .column-menu-filter select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 12px;
        }

        /* äºˆå®š/å®Ÿç¸¾åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
        .toggle-btn-group {
            display: flex;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        .toggle-btn-item {
            padding: 6px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: white;
        }
        .toggle-btn-item.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        .toggle-btn-item:not(.active):hover {
            background: #f8fafc;
        }

        /* é…ã‚Œæ—¥æ•°è¡¨ç¤º */
        .delay-badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .delay-late {
            background: #fef2f2;
            color: #dc2626;
        }
        .delay-ahead {
            background: #f0fdf4;
            color: #16a34a;
        }
        .delay-ontime {
            background: #f8fafc;
            color: #64748b;
        }

        /* æ¤œç´¢ãƒ‘ãƒãƒ« */
        .search-panel {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 12px 16px;
            display: none;
        }
        .search-panel.show {
            display: block;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .user-menu-container {
            position: relative;
        }
        .user-menu-trigger {
            cursor: pointer;
            transition: all 0.2s;
        }
        .user-menu-trigger:hover {
            background: #f8fafc;
        }
        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 9999;
            min-width: 240px;
            padding: 0;
            display: none;
            overflow: hidden;
        }
        .user-menu-dropdown.show {
            display: block;
            animation: fadeInDown 0.2s ease;
        }
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .user-menu-header {
            padding: 16px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e2e8f0;
        }
        .user-menu-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #475569;
            font-size: 14px;
        }
        .user-menu-item:hover {
            background: #f8fafc;
        }
        .user-menu-item i {
            width: 20px;
            margin-right: 12px;
            color: #94a3b8;
        }
        .user-menu-item.logout {
            color: #dc2626;
            border-top: 1px solid #e2e8f0;
        }
        .user-menu-item.logout i {
            color: #dc2626;
        }
        .user-menu-item.logout:hover {
            background: #fef2f2;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
        .scroll-sync-header {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .scroll-sync-header::-webkit-scrollbar {
            display: none;
        }

        /* ã‚¿ã‚¹ã‚¯ãƒ‘ãƒãƒ«ã®ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤ºï¼ˆã‚¬ãƒ³ãƒˆå´ã§åˆ¶å¾¡ï¼‰ */
        #task-panel {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        #task-panel::-webkit-scrollbar {
            display: none;
        }

        /* å¤‰æ›´ã•ã‚ŒãŸè¡Œã®èƒŒæ™¯è‰² */
        .task-row-modified {
            background: linear-gradient(135deg, #fef9c3 0%, #fef08a 100%) !important;
        }
        .task-row-modified:hover {
            background: linear-gradient(135deg, #fef08a 0%, #fde047 100%) !important;
        }

        /* ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ */
        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8fafc;
        }
        .drop-zone.drag-over {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            transform: scale(1.02);
        }
        .drop-zone-icon {
            font-size: 48px;
            color: #94a3b8;
            margin-bottom: 16px;
        }
        .drop-zone.drag-over .drop-zone-icon {
            color: #3b82f6;
        }

        /* ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« */
        .import-modal {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: none;
        }
        .import-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .import-modal-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        .import-modal-content {
            position: relative;
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ */
        .group-modal-fullscreen {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: none;
        }
        .group-modal-fullscreen.show {
            display: block;
        }
        .group-modal-content {
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
        }

        /* ä½œæ¥­é †å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
        .order-input {
            width: 100%;
            text-align: center;
            border: none;
            background: transparent;
            font-size: 12px;
            padding: 2px;
        }
        .order-input:focus {
            outline: none;
            background: white;
            border: 1px solid #3b82f6;
            border-radius: 4px;
        }

        /* ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå½¢å¼é¸æŠã‚«ãƒ¼ãƒ‰ */
        .export-format-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .export-format-card:hover {
            border-color: #94a3b8;
            background: #f8fafc;
        }
        .export-format-option input:checked + .export-format-card {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* ã‚¿ã‚¹ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ */
        .task-modal-fullscreen {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: none;
        }
        .task-modal-fullscreen.show {
            display: block;
        }
        .task-modal-content {
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
        }

        /* å±¥æ­´ã‚«ãƒ¼ãƒ‰ */
        .history-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .history-card-header {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .history-card-body {
            padding: 10px 12px;
            border-top: 1px solid #e2e8f0;
        }

        /* è¡Œé¸æŠ */
        .task-row-item.selected {
            background: #eff6ff !important;
        }

        /* ãƒšãƒ¼ã‚¹ãƒˆé ˜åŸŸ */
        .paste-area-panel {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .paste-area-panel:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .paste-area-panel.dragover {
            border-color: #3b82f6;
            background: #dbeafe;
        }

    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="sidebar-modal-overlay" id="sidebar-overlay"></div>

    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <aside class="sidebar-modal" id="sidebar-modal">
        <div class="p-4 border-b border-slate-700/50 flex items-center justify-between">
            <a href="../dashboard.html" class="flex items-center">
                <i class="fas fa-project-diagram text-blue-400 mr-3 text-lg"></i>
                <span class="text-lg font-bold text-white">PM System</span>
            </a>
            <button id="sidebar-close" class="p-1.5 hover:bg-slate-700 rounded text-slate-400">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="mt-4">
            <a href="../dashboard.html" class="nav-item flex items-center px-4 py-3 text-slate-300 hover:text-white">
                <i class="fas fa-tachometer-alt w-5 mr-3 text-slate-400"></i><span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
            </a>
            <a href="../customers/index.html" class="nav-item flex items-center px-4 py-3 text-slate-300 hover:text-white">
                <i class="fas fa-building w-5 mr-3 text-slate-400"></i><span>é¡§å®¢</span>
            </a>
            <a href="../projects/index.html" class="nav-item flex items-center px-4 py-3 text-slate-300 hover:text-white">
                <i class="fas fa-folder w-5 mr-3 text-slate-400"></i><span>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</span>
            </a>
            <a href="index.html" class="nav-item active flex items-center px-4 py-3 text-white">
                <i class="fas fa-calendar-alt w-5 mr-3 text-blue-400"></i><span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span>
            </a>
            <a href="../members/index.html" class="nav-item flex items-center px-4 py-3 text-slate-300 hover:text-white">
                <i class="fas fa-users w-5 mr-3 text-slate-400"></i><span>ãƒ¡ãƒ³ãƒãƒ¼</span>
            </a>
            <a href="#" class="nav-item flex items-center px-4 py-3 text-slate-300 hover:text-white">
                <i class="fas fa-yen-sign w-5 mr-3 text-slate-400"></i><span>åŸä¾¡ç®¡ç†</span>
            </a>
            <a href="../reports/index.html" class="nav-item flex items-center px-4 py-3 text-slate-300 hover:text-white">
                <i class="fas fa-chart-bar w-5 mr-3 text-slate-400"></i><span>ãƒ¬ãƒãƒ¼ãƒˆ</span>
            </a>
        </nav>
    </aside>

    <div class="flex h-screen overflow-hidden">
        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <header class="bg-white/80 backdrop-blur-lg card-shadow border-b border-slate-200/50 relative z-50">
                <div class="flex items-center justify-between px-6 py-3">
                    <div class="flex items-center space-x-4">
                        <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ + PM System ãƒ­ã‚´ -->
                        <div class="flex items-center space-x-3">
                            <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-slate-800 to-slate-900 flex items-center justify-center shadow-md hover:from-slate-700 hover:to-slate-800 transition-all cursor-pointer" id="menu-toggle">
                                <i class="fas fa-bars text-blue-400 text-sm"></i>
                            </div>
                            <a href="../dashboard.html" class="text-lg font-bold bg-gradient-to-r from-slate-800 to-slate-600 bg-clip-text text-transparent hover:from-blue-600 hover:to-indigo-600 transition-all">PM System</a>
                        </div>
                        <div class="w-px h-6 bg-slate-300"></div>
                        <!-- ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« -->
                        <div class="flex items-center space-x-2">
                            <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-sm">
                                <i class="fas fa-calendar-alt text-white text-xs"></i>
                            </div>
                            <h2 class="text-lg font-semibold text-slate-700">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†</h2>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2 px-3 py-1.5 bg-white rounded-lg border border-slate-200 shadow-sm">
                            <i class="fas fa-calendar text-slate-400 text-xs"></i>
                            <span class="text-xs font-medium text-slate-700">2024å¹´4æœˆ10æ—¥</span>
                        </div>
                        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
                        <div class="user-menu-container">
                            <div id="user-menu-trigger" class="user-menu-trigger flex items-center space-x-2 px-3 py-1.5 bg-white rounded-lg border border-slate-200 shadow-sm">
                                <div class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-400 to-indigo-500 ring-2 ring-white"></div>
                                <span class="text-sm font-medium text-slate-700">å±±ç”°å¤ªéƒ</span>
                                <i class="fas fa-chevron-down text-slate-400 text-xs ml-1" id="user-menu-arrow"></i>
                            </div>
                            <div id="user-menu-dropdown" class="user-menu-dropdown">
                                <div class="user-menu-header">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-white font-bold">
                                            å±±
                                        </div>
                                        <div>
                                            <div class="font-semibold text-slate-800">å±±ç”°å¤ªéƒ</div>
                                            <div class="text-xs text-slate-500">yamada@example.com</div>
                                        </div>
                                    </div>
                                    <div class="mt-3 pt-3 border-t border-slate-200">
                                        <div class="flex items-center text-xs text-slate-500">
                                            <i class="fas fa-clock mr-2 text-slate-400"></i>
                                            <span>æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³: 2024å¹´4æœˆ9æ—¥ 18:32</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="user-menu-item" onclick="location.href='#'">
                                    <i class="fas fa-user"></i>
                                    <span>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
                                </div>
                                <div class="user-menu-item" onclick="location.href='#'">
                                    <i class="fas fa-cog"></i>
                                    <span>è¨­å®š</span>
                                </div>
                                <div class="user-menu-item logout" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="bg-white border-b border-slate-200 px-6 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠï¼ˆé¡§å®¢åˆ¥ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ -->
                        <select id="project-select" class="border border-slate-300 rounded-lg px-3 py-1.5 text-sm font-medium bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" style="min-width: 280px;" onchange="onProjectChange(this.value)">
                            <option value="all">ğŸ“Š å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆæ¨ªæ–­è¡¨ç¤ºï¼‰</option>
                            <optgroup label="æ ªå¼ä¼šç¤¾ABCå•†äº‹">
                                <option value="1" selected>ECã‚µã‚¤ãƒˆãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«</option>
                                <option value="2">åŸºå¹¹ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°</option>
                            </optgroup>
                            <optgroup label="XYZæ ªå¼ä¼šç¤¾">
                                <option value="3">ç¤¾å†…æ¥­å‹™ã‚·ã‚¹ãƒ†ãƒ é–‹ç™º</option>
                                <option value="4">å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </option>
                            </optgroup>
                            <optgroup label="æ ªå¼ä¼šç¤¾ãƒ†ãƒƒã‚¯ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³">
                                <option value="5">ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªé–‹ç™º</option>
                            </optgroup>
                            <optgroup label="ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‰æ ªå¼ä¼šç¤¾">
                                <option value="6">åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </option>
                                <option value="7">å—ç™ºæ³¨ã‚·ã‚¹ãƒ†ãƒ æ”¹ä¿®</option>
                            </optgroup>
                        </select>

                        <!-- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ/ã‚¿ã‚¹ã‚¯åˆ‡ã‚Šæ›¿ãˆ -->
                        <div class="toggle-btn-group">
                            <button id="btn-gantt" class="toggle-btn-item active" onclick="switchView('gantt')">
                                <i class="fas fa-chart-gantt mr-1"></i>ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ
                            </button>
                            <button id="btn-task" class="toggle-btn-item" onclick="switchView('task')">
                                <i class="fas fa-list mr-1"></i>ã‚¿ã‚¹ã‚¯
                            </button>
                        </div>

                        <!-- äºˆå®š/å®Ÿç¸¾åˆ‡ã‚Šæ›¿ãˆ -->
                        <div class="toggle-btn-group">
                            <button id="btn-plan" class="toggle-btn-item active" onclick="switchMode('plan')">äºˆå®š</button>
                            <button id="btn-actual" class="toggle-btn-item" onclick="switchMode('actual')">å®Ÿç¸¾</button>
                        </div>
                    </div>

                    <div class="flex items-center space-x-3">
                        <!-- å¹´æœˆé¸æŠ -->
                        <select id="month-select" class="border border-slate-300 rounded-lg px-3 py-1.5 text-sm font-medium bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" onchange="scrollToMonth(this.value)">
                            <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                        </select>

                        <!-- ä»Šæ—¥ãƒœã‚¿ãƒ³ -->
                        <button onclick="scrollToToday()" class="px-4 py-1.5 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 shadow-sm bg-white">
                            ä»Šæ—¥
                        </button>

                        <!-- æ‹…å½“è€…ç¨¼åƒãƒœã‚¿ãƒ³ -->
                        <button onclick="openAssigneeWorkloadPage()" class="px-4 py-1.5 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 shadow-sm bg-white flex items-center">
                            <i class="fas fa-users mr-2"></i>æ‹…å½“è€…ç¨¼åƒ
                        </button>

                        <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
                        <button onclick="openImportModal()" class="px-4 py-1.5 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 shadow-sm bg-white flex items-center">
                            <i class="fas fa-file-import mr-2"></i>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        </button>

                        <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
                        <button onclick="openExportModal()" class="px-4 py-1.5 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 shadow-sm bg-white flex items-center">
                            <i class="fas fa-file-export mr-2"></i>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>

                        <!-- ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šãƒœã‚¿ãƒ³ -->
                        <button onclick="openGroupModal()" class="px-4 py-1.5 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 shadow-sm bg-white flex items-center">
                            <i class="fas fa-layer-group mr-2"></i>ã‚°ãƒ«ãƒ¼ãƒ—
                        </button>

                        <!-- è¡¨ç¤º/ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ -->
                        <div class="toggle-btn-group">
                            <button id="btn-view-mode" class="toggle-btn-item active" onclick="switchEditMode('view')">
                                <i class="fas fa-eye mr-1"></i>è¡¨ç¤º
                            </button>
                            <button id="btn-edit-mode" class="toggle-btn-item" onclick="switchEditMode('edit')">
                                <i class="fas fa-edit mr-1"></i>ç·¨é›†
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¤œç´¢ãƒ‘ãƒãƒ« -->
            <div id="search-panel" class="search-panel">
                <div class="flex flex-wrap items-center gap-3">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-slate-600 font-medium">å·¥ç¨‹:</label>
                        <select class="border border-slate-300 rounded px-2 py-1.5 text-sm bg-white">
                            <option value="">ã™ã¹ã¦</option>
                            <option value="1">è¦ä»¶å®šç¾©</option>
                            <option value="2">è¨­è¨ˆ</option>
                            <option value="3">PG</option>
                            <option value="4">ãƒ†ã‚¹ãƒˆ</option>
                            <option value="5">ãƒªãƒªãƒ¼ã‚¹</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-slate-600 font-medium">ã‚¿ã‚¹ã‚¯å:</label>
                        <input type="text" class="border border-slate-300 rounded px-2 py-1.5 text-sm bg-white w-40" placeholder="æ¤œç´¢...">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-slate-600 font-medium">æ‹…å½“è€…:</label>
                        <select class="border border-slate-300 rounded px-2 py-1.5 text-sm bg-white">
                            <option value="">ã™ã¹ã¦</option>
                            <option value="yamada">å±±ç”°</option>
                            <option value="sato">ä½è—¤</option>
                            <option value="suzuki">éˆ´æœ¨</option>
                            <option value="tanaka">ç”°ä¸­</option>
                            <option value="takahashi">é«˜æ©‹</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-slate-600 font-medium">é–‹å§‹æ—¥:</label>
                        <input type="date" class="border border-slate-300 rounded px-2 py-1.5 text-sm bg-white">
                        <span class="text-slate-400">ã€œ</span>
                        <input type="date" class="border border-slate-300 rounded px-2 py-1.5 text-sm bg-white">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-slate-600 font-medium">é€²æ—:</label>
                        <select class="border border-slate-300 rounded px-2 py-1.5 text-sm bg-white">
                            <option value="">ã™ã¹ã¦</option>
                            <option value="not-started">æœªç€æ‰‹(0%)</option>
                            <option value="in-progress">é€²è¡Œä¸­(1-99%)</option>
                            <option value="completed">å®Œäº†(100%)</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-slate-600 font-medium">é…å»¶:</label>
                        <select class="border border-slate-300 rounded px-2 py-1.5 text-sm bg-white">
                            <option value="">ã™ã¹ã¦</option>
                            <option value="delayed">é…å»¶ã‚ã‚Š</option>
                            <option value="ahead">å…ˆè¡Œ</option>
                            <option value="ontime">äºˆå®šé€šã‚Š</option>
                        </select>
                    </div>
                    <button class="px-4 py-1.5 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700">æ¤œç´¢</button>
                    <button class="px-4 py-1.5 border border-slate-300 rounded text-sm font-medium text-slate-600 hover:bg-slate-50">ã‚¯ãƒªã‚¢</button>
                </div>
            </div>

            <!-- é¸æŠæ™‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
            <div id="selection-action-bar" class="bg-blue-50 border-b border-blue-200 px-6 py-2 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-sm text-blue-700"><strong id="selected-count">0</strong>ä»¶é¸æŠä¸­</span>
                        <button onclick="openBulkEditModal()" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                            <i class="fas fa-edit mr-1"></i>ä¸€æ‹¬ç·¨é›†
                        </button>
                        <button onclick="bulkDelete()" class="px-3 py-1.5 border border-rose-300 text-rose-600 rounded-lg text-sm font-medium hover:bg-rose-50">
                            <i class="fas fa-trash mr-1"></i>ä¸€æ‹¬å‰Šé™¤
                        </button>
                    </div>
                    <button onclick="clearSelection()" class="text-sm text-slate-500 hover:text-slate-700">
                        <i class="fas fa-times mr-1"></i>é¸æŠè§£é™¤
                    </button>
                </div>
            </div>

            <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‘ãƒãƒ«ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
            <div id="paste-panel" class="bg-amber-50 border-b border-amber-200 px-6 py-3 hidden">
                <div class="flex items-center space-x-4">
                    <!-- ãƒšãƒ¼ã‚¹ãƒˆé ˜åŸŸ -->
                    <div class="paste-area-panel flex-1 p-4 bg-white text-center cursor-pointer" id="paste-area" onclick="document.getElementById('paste-input').focus()">
                        <i class="fas fa-paste text-2xl text-slate-400 mb-2"></i>
                        <p class="text-sm text-slate-600">ã“ã“ã«Excel/CSVãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆCtrl+Vï¼‰</p>
                        <p class="text-xs text-slate-400 mt-1">ã‚¿ãƒ–åŒºåˆ‡ã‚Šã¾ãŸã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã«å¯¾å¿œ</p>
                        <textarea id="paste-input" class="absolute opacity-0 w-0 h-0" onpaste="handlePaste(event)"></textarea>
                    </div>
                    <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
                    <div class="flex flex-col space-y-2 border-l border-amber-200 pl-4">
                        <label class="px-4 py-2 border border-emerald-400 bg-emerald-50 rounded-lg text-sm font-medium text-emerald-700 hover:bg-emerald-100 cursor-pointer text-center">
                            <i class="fas fa-file-import mr-2"></i>CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                            <input type="file" accept=".csv,.xlsx,.xls" class="hidden" onchange="handleFileImport(event)">
                        </label>
                        <a href="#" onclick="downloadTemplate(); return false;" class="px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 text-center">
                            <i class="fas fa-download mr-2"></i>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                        </a>
                    </div>
                    <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
                    <div class="flex flex-col space-y-2">
                        <button onclick="addNewRow()" class="px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 bg-white">
                            <i class="fas fa-plus mr-2"></i>è¡Œè¿½åŠ 
                        </button>
                        <button onclick="clearAllData()" class="px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 bg-white">
                            <i class="fas fa-eraser mr-2"></i>ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>
            </div>

            <!-- WBS/ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
            <main class="flex-1 overflow-hidden bg-white flex flex-col">
                <!-- ãƒ˜ãƒƒãƒ€ãƒ¼å›ºå®šéƒ¨åˆ† -->
                <div class="flex flex-shrink-0 border-b-2 border-slate-300">
                    <!-- å·¦å´ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                    <div class="flex-shrink-0 border-r-2 border-slate-300 bg-slate-100" style="width: 760px; min-width: 760px;">
                        <!-- æœˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ -->
                        <div class="flex month-header-row items-center border-b border-slate-200 bg-slate-200">
                            <div class="flex-1 px-3 text-sm font-bold text-slate-600 text-center">ã‚¿ã‚¹ã‚¯ä¸€è¦§</div>
                        </div>
                        <!-- æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ -->
                        <div class="flex weekday-header-row items-center border-b border-slate-200 bg-slate-100">
                            <div class="flex-1"></div>
                        </div>
                        <!-- ã‚«ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆäºˆå®šãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
                        <div id="header-plan" class="flex date-header-row items-center bg-white">
                            <div class="w-8 px-1 text-center border-r border-slate-200">
                                <input type="checkbox" id="select-all" class="rounded border-slate-300 cursor-pointer" title="å…¨é¸æŠ">
                            </div>
                            <div class="w-14 px-1 text-xs font-bold text-slate-700 text-center border-r border-slate-200 column-header" data-column="no" onclick="openColumnMenu(event, 'no')">
                                No<i class="fas fa-sort sort-icon"></i>
                            </div>
                            <div class="flex-1 px-2 text-xs font-bold text-slate-700 border-r border-slate-200 column-header" data-column="name" onclick="openColumnMenu(event, 'name')">
                                ã‚¿ã‚¹ã‚¯å<i class="fas fa-sort sort-icon"></i>
                            </div>
                            <div class="w-16 px-1 text-xs font-bold text-slate-700 text-center border-r border-slate-200 column-header" data-column="assignee" onclick="openColumnMenu(event, 'assignee')">
                                æ‹…å½“è€…<i class="fas fa-sort sort-icon"></i>
                            </div>
                            <div class="w-12 px-1 text-xs font-bold text-slate-700 text-center border-r border-slate-200 column-header" data-column="manDays" onclick="openColumnMenu(event, 'manDays')">
                                å·¥æ•°<i class="fas fa-sort sort-icon"></i>
                            </div>
                            <div class="w-16 px-1 text-xs font-bold text-slate-700 text-center border-r border-slate-200">åŸä¾¡</div>
                            <div class="w-16 px-1 text-xs font-bold text-slate-700 text-center border-r border-slate-200 column-header" data-column="planStart" onclick="openColumnMenu(event, 'planStart')">
                                é–‹å§‹æ—¥<i class="fas fa-sort sort-icon"></i>
                            </div>
                            <div class="w-16 px-1 text-xs font-bold text-slate-700 text-center border-r border-slate-200 column-header" data-column="planEnd" onclick="openColumnMenu(event, 'planEnd')">
                                çµ‚äº†æ—¥<i class="fas fa-sort sort-icon"></i>
                            </div>
                            <div class="w-12 px-1 text-xs font-bold text-slate-700 text-center border-r border-slate-200 column-header" data-column="progress" onclick="openColumnMenu(event, 'progress')">
                                é€²æ—<i class="fas fa-sort sort-icon"></i>
                            </div>
                            <div class="w-16 px-1 text-xs font-bold text-slate-700 text-center column-header" data-column="delay" onclick="openColumnMenu(event, 'delay')">
                                é…å»¶<i class="fas fa-sort sort-icon"></i>
                            </div>
                        </div>
                        <!-- ã‚«ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå®Ÿç¸¾ãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
                        <div id="header-actual" class="flex date-header-row items-center bg-white" style="display: none;">
                            <div class="w-8 px-1 text-center border-r border-slate-200">
                                <input type="checkbox" id="select-all-actual" class="rounded border-slate-300 cursor-pointer" title="å…¨é¸æŠ">
                            </div>
                            <div class="w-14 px-1 text-xs font-bold text-slate-700 text-center border-r border-slate-200 column-header" data-column="no" onclick="openColumnMenu(event, 'no')">
                                No<i class="fas fa-sort sort-icon"></i>
                            </div>
                            <div class="flex-1 px-2 text-xs font-bold text-slate-700 border-r border-slate-200 column-header" data-column="name" onclick="openColumnMenu(event, 'name')">
                                ã‚¿ã‚¹ã‚¯å<i class="fas fa-sort sort-icon"></i>
                            </div>
                            <div class="w-16 px-1 text-xs font-bold text-slate-700 text-center border-r border-slate-200 column-header" data-column="assignee" onclick="openColumnMenu(event, 'assignee')">
                                æ‹…å½“è€…<i class="fas fa-sort sort-icon"></i>
                            </div>
                            <div class="w-12 px-1 text-xs font-bold text-slate-700 text-center border-r border-slate-200">å®Ÿå·¥æ•°</div>
                            <div class="w-16 px-1 text-xs font-bold text-slate-700 text-center border-r border-slate-200">å®ŸåŸä¾¡</div>
                            <div class="w-16 px-1 text-xs font-bold text-slate-700 text-center border-r border-slate-200 column-header" data-column="actualStart" onclick="openColumnMenu(event, 'actualStart')">
                                å®Ÿé–‹å§‹<i class="fas fa-sort sort-icon"></i>
                            </div>
                            <div class="w-16 px-1 text-xs font-bold text-slate-700 text-center border-r border-slate-200 column-header" data-column="actualEnd" onclick="openColumnMenu(event, 'actualEnd')">
                                å®Ÿçµ‚äº†<i class="fas fa-sort sort-icon"></i>
                            </div>
                            <div class="w-12 px-1 text-xs font-bold text-slate-700 text-center border-r border-slate-200 column-header" data-column="progress" onclick="openColumnMenu(event, 'progress')">
                                é€²æ—<i class="fas fa-sort sort-icon"></i>
                            </div>
                            <div class="w-16 px-1 text-xs font-bold text-slate-700 text-center column-header" data-column="delay" onclick="openColumnMenu(event, 'delay')">
                                é…å»¶<i class="fas fa-sort sort-icon"></i>
                            </div>
                        </div>
                    </div>
                    <!-- å³å´ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰ -->
                    <div class="flex-1 overflow-hidden bg-white" id="gantt-header-container">
                        <div class="overflow-x-auto scroll-sync-header" id="gantt-header-scroll" style="overflow-y: hidden;">
                            <div style="min-width: max-content;">
                                <!-- æœˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
                                <div class="flex month-header-row" id="month-header"></div>
                                <!-- æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                                <div class="flex weekday-header-row bg-slate-50" id="weekday-header"></div>
                                <!-- æ—¥ä»˜è¡Œ -->
                                <div class="flex date-header-row bg-white" id="date-header"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æœ¬ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«éƒ¨åˆ† -->
                <div class="flex-1 flex overflow-hidden">
                    <!-- å·¦å´ï¼šã‚¿ã‚¹ã‚¯ä¸€è¦§ï¼ˆå›ºå®šï¼‰ -->
                    <div class="flex-shrink-0 border-r-2 border-slate-300 bg-white overflow-y-auto scroll-sync" style="width: 760px; min-width: 760px;" id="task-panel">
                            <!-- ã‚¿ã‚¹ã‚¯è¡Œ -->
                        <div id="task-list">
                            <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- å³å´ï¼šã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰ -->
                    <div class="flex-1 overflow-auto scroll-sync" id="gantt-scroll">
                        <div class="relative" id="gantt-body" style="min-width: max-content;">
                            <!-- JavaScriptã§ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </main>

            <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
            <footer class="bg-white border-t border-slate-200 px-6 py-3 flex-shrink-0" id="main-footer">
                <div class="flex items-center justify-between text-xs text-slate-500">
                    <div class="flex items-center space-x-4">
                        <span><i class="fas fa-tasks mr-1"></i>å…¨ã‚¿ã‚¹ã‚¯: <strong class="text-slate-700">21ä»¶</strong></span>
                        <span><i class="fas fa-check-circle mr-1 text-emerald-500"></i>å®Œäº†: <strong class="text-emerald-600">8ä»¶</strong></span>
                        <span><i class="fas fa-spinner mr-1 text-blue-500"></i>é€²è¡Œä¸­: <strong class="text-blue-600">5ä»¶</strong></span>
                        <span><i class="fas fa-clock mr-1 text-slate-400"></i>æœªç€æ‰‹: <strong class="text-slate-600">8ä»¶</strong></span>
                        <span class="border-l border-slate-300 pl-4"><i class="fas fa-exclamation-triangle mr-1 text-rose-500"></i>é…å»¶: <strong class="text-rose-600">3ä»¶</strong></span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <!-- ãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
                        <span id="view-mode-indicator" class="bg-slate-500 text-white px-3 py-1 rounded text-xs font-medium">
                            <i class="fas fa-eye mr-1"></i>è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
                        </span>
                        <span id="edit-mode-indicator" class="hidden bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium">
                            <i class="fas fa-edit mr-1"></i>ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                        </span>
                        <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒœã‚¿ãƒ³ç¾¤ -->
                        <button id="undo-btn" class="hidden px-3 py-1.5 border border-slate-300 rounded-lg text-xs font-medium text-slate-600 hover:bg-slate-100 transition-all" onclick="undoLastChange()">
                            <i class="fas fa-undo mr-1"></i>å…ƒã«æˆ»ã™
                        </button>
                        <button id="cancel-changes-btn" class="hidden px-3 py-1.5 border border-slate-300 rounded-lg text-xs font-medium text-slate-600 hover:bg-slate-100 transition-all" onclick="cancelAllChanges()">
                            <i class="fas fa-times mr-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button id="save-changes-btn" class="hidden px-4 py-1.5 bg-gradient-to-r from-rose-500 to-red-600 text-white rounded-lg text-xs font-semibold hover:from-rose-600 hover:to-red-700 shadow-lg transition-all" onclick="saveAllChanges()">
                            <i class="fas fa-save mr-1"></i>å¤‰æ›´ã‚’ç™»éŒ²
                        </button>
                        <span class="text-slate-400">Â© 2024 PM System</span>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- ã‚«ãƒ©ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆä¸¦ã³æ›¿ãˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ï¼‰ -->
    <div id="column-menu" class="column-menu">
        <div class="column-menu-item" onclick="sortColumn('asc')">
            <i class="fas fa-sort-amount-up"></i>æ˜‡é †ã§ä¸¦ã³æ›¿ãˆ
        </div>
        <div class="column-menu-item" onclick="sortColumn('desc')">
            <i class="fas fa-sort-amount-down"></i>é™é †ã§ä¸¦ã³æ›¿ãˆ
        </div>
        <div class="column-menu-separator"></div>
        <div class="column-menu-filter" id="column-filter-area">
            <label class="text-xs text-slate-600 font-medium mb-1 block">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
            <select id="column-filter-select" class="w-full" onchange="applyColumnFilter()">
                <option value="">ã™ã¹ã¦è¡¨ç¤º</option>
            </select>
        </div>
        <div class="column-menu-separator"></div>
        <div class="column-menu-item" onclick="clearColumnFilter()">
            <i class="fas fa-times"></i>ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤
        </div>
    </div>

    <!-- å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="context-menu" class="context-menu">
        <div class="context-menu-item" onclick="openTaskModal('above')">
            <i class="fas fa-arrow-up"></i>ã“ã®ä¸Šã«è¿½åŠ 
        </div>
        <div class="context-menu-item" onclick="openTaskModal('below')">
            <i class="fas fa-arrow-down"></i>ã“ã®ä¸‹ã«è¿½åŠ 
        </div>
        <div class="context-menu-item" onclick="openTaskModal('child')">
            <i class="fas fa-level-down-alt"></i>å­ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="openTaskModal('edit')">
            <i class="fas fa-edit"></i>ç·¨é›†
        </div>
        <div class="context-menu-item" onclick="duplicateTask()">
            <i class="fas fa-copy"></i>è¤‡è£½
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="deleteTask()" style="color: #dc2626;">
            <i class="fas fa-trash" style="color: #dc2626;"></i>å‰Šé™¤
        </div>
    </div>

    <!-- ä¸€æ‹¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="bulk-edit-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeBulkEditModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-white"><i class="fas fa-edit mr-2"></i>ä¸€æ‹¬ç·¨é›†</h3>
                    <button onclick="closeBulkEditModal()" class="text-white/80 hover:text-white transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <p class="text-sm text-slate-600 mb-4"><strong id="bulk-edit-count">0</strong>ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’ä¸€æ‹¬ç·¨é›†ã—ã¾ã™ã€‚å¤‰æ›´ã—ãªã„é …ç›®ã¯ç©ºæ¬„ã®ã¾ã¾ã«ã—ã¦ãã ã•ã„ã€‚</p>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">æ‹…å½“è€…</label>
                        <select id="bulk-assignee" class="w-full border border-slate-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="">-- å¤‰æ›´ã—ãªã„ --</option>
                            <option value="å±±ç”°">å±±ç”°</option>
                            <option value="ä½è—¤">ä½è—¤</option>
                            <option value="éˆ´æœ¨">éˆ´æœ¨</option>
                            <option value="ç”°ä¸­">ç”°ä¸­</option>
                            <option value="é«˜æ©‹">é«˜æ©‹</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">é€²æ—</label>
                        <select id="bulk-progress" class="w-full border border-slate-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="">-- å¤‰æ›´ã—ãªã„ --</option>
                            <option value="0">0%</option>
                            <option value="25">25%</option>
                            <option value="50">50%</option>
                            <option value="75">75%</option>
                            <option value="100">100%</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">å·¥ç¨‹</label>
                        <select id="bulk-process" class="w-full border border-slate-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="">-- å¤‰æ›´ã—ãªã„ --</option>
                            <option value="1">è¦ä»¶å®šç¾©</option>
                            <option value="2">è¨­è¨ˆ</option>
                            <option value="3">PG</option>
                            <option value="4">ãƒ†ã‚¹ãƒˆ</option>
                            <option value="5">ãƒªãƒªãƒ¼ã‚¹</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="bg-slate-50 px-6 py-4 border-t border-slate-200 flex items-center justify-end space-x-3">
                <button onclick="closeBulkEditModal()" class="px-5 py-2.5 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100 transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="applyBulkEdit()" class="px-5 py-2.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg text-sm font-semibold hover:from-indigo-700 hover:to-purple-700 shadow-lg transition-all"><i class="fas fa-check mr-2"></i>é©ç”¨</button>
            </div>
        </div>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯ç·¨é›†/è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="task-modal" class="task-modal-fullscreen">
        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“ï¼ˆå…¨ç”»é¢ï¼‰ -->
        <div class="task-modal-content">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <h3 id="modal-title" class="text-lg font-bold text-white">ã‚¿ã‚¹ã‚¯ç·¨é›†</h3>
                        <span id="modal-task-id" class="ml-3 px-2 py-0.5 bg-white/20 rounded text-sm text-white/90"></span>
                    </div>
                    <button onclick="closeTaskModal()" class="text-white/80 hover:text-white transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆ2ã‚«ãƒ©ãƒ ï¼‰ -->
            <div class="flex-1 flex overflow-hidden">
                <!-- å·¦å´ï¼šã‚¿ã‚¹ã‚¯åŸºæœ¬æƒ…å ± -->
                <div class="w-1/2 border-r border-slate-200 overflow-y-auto bg-white">
                    <div class="p-6">
                        <h4 class="text-sm font-bold text-slate-800 mb-4 flex items-center">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>ã‚¿ã‚¹ã‚¯åŸºæœ¬æƒ…å ±
                        </h4>
                        <form id="task-form">
                            <!-- å·¥ç¨‹é¸æŠ -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5">
                                    å·¥ç¨‹ <span class="text-rose-500">*</span>
                                </label>
                                <select id="modal-process" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white" required onchange="onProcessChange()">
                                    <option value="">å·¥ç¨‹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="1">1. è¦ä»¶å®šç¾©</option>
                                    <option value="2">2. è¨­è¨ˆ</option>
                                    <option value="3">3. PG</option>
                                    <option value="4">4. ãƒ†ã‚¹ãƒˆ</option>
                                    <option value="5">5. ãƒªãƒªãƒ¼ã‚¹</option>
                                </select>
                            </div>

                            <!-- ç”»é¢é¸æŠ -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5">
                                    ç”»é¢/æ©Ÿèƒ½
                                </label>
                                <select id="modal-screen" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                    <option value="">ç”»é¢/æ©Ÿèƒ½ã‚’é¸æŠï¼ˆä»»æ„ï¼‰</option>
                                    <option value="login">ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢</option>
                                    <option value="dashboard">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢</option>
                                    <option value="list">ä¸€è¦§ç”»é¢</option>
                                    <option value="detail">è©³ç´°ç”»é¢</option>
                                    <option value="form">ç™»éŒ²/ç·¨é›†ç”»é¢</option>
                                    <option value="report">å¸³ç¥¨å‡ºåŠ›</option>
                                    <option value="batch">ãƒãƒƒãƒå‡¦ç†</option>
                                    <option value="api">API</option>
                                </select>
                            </div>

                            <!-- ã‚¿ã‚¹ã‚¯å -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5">
                                    ã‚¿ã‚¹ã‚¯å <span class="text-rose-500">*</span>
                                </label>
                                <input type="text" id="modal-task-name" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›" required>
                            </div>

                            <!-- æ‹…å½“è€… -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5">
                                    æ‹…å½“è€…
                                </label>
                                <select id="modal-assignee" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                    <option value="">æ‹…å½“è€…ã‚’é¸æŠ</option>
                                    <option value="yamada">å±±ç”°</option>
                                    <option value="sato">ä½è—¤</option>
                                    <option value="suzuki">éˆ´æœ¨</option>
                                    <option value="tanaka">ç”°ä¸­</option>
                                    <option value="takahashi">é«˜æ©‹</option>
                                </select>
                            </div>

                            <!-- äºˆå®šï¼šæ—¥ä»˜ã¨å·¥æ•° -->
                            <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                                <p class="text-xs font-bold text-blue-700 mb-2"><i class="fas fa-calendar mr-1"></i>äºˆå®š</p>
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">é–‹å§‹æ—¥</label>
                                        <input type="date" id="modal-start-date" class="w-full border border-slate-300 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">çµ‚äº†æ—¥</label>
                                        <input type="date" id="modal-end-date" class="w-full border border-slate-300 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">å·¥æ•°ï¼ˆæ—¥ï¼‰</label>
                                        <input type="number" id="modal-man-days" class="w-full border border-slate-300 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0" min="0" step="0.5">
                                    </div>
                                </div>
                            </div>

                            <!-- å®Ÿç¸¾ã‚µãƒãƒªãƒ¼ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰ -->
                            <div id="modal-actual-section" class="mb-4 p-3 bg-emerald-50 rounded-lg">
                                <p class="text-xs font-bold text-emerald-700 mb-2"><i class="fas fa-check-circle mr-1"></i>å®Ÿç¸¾ï¼ˆå±¥æ­´ã‹ã‚‰è‡ªå‹•è¨ˆç®—ï¼‰</p>
                                <div class="grid grid-cols-4 gap-3 text-center">
                                    <div>
                                        <p class="text-xs text-slate-500">å®Ÿé–‹å§‹æ—¥</p>
                                        <p id="modal-actual-start" class="text-sm font-semibold text-slate-700">-</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500">å®Ÿçµ‚äº†æ—¥</p>
                                        <p id="modal-actual-end" class="text-sm font-semibold text-slate-700">-</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500">å®Ÿå·¥æ•°</p>
                                        <p id="modal-actual-days" class="text-sm font-semibold text-slate-700">-</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500">é€²æ—</p>
                                        <p id="modal-actual-progress" class="text-sm font-semibold text-emerald-600">0%</p>
                                    </div>
                                </div>
                            </div>

                            <!-- é€²æ—ç‡ï¼ˆéè¡¨ç¤ºã€å±¥æ­´ã‹ã‚‰è‡ªå‹•è¨ˆç®—ç”¨ï¼‰ -->
                            <input type="hidden" id="modal-progress" value="0">
                            <input type="hidden" id="modal-progress-num" value="0">

                            <!-- åŸä¾¡ -->
                            <div class="mb-4 p-3 bg-amber-50 rounded-lg">
                                <p class="text-xs font-bold text-amber-700 mb-2"><i class="fas fa-yen-sign mr-1"></i>åŸä¾¡</p>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">äºˆå®šåŸä¾¡ï¼ˆå††ï¼‰</label>
                                        <input type="number" id="modal-cost" class="w-full border border-slate-300 rounded px-2 py-1.5 text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500" placeholder="0" min="0" step="1000" oninput="updateCostActual()">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">å®Ÿç¸¾åŸä¾¡ï¼ˆé€²æ—æ›ç®—ï¼‰</label>
                                        <p id="modal-cost-actual" class="text-sm font-semibold text-amber-700 py-1.5">Â¥0</p>
                                    </div>
                                </div>
                            </div>

                            <!-- PGãƒ»ãƒ†ã‚¹ãƒˆåŒæ™‚ä½œæˆï¼ˆæ–°è¦è¿½åŠ æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
                            <div id="multi-create-section" class="mb-4 p-3 bg-indigo-50 rounded-lg border border-indigo-200 hidden">
                                <p class="text-xs font-bold text-indigo-700 mb-3"><i class="fas fa-layer-group mr-1"></i>åŒæ™‚ä½œæˆã‚ªãƒ—ã‚·ãƒ§ãƒ³</p>
                                <p class="text-xs text-slate-600 mb-3">åŒã˜ç”»é¢/æ©Ÿèƒ½ã®ã‚¿ã‚¹ã‚¯ã‚’PGãƒ»ãƒ†ã‚¹ãƒˆå·¥ç¨‹ã«ã‚‚åŒæ™‚ã«ä½œæˆã—ã¾ã™</p>

                                <!-- PGåŒæ™‚ä½œæˆ -->
                                <div class="mb-3">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="create-pg-task" class="mr-2 w-4 h-4 text-blue-600 rounded focus:ring-blue-500" onchange="toggleMultiCreateDetail('pg')">
                                        <span class="text-sm font-medium text-slate-700"><i class="fas fa-code mr-1 text-blue-500"></i>PGï¼ˆå®Ÿè£…ï¼‰ã‚‚åŒæ™‚ä½œæˆ</span>
                                    </label>
                                    <div id="pg-detail" class="mt-2 ml-6 p-2 bg-white rounded border border-slate-200 hidden">
                                        <div class="grid grid-cols-3 gap-2 mb-2">
                                            <div>
                                                <label class="block text-xs text-slate-500 mb-1">æ‹…å½“è€…</label>
                                                <select id="pg-assignee" class="w-full border border-slate-300 rounded px-2 py-1 text-xs">
                                                    <option value="">æœªå®š</option>
                                                    <option value="yamada">å±±ç”°</option>
                                                    <option value="sato">ä½è—¤</option>
                                                    <option value="suzuki">éˆ´æœ¨</option>
                                                    <option value="tanaka">ç”°ä¸­</option>
                                                    <option value="takahashi">é«˜æ©‹</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-xs text-slate-500 mb-1">å·¥æ•°ï¼ˆæ—¥ï¼‰</label>
                                                <input type="number" id="pg-man-days" class="w-full border border-slate-300 rounded px-2 py-1 text-xs" placeholder="0" min="0" step="0.5">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-slate-500 mb-1">åŸä¾¡ï¼ˆå††ï¼‰</label>
                                                <input type="number" id="pg-cost" class="w-full border border-slate-300 rounded px-2 py-1 text-xs" placeholder="0" min="0" step="1000">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="block text-xs text-slate-500 mb-1">é–‹å§‹æ—¥</label>
                                                <input type="date" id="pg-start-date" class="w-full border border-slate-300 rounded px-2 py-1 text-xs">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-slate-500 mb-1">çµ‚äº†æ—¥</label>
                                                <input type="date" id="pg-end-date" class="w-full border border-slate-300 rounded px-2 py-1 text-xs">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ãƒ†ã‚¹ãƒˆåŒæ™‚ä½œæˆ -->
                                <div>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="create-test-task" class="mr-2 w-4 h-4 text-amber-600 rounded focus:ring-amber-500" onchange="toggleMultiCreateDetail('test')">
                                        <span class="text-sm font-medium text-slate-700"><i class="fas fa-vial mr-1 text-amber-500"></i>ãƒ†ã‚¹ãƒˆã‚‚åŒæ™‚ä½œæˆ</span>
                                    </label>
                                    <div id="test-detail" class="mt-2 ml-6 p-2 bg-white rounded border border-slate-200 hidden">
                                        <div class="grid grid-cols-3 gap-2 mb-2">
                                            <div>
                                                <label class="block text-xs text-slate-500 mb-1">æ‹…å½“è€…</label>
                                                <select id="test-assignee" class="w-full border border-slate-300 rounded px-2 py-1 text-xs">
                                                    <option value="">æœªå®š</option>
                                                    <option value="yamada">å±±ç”°</option>
                                                    <option value="sato">ä½è—¤</option>
                                                    <option value="suzuki">éˆ´æœ¨</option>
                                                    <option value="tanaka">ç”°ä¸­</option>
                                                    <option value="takahashi">é«˜æ©‹</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-xs text-slate-500 mb-1">å·¥æ•°ï¼ˆæ—¥ï¼‰</label>
                                                <input type="number" id="test-man-days" class="w-full border border-slate-300 rounded px-2 py-1 text-xs" placeholder="0" min="0" step="0.5">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-slate-500 mb-1">åŸä¾¡ï¼ˆå††ï¼‰</label>
                                                <input type="number" id="test-cost" class="w-full border border-slate-300 rounded px-2 py-1 text-xs" placeholder="0" min="0" step="1000">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="block text-xs text-slate-500 mb-1">é–‹å§‹æ—¥</label>
                                                <input type="date" id="test-start-date" class="w-full border border-slate-300 rounded px-2 py-1 text-xs">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-slate-500 mb-1">çµ‚äº†æ—¥</label>
                                                <input type="date" id="test-end-date" class="w-full border border-slate-300 rounded px-2 py-1 text-xs">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- å‚™è€ƒ -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-slate-700 mb-1.5">
                                    å‚™è€ƒ
                                </label>
                                <textarea id="modal-note" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" rows="2" placeholder="å‚™è€ƒã‚’å…¥åŠ›ï¼ˆä»»æ„ï¼‰"></textarea>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- å³å´ï¼šã‚¿ã‚¹ã‚¯å±¥æ­´ -->
                <div class="w-1/2 overflow-hidden bg-slate-50 flex flex-col">
                    <!-- å±¥æ­´ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                    <div class="p-4 border-b border-slate-200 bg-white flex items-center justify-between flex-shrink-0">
                        <h4 class="text-sm font-bold text-slate-800 flex items-center">
                            <i class="fas fa-history mr-2 text-purple-500"></i>ä½œæ¥­å±¥æ­´
                        </h4>
                        <button id="history-add-btn" onclick="openHistoryEntryForm()" class="px-3 py-1.5 bg-purple-600 text-white rounded-lg text-xs font-medium hover:bg-purple-700 transition-colors">
                            <i class="fas fa-plus mr-1"></i>å±¥æ­´è¿½åŠ 
                        </button>
                    </div>

                    <!-- å±¥æ­´å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆéè¡¨ç¤ºã€è¿½åŠ æ™‚ã«è¡¨ç¤ºï¼‰ -->
                    <div id="history-entry-form" class="p-4 border-b border-slate-200 bg-purple-50 hidden flex-shrink-0">
                        <div class="flex items-center justify-between mb-3">
                            <p class="text-sm font-bold text-purple-700"><i class="fas fa-edit mr-1"></i>å±¥æ­´å…¥åŠ›</p>
                            <button onclick="closeHistoryEntryForm()" class="text-slate-400 hover:text-slate-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-xs text-slate-600 mb-1">ä½œæ¥­æ—¥ <span class="text-rose-500">*</span></label>
                                <input type="date" id="history-date" class="w-full border border-slate-300 rounded px-2 py-1.5 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-600 mb-1">ä½œæ¥­æ™‚é–“ï¼ˆæ™‚é–“ï¼‰</label>
                                <input type="number" id="history-hours" class="w-full border border-slate-300 rounded px-2 py-1.5 text-sm" placeholder="0" min="0" step="0.5">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="block text-xs text-slate-600 mb-1">é€²æ—ç‡ï¼ˆ%ï¼‰</label>
                            <div class="flex items-center space-x-2">
                                <input type="range" id="history-progress" class="flex-1 h-2 bg-slate-200 rounded-lg" min="0" max="100" value="0" oninput="syncHistoryProgress(this.value, 'range')">
                                <input type="number" id="history-progress-num" class="w-16 border border-slate-300 rounded px-2 py-1 text-sm text-center" min="0" max="100" value="0" oninput="syncHistoryProgress(this.value, 'number')">
                                <span class="text-xs text-slate-500">%</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="block text-xs text-slate-600 mb-1">å†…å®¹ãƒ»å‚™è€ƒ</label>
                            <textarea id="history-content" class="w-full border border-slate-300 rounded px-2 py-1.5 text-sm resize-none" rows="3" placeholder="ä½œæ¥­å†…å®¹ã€å•é¡Œç‚¹ã€æ³¨æ„äº‹é …ã€å ±å‘Šäº‹é …ãªã©"></textarea>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button onclick="closeHistoryEntryForm()" class="px-3 py-1.5 border border-slate-300 rounded text-xs text-slate-600 hover:bg-slate-100">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="saveHistoryEntry()" class="px-3 py-1.5 bg-purple-600 text-white rounded text-xs font-medium hover:bg-purple-700">
                                <i class="fas fa-save mr-1"></i>ä¿å­˜
                            </button>
                        </div>
                    </div>

                    <!-- å±¥æ­´ä¸€è¦§ -->
                    <div class="flex-1 overflow-y-auto p-4">
                        <div id="history-list" class="space-y-3">
                            <!-- å±¥æ­´ãŒJavaScriptã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
            <div class="bg-white px-6 py-4 border-t border-slate-200 flex items-center justify-between flex-shrink-0">
                <div class="text-sm text-slate-500">
                    <span id="modal-created-info"></span>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="modal-cancel-btn" onclick="closeTaskModal()" class="px-5 py-2.5 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100 transition-colors">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button id="modal-save-btn" onclick="saveTask()" class="px-5 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg text-sm font-semibold hover:from-blue-700 hover:to-indigo-700 shadow-lg transition-all">
                        <i class="fas fa-save mr-2"></i>ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="group-modal" class="group-modal-fullscreen">
        <div class="group-modal-content">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-white"><i class="fas fa-layer-group mr-2"></i>ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®š</h3>
                    <div class="flex items-center space-x-3">
                        <button onclick="addNewGroup()" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-plus mr-2"></i>æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—
                        </button>
                        <button onclick="closeGroupModal()" class="text-white/80 hover:text-white transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="flex-1 overflow-y-auto p-6 bg-slate-100">
                <div id="group-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- ã‚°ãƒ«ãƒ¼ãƒ—ãŒJavaScriptã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                </div>
            </div>
            <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
            <div class="bg-white px-6 py-4 border-t border-slate-200 flex items-center justify-between flex-shrink-0">
                <div class="text-sm text-slate-500">
                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                    ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ã‚¿ã‚¹ã‚¯ã¯é †ç•ªã«é€£å‹•ã—ã¦æ—¥ä»˜ãŒè‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™
                </div>
                <button onclick="closeGroupModal()" class="px-5 py-2.5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg text-sm font-semibold hover:from-purple-700 hover:to-indigo-700 shadow-lg transition-all">
                    <i class="fas fa-check mr-2"></i>å®Œäº†
                </button>
            </div>
        </div>
    </div>

    <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="import-modal" class="import-modal">
        <div class="import-modal-overlay" onclick="closeImportModal()"></div>
        <div class="import-modal-content">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="bg-gradient-to-r from-emerald-600 to-teal-600 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-white"><i class="fas fa-file-import mr-2"></i>ã‚¿ã‚¹ã‚¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
                    <button onclick="closeImportModal()" class="text-white/80 hover:text-white transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="p-6">
                <!-- ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ -->
                <div id="drop-zone" class="drop-zone mb-4">
                    <div class="drop-zone-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <p class="text-slate-600 font-medium mb-2">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
                    <p class="text-slate-400 text-sm mb-4">ã¾ãŸã¯</p>
                    <label class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium cursor-pointer hover:bg-blue-700 transition-colors">
                        <i class="fas fa-folder-open mr-2"></i>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                        <input type="file" id="file-input" class="hidden" accept=".csv,.xlsx,.xls" onchange="handleFileSelect(event)">
                    </label>
                    <p class="text-slate-400 text-xs mt-4">å¯¾å¿œå½¢å¼: CSV, Excel (.xlsx, .xls)</p>
                </div>

                <!-- ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã®è²¼ã‚Šä»˜ã‘ -->
                <div class="border-t border-slate-200 pt-4 mt-4">
                    <p class="text-sm font-semibold text-slate-700 mb-2"><i class="fas fa-clipboard mr-2 text-blue-500"></i>ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘</p>
                    <textarea id="paste-area" class="w-full border border-slate-300 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" rows="4" placeholder="Excelã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ Ctrl+V ã§è²¼ã‚Šä»˜ã‘..."></textarea>
                    <p class="text-xs text-slate-400 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        åˆ—é †: ä½œæ¥­é †, ã‚¿ã‚¹ã‚¯å, æ‹…å½“è€…, å·¥æ•°(æ—¥), åŸä¾¡(ä¸‡å††), é–‹å§‹æ—¥, çµ‚äº†æ—¥
                    </p>
                </div>

                <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                <div id="import-preview" class="border-t border-slate-200 pt-4 mt-4 hidden">
                    <p class="text-sm font-semibold text-slate-700 mb-2"><i class="fas fa-eye mr-2 text-emerald-500"></i>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ<span id="preview-count">0</span>ä»¶ï¼‰</p>
                    <div class="max-h-40 overflow-auto border border-slate-200 rounded-lg">
                        <table class="w-full text-xs">
                            <thead class="bg-slate-100 sticky top-0">
                                <tr>
                                    <th class="px-2 py-1 text-left">é †</th>
                                    <th class="px-2 py-1 text-left">ã‚¿ã‚¹ã‚¯å</th>
                                    <th class="px-2 py-1 text-left">æ‹…å½“è€…</th>
                                    <th class="px-2 py-1 text-right">å·¥æ•°</th>
                                    <th class="px-2 py-1 text-right">åŸä¾¡</th>
                                    <th class="px-2 py-1 text-left">é–‹å§‹æ—¥</th>
                                    <th class="px-2 py-1 text-left">çµ‚äº†æ—¥</th>
                                </tr>
                            </thead>
                            <tbody id="preview-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
            <div class="bg-slate-50 px-6 py-4 border-t border-slate-200 flex items-center justify-end space-x-3">
                <button onclick="closeImportModal()" class="px-5 py-2.5 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100 transition-colors">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button id="import-btn" onclick="executeImport()" class="px-5 py-2.5 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-lg text-sm font-semibold hover:from-emerald-700 hover:to-teal-700 shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-check mr-2"></i>ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
                </button>
            </div>
        </div>
    </div>

    <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="export-modal" class="import-modal">
        <div class="import-modal-overlay" onclick="closeExportModal()"></div>
        <div class="import-modal-content">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-white"><i class="fas fa-file-export mr-2"></i>ã‚¿ã‚¹ã‚¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
                    <button onclick="closeExportModal()" class="text-white/80 hover:text-white transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="p-6">
                <!-- å‡ºåŠ›å½¢å¼é¸æŠ -->
                <div class="mb-6">
                    <p class="text-sm font-semibold text-slate-700 mb-3"><i class="fas fa-file-alt mr-2 text-blue-500"></i>å‡ºåŠ›å½¢å¼</p>
                    <div class="grid grid-cols-3 gap-3">
                        <label class="export-format-option">
                            <input type="radio" name="export-format" value="csv" checked class="hidden">
                            <div class="export-format-card">
                                <i class="fas fa-file-csv text-2xl text-emerald-500 mb-2"></i>
                                <span class="text-sm font-medium">CSV</span>
                            </div>
                        </label>
                        <label class="export-format-option">
                            <input type="radio" name="export-format" value="excel" class="hidden">
                            <div class="export-format-card">
                                <i class="fas fa-file-excel text-2xl text-green-600 mb-2"></i>
                                <span class="text-sm font-medium">Excel</span>
                            </div>
                        </label>
                        <label class="export-format-option">
                            <input type="radio" name="export-format" value="json" class="hidden">
                            <div class="export-format-card">
                                <i class="fas fa-file-code text-2xl text-amber-500 mb-2"></i>
                                <span class="text-sm font-medium">JSON</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- å‡ºåŠ›é …ç›®é¸æŠ -->
                <div class="mb-6">
                    <p class="text-sm font-semibold text-slate-700 mb-3"><i class="fas fa-list-check mr-2 text-blue-500"></i>å‡ºåŠ›é …ç›®</p>
                    <!-- åŸºæœ¬é …ç›® -->
                    <p class="text-xs text-slate-500 mb-2">åŸºæœ¬æƒ…å ±</p>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <label class="flex items-center p-2 bg-slate-50 rounded hover:bg-slate-100 cursor-pointer">
                            <input type="checkbox" class="export-field mr-2" value="no" checked>
                            <span class="text-sm text-slate-700">No</span>
                        </label>
                        <label class="flex items-center p-2 bg-slate-50 rounded hover:bg-slate-100 cursor-pointer">
                            <input type="checkbox" class="export-field mr-2" value="name" checked>
                            <span class="text-sm text-slate-700">ã‚¿ã‚¹ã‚¯å</span>
                        </label>
                        <label class="flex items-center p-2 bg-slate-50 rounded hover:bg-slate-100 cursor-pointer">
                            <input type="checkbox" class="export-field mr-2" value="assignee" checked>
                            <span class="text-sm text-slate-700">æ‹…å½“è€…</span>
                        </label>
                        <label class="flex items-center p-2 bg-slate-50 rounded hover:bg-slate-100 cursor-pointer">
                            <input type="checkbox" class="export-field mr-2" value="group">
                            <span class="text-sm text-slate-700">ã‚°ãƒ«ãƒ¼ãƒ—</span>
                        </label>
                    </div>
                    <!-- äºˆå®š -->
                    <p class="text-xs text-blue-600 mb-2"><i class="fas fa-calendar mr-1"></i>äºˆå®š</p>
                    <div class="grid grid-cols-4 gap-2 mb-3">
                        <label class="flex items-center p-2 bg-blue-50 rounded hover:bg-blue-100 cursor-pointer">
                            <input type="checkbox" class="export-field mr-2" value="planStart" checked>
                            <span class="text-sm text-slate-700">é–‹å§‹æ—¥</span>
                        </label>
                        <label class="flex items-center p-2 bg-blue-50 rounded hover:bg-blue-100 cursor-pointer">
                            <input type="checkbox" class="export-field mr-2" value="planEnd" checked>
                            <span class="text-sm text-slate-700">çµ‚äº†æ—¥</span>
                        </label>
                        <label class="flex items-center p-2 bg-blue-50 rounded hover:bg-blue-100 cursor-pointer">
                            <input type="checkbox" class="export-field mr-2" value="manDays" checked>
                            <span class="text-sm text-slate-700">å·¥æ•°</span>
                        </label>
                        <label class="flex items-center p-2 bg-blue-50 rounded hover:bg-blue-100 cursor-pointer">
                            <input type="checkbox" class="export-field mr-2" value="cost" checked>
                            <span class="text-sm text-slate-700">åŸä¾¡</span>
                        </label>
                    </div>
                    <!-- å®Ÿç¸¾ -->
                    <p class="text-xs text-emerald-600 mb-2"><i class="fas fa-check-circle mr-1"></i>å®Ÿç¸¾</p>
                    <div class="grid grid-cols-4 gap-2 mb-3">
                        <label class="flex items-center p-2 bg-emerald-50 rounded hover:bg-emerald-100 cursor-pointer">
                            <input type="checkbox" class="export-field mr-2" value="actualStart" checked>
                            <span class="text-sm text-slate-700">é–‹å§‹æ—¥</span>
                        </label>
                        <label class="flex items-center p-2 bg-emerald-50 rounded hover:bg-emerald-100 cursor-pointer">
                            <input type="checkbox" class="export-field mr-2" value="actualEnd" checked>
                            <span class="text-sm text-slate-700">çµ‚äº†æ—¥</span>
                        </label>
                        <label class="flex items-center p-2 bg-emerald-50 rounded hover:bg-emerald-100 cursor-pointer">
                            <input type="checkbox" class="export-field mr-2" value="actualManDays" checked>
                            <span class="text-sm text-slate-700">å·¥æ•°</span>
                        </label>
                        <label class="flex items-center p-2 bg-emerald-50 rounded hover:bg-emerald-100 cursor-pointer">
                            <input type="checkbox" class="export-field mr-2" value="actualCost" checked>
                            <span class="text-sm text-slate-700">åŸä¾¡</span>
                        </label>
                    </div>
                    <!-- ãã®ä»– -->
                    <p class="text-xs text-slate-500 mb-2">ãã®ä»–</p>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="flex items-center p-2 bg-slate-50 rounded hover:bg-slate-100 cursor-pointer">
                            <input type="checkbox" class="export-field mr-2" value="progress" checked>
                            <span class="text-sm text-slate-700">é€²æ—ç‡</span>
                        </label>
                        <label class="flex items-center p-2 bg-slate-50 rounded hover:bg-slate-100 cursor-pointer">
                            <input type="checkbox" class="export-field mr-2" value="delay">
                            <span class="text-sm text-slate-700">é…å»¶çŠ¶æ³</span>
                        </label>
                    </div>
                </div>

                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                <div class="border-t border-slate-200 pt-4">
                    <p class="text-sm font-semibold text-slate-700 mb-2"><i class="fas fa-eye mr-2 text-blue-500"></i>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ<span id="export-count">0</span>ä»¶ï¼‰</p>
                    <div class="max-h-32 overflow-auto border border-slate-200 rounded-lg bg-slate-50">
                        <pre id="export-preview" class="p-3 text-xs text-slate-600 whitespace-pre-wrap"></pre>
                    </div>
                </div>
            </div>
            <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
            <div class="bg-slate-50 px-6 py-4 border-t border-slate-200 flex items-center justify-end space-x-3">
                <button onclick="closeExportModal()" class="px-5 py-2.5 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100 transition-colors">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button onclick="executeExport()" class="px-5 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg text-sm font-semibold hover:from-blue-700 hover:to-indigo-700 shadow-lg transition-all">
                    <i class="fas fa-download mr-2"></i>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
        </div>
    </div>

    <script>
        // å®šæ•°
        var CELL_WIDTH = 40;
        var WEEKDAY_NAMES = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        var TODAY = new Date(2024, 3, 10); // 2024å¹´4æœˆ10æ—¥ï¼ˆãƒ¢ãƒƒã‚¯ç”¨ï¼‰

        // æ‹…å½“è€…ã‚«ãƒ©ãƒ¼è¨­å®š
        var ASSIGNEE_COLORS = {
            'å±±ç”°': 'from-blue-400 to-indigo-500',
            'ä½è—¤': 'from-purple-400 to-pink-500',
            'éˆ´æœ¨': 'from-cyan-400 to-blue-500',
            'ç”°ä¸­': 'from-orange-400 to-red-500',
            'é«˜æ©‹': 'from-teal-400 to-cyan-500'
        };

        // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆå‹•çš„ç”Ÿæˆç”¨ï¼‰- no: è¡¨ç¤ºç•ªå·, group: ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆåŒã˜ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§é †ç•ªãŒé€£å‹•ï¼‰
        var taskData = [
            { id: '1', name: 'è¦ä»¶å®šç¾©', type: 'parent', no: '1', group: '', assignee: '-', manDays: 5, cost: 250, planStart: '01/15', planEnd: '02/15', actualManDays: 5, actualCost: 245, actualStart: '01/15', actualEnd: '02/14', progress: 100, delay: { type: 'ahead', text: '1æ—¥å…ˆè¡Œ' } },
            { id: '1-1', name: 'ãƒ’ã‚¢ãƒªãƒ³ã‚°', type: 'child', no: '1-1', group: 'A', assignee: 'å±±ç”°', manDays: 2, cost: 100, planStart: '01/15', planEnd: '02/15', actualManDays: 2, actualCost: 100, actualStart: '01/15', actualEnd: '01/24', progress: 100, delay: { type: 'ahead', text: '1æ—¥å…ˆè¡Œ' } },
            { id: '1-2', name: 'è¦ä»¶æ›¸ä½œæˆ', type: 'child', no: '1-2', group: 'A', assignee: 'å±±ç”°', manDays: 3, cost: 150, planStart: '01/26', planEnd: '02/15', actualManDays: 3, actualCost: 145, actualStart: '01/25', actualEnd: '02/14', progress: 100, delay: { type: 'ahead', text: '1æ—¥å…ˆè¡Œ' } },
            { id: '2', name: 'è¨­è¨ˆ', type: 'parent', no: '2', group: '', assignee: '-', manDays: 10, cost: 500, planStart: '02/16', planEnd: '03/31', actualManDays: 11, actualCost: 520, actualStart: '02/15', actualEnd: '03/31', progress: 100, delay: { type: 'ontime', text: 'äºˆå®šé€šã‚Š' } },
            { id: '2-1', name: 'ç”»é¢è¨­è¨ˆ', type: 'child', no: '2-1', group: 'B', assignee: 'ä½è—¤', manDays: 4, cost: 200, planStart: '02/16', planEnd: '03/31', actualManDays: 5, actualCost: 230, actualStart: '02/15', actualEnd: '03/12', progress: 100, delay: { type: 'late', text: '2æ—¥é…ã‚Œ' } },
            { id: '2-2', name: 'DBè¨­è¨ˆ', type: 'child', no: '2-2', group: 'B', assignee: 'éˆ´æœ¨', manDays: 3, cost: 150, planStart: '03/01', planEnd: '03/31', actualManDays: 3, actualCost: 150, actualStart: '03/01', actualEnd: '03/20', progress: 100, delay: { type: 'ontime', text: 'äºˆå®šé€šã‚Š' } },
            { id: '2-3', name: 'APIè¨­è¨ˆ', type: 'child', no: '2-3', group: 'B', assignee: 'éˆ´æœ¨', manDays: 3, cost: 150, planStart: '03/11', planEnd: '03/31', actualManDays: 3, actualCost: 140, actualStart: '03/13', actualEnd: '03/31', progress: 100, delay: { type: 'ontime', text: 'äºˆå®šé€šã‚Š' } },
            { id: '3', name: 'PG', type: 'parent', no: '3', group: '', assignee: '-', manDays: 25, cost: 1250, planStart: '04/01', planEnd: '05/20', actualManDays: null, actualCost: null, actualStart: '04/01', actualEnd: '-', progress: 55, delay: { type: 'late', text: '2æ—¥é…ã‚Œ' } },
            { id: '3-1', name: 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…', type: 'child', no: '3-1', group: 'C', assignee: 'ç”°ä¸­', manDays: 10, cost: 500, planStart: '04/01', planEnd: '05/20', actualManDays: null, actualCost: null, actualStart: '04/01', actualEnd: '-', progress: 60, delay: { type: 'late', text: '2æ—¥é…ã‚Œ' }, hasChildren: true },
            { id: '3-1-1', name: 'ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢', type: 'grandchild', no: '3-1-1', group: 'C-1', assignee: 'ç”°ä¸­', manDays: 2, cost: 100, planStart: '04/01', planEnd: '05/20', actualManDays: 2, actualCost: 100, actualStart: '04/01', actualEnd: '04/05', progress: 100, delay: { type: 'ontime', text: 'äºˆå®šé€šã‚Š' } },
            { id: '3-1-2', name: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢', type: 'grandchild', no: '3-1-2', group: 'C-1', assignee: 'ç”°ä¸­', manDays: 3, cost: 150, planStart: '04/06', planEnd: '05/20', actualManDays: 3, actualCost: 150, actualStart: '04/06', actualEnd: '04/14', progress: 100, delay: { type: 'late', text: '2æ—¥é…ã‚Œ' } },
            { id: '3-1-3', name: 'ä¸€è¦§ç”»é¢', type: 'grandchild', no: '3-1-3', group: 'C-1', assignee: 'ç”°ä¸­', manDays: 3, cost: 150, planStart: '04/13', planEnd: '05/20', actualManDays: null, actualCost: null, actualStart: '04/15', actualEnd: '-', progress: 50, delay: { type: 'late', text: '2æ—¥é…ã‚Œ' } },
            { id: '3-1-4', name: 'è©³ç´°ç”»é¢', type: 'grandchild', no: '3-1-4', group: 'C-1', assignee: 'ç”°ä¸­', manDays: 2, cost: 100, planStart: '04/21', planEnd: '05/20', actualManDays: null, actualCost: null, actualStart: '-', actualEnd: '-', progress: 0, delay: { type: 'ontime', text: '-' } },
            { id: '3-2', name: 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIå®Ÿè£…', type: 'child', no: '3-2', group: 'C', assignee: 'éˆ´æœ¨', manDays: 10, cost: 500, planStart: '04/05', planEnd: '05/20', actualManDays: null, actualCost: null, actualStart: '04/05', actualEnd: '-', progress: 45, delay: { type: 'ontime', text: 'äºˆå®šé€šã‚Š' } },
            { id: '3-3', name: 'å˜ä½“ãƒ†ã‚¹ãƒˆ', type: 'child', no: '3-3', group: 'C', assignee: 'é«˜æ©‹', manDays: 5, cost: 250, planStart: '04/15', planEnd: '05/20', actualManDays: null, actualCost: null, actualStart: '04/17', actualEnd: '-', progress: 30, delay: { type: 'late', text: '2æ—¥é…ã‚Œ' } },
            { id: '4', name: 'ãƒ†ã‚¹ãƒˆ', type: 'parent', no: '4', group: '', assignee: '-', manDays: 8, cost: 400, planStart: '05/21', planEnd: '06/15', actualManDays: null, actualCost: null, actualStart: '-', actualEnd: '-', progress: 0, delay: { type: 'ontime', text: '-' } },
            { id: '4-1', name: 'çµåˆãƒ†ã‚¹ãƒˆ', type: 'child', no: '4-1', group: 'D', assignee: 'é«˜æ©‹', manDays: 4, cost: 200, planStart: '05/21', planEnd: '06/15', actualManDays: null, actualCost: null, actualStart: '-', actualEnd: '-', progress: 0, delay: { type: 'ontime', text: '-' } },
            { id: '4-2', name: 'UAT', type: 'child', no: '4-2', group: 'D', assignee: 'å±±ç”°', manDays: 4, cost: 200, planStart: '06/06', planEnd: '06/15', actualManDays: null, actualCost: null, actualStart: '-', actualEnd: '-', progress: 0, delay: { type: 'ontime', text: '-' } },
            { id: '5', name: 'ãƒªãƒªãƒ¼ã‚¹', type: 'parent', no: '5', group: '', assignee: '-', manDays: 3, cost: 150, planStart: '06/16', planEnd: '06/30', actualManDays: null, actualCost: null, actualStart: '-', actualEnd: '-', progress: 0, delay: { type: 'ontime', text: '-' } },
            { id: '5-1', name: 'æœ¬ç•ªç’°å¢ƒæ§‹ç¯‰', type: 'child', no: '5-1', group: 'E', assignee: 'éˆ´æœ¨', manDays: 2, cost: 100, planStart: '06/16', planEnd: '06/30', actualManDays: null, actualCost: null, actualStart: '-', actualEnd: '-', progress: 0, delay: { type: 'ontime', text: '-' } },
            { id: '5-2', name: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»å…¬é–‹', type: 'child', no: '5-2', group: 'E', assignee: 'éˆ´æœ¨', manDays: 1, cost: 50, planStart: '06/26', planEnd: '06/30', actualManDays: null, actualCost: null, actualStart: '-', actualEnd: '-', progress: 0, delay: { type: 'ontime', text: '-' } }
        ];

        // ========================================
        // å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ - ãƒ‡ãƒ¼ã‚¿å®šç¾©
        // ========================================
        var allProjectsData = {
            '1': { name: 'ECã‚µã‚¤ãƒˆãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«', customer: 'æ ªå¼ä¼šç¤¾ABCå•†äº‹', color: '#3b82f6', colorClass: 'from-blue-500 to-blue-600' },
            '2': { name: 'åŸºå¹¹ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°', customer: 'æ ªå¼ä¼šç¤¾ABCå•†äº‹', color: '#8b5cf6', colorClass: 'from-violet-500 to-violet-600' },
            '3': { name: 'ç¤¾å†…æ¥­å‹™ã‚·ã‚¹ãƒ†ãƒ é–‹ç™º', customer: 'XYZæ ªå¼ä¼šç¤¾', color: '#10b981', colorClass: 'from-emerald-500 to-emerald-600' },
            '4': { name: 'å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ', customer: 'XYZæ ªå¼ä¼šç¤¾', color: '#f59e0b', colorClass: 'from-amber-500 to-amber-600' },
            '5': { name: 'ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªé–‹ç™º', customer: 'æ ªå¼ä¼šç¤¾ãƒ†ãƒƒã‚¯ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³', color: '#ef4444', colorClass: 'from-red-500 to-red-600' },
            '6': { name: 'åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ', customer: 'ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‰æ ªå¼ä¼šç¤¾', color: '#06b6d4', colorClass: 'from-cyan-500 to-cyan-600' },
            '7': { name: 'å—ç™ºæ³¨ã‚·ã‚¹ãƒ†ãƒ æ”¹ä¿®', customer: 'ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‰æ ªå¼ä¼šç¤¾', color: '#ec4899', colorClass: 'from-pink-500 to-pink-600' }
        };

        // å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰- è¦ªãƒ»å­ãƒ»å­«å«ã‚€
        var allProjectsTaskData = [
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ1: ECã‚µã‚¤ãƒˆãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ï¼ˆæ ªå¼ä¼šç¤¾ABCå•†äº‹ï¼‰
            { id: 101, projectId: '1', no: '1', type: 'parent', name: 'è¦ä»¶å®šç¾©', assignee: '-', manDays: 10, cost: 50, planStart: '01/06', planEnd: '01/17', actualStart: '01/06', actualEnd: '01/17', progress: 100, delay: { type: 'ontime', text: '-', days: 0 }, group: '1' },
            { id: 1011, projectId: '1', no: '1-1', type: 'child', name: 'ãƒ’ã‚¢ãƒªãƒ³ã‚°', assignee: 'å±±ç”°', manDays: 3, cost: 15, planStart: '01/06', planEnd: '01/08', actualStart: '01/06', actualEnd: '01/08', progress: 100, delay: { type: 'ontime', text: '-', days: 0 }, group: '1' },
            { id: 1012, projectId: '1', no: '1-2', type: 'child', name: 'è¦ä»¶æ›¸ä½œæˆ', assignee: 'å±±ç”°', manDays: 5, cost: 25, planStart: '01/09', planEnd: '01/15', actualStart: '01/09', actualEnd: '01/15', progress: 100, delay: { type: 'ontime', text: '-', days: 0 }, group: '1' },
            { id: 1013, projectId: '1', no: '1-3', type: 'child', name: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼', assignee: 'ä½è—¤', manDays: 2, cost: 10, planStart: '01/16', planEnd: '01/17', actualStart: '01/16', actualEnd: '01/17', progress: 100, delay: { type: 'ontime', text: '-', days: 0 }, group: '1' },
            { id: 102, projectId: '1', no: '2', type: 'parent', name: 'è¨­è¨ˆ', assignee: '-', manDays: 15, cost: 75, planStart: '01/20', planEnd: '02/07', actualStart: '01/20', actualEnd: '', progress: 60, delay: { type: 'ontime', text: '-', days: 0 }, group: '2' },
            { id: 1021, projectId: '1', no: '2-1', type: 'child', name: 'ç”»é¢è¨­è¨ˆ', assignee: 'ä½è—¤', manDays: 5, cost: 25, planStart: '01/20', planEnd: '01/24', actualStart: '01/20', actualEnd: '01/24', progress: 100, delay: { type: 'ontime', text: '-', days: 0 }, group: '2' },
            { id: 1022, projectId: '1', no: '2-2', type: 'child', name: 'DBè¨­è¨ˆ', assignee: 'éˆ´æœ¨', manDays: 5, cost: 25, planStart: '01/27', planEnd: '01/31', actualStart: '01/27', actualEnd: '', progress: 60, delay: { type: 'ontime', text: '-', days: 0 }, group: '2' },
            { id: 1023, projectId: '1', no: '2-3', type: 'child', name: 'APIè¨­è¨ˆ', assignee: 'éˆ´æœ¨', manDays: 5, cost: 25, planStart: '02/03', planEnd: '02/07', actualStart: '', actualEnd: '', progress: 0, delay: { type: 'none', text: '-', days: 0 }, group: '2' },
            { id: 103, projectId: '1', no: '3', type: 'parent', name: 'é–‹ç™º', assignee: '-', manDays: 30, cost: 150, planStart: '02/10', planEnd: '03/14', actualStart: '', actualEnd: '', progress: 0, delay: { type: 'none', text: '-', days: 0 }, group: '3' },
            { id: 1031, projectId: '1', no: '3-1', type: 'child', name: 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰', assignee: 'ç”°ä¸­', manDays: 15, cost: 75, planStart: '02/10', planEnd: '02/28', actualStart: '', actualEnd: '', progress: 0, delay: { type: 'none', text: '-', days: 0 }, group: '3' },
            { id: 1032, projectId: '1', no: '3-2', type: 'child', name: 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰', assignee: 'éˆ´æœ¨', manDays: 15, cost: 75, planStart: '02/10', planEnd: '03/14', actualStart: '', actualEnd: '', progress: 0, delay: { type: 'none', text: '-', days: 0 }, group: '3' },

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ2: åŸºå¹¹ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°ï¼ˆæ ªå¼ä¼šç¤¾ABCå•†äº‹ï¼‰
            { id: 201, projectId: '2', no: '1', type: 'parent', name: 'ç¾çŠ¶åˆ†æ', assignee: '-', manDays: 8, cost: 40, planStart: '01/13', planEnd: '01/24', actualStart: '01/13', actualEnd: '01/24', progress: 100, delay: { type: 'ontime', text: '-', days: 0 }, group: '1' },
            { id: 2011, projectId: '2', no: '1-1', type: 'child', name: 'æ¥­å‹™ãƒ•ãƒ­ãƒ¼åˆ†æ', assignee: 'ç”°ä¸­', manDays: 4, cost: 20, planStart: '01/13', planEnd: '01/16', actualStart: '01/13', actualEnd: '01/16', progress: 100, delay: { type: 'ontime', text: '-', days: 0 }, group: '1' },
            { id: 2012, projectId: '2', no: '1-2', type: 'child', name: 'ã‚·ã‚¹ãƒ†ãƒ èª¿æŸ»', assignee: 'é«˜æ©‹', manDays: 4, cost: 20, planStart: '01/20', planEnd: '01/24', actualStart: '01/20', actualEnd: '01/24', progress: 100, delay: { type: 'ontime', text: '-', days: 0 }, group: '1' },
            { id: 202, projectId: '2', no: '2', type: 'parent', name: 'DBç§»è¡Œè¨­è¨ˆ', assignee: '-', manDays: 12, cost: 60, planStart: '01/27', planEnd: '02/14', actualStart: '01/27', actualEnd: '', progress: 40, delay: { type: 'late', text: '+2æ—¥', days: 2 }, group: '2' },
            { id: 2021, projectId: '2', no: '2-1', type: 'child', name: 'ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ', assignee: 'é«˜æ©‹', manDays: 6, cost: 30, planStart: '01/27', planEnd: '02/03', actualStart: '01/27', actualEnd: '', progress: 80, delay: { type: 'late', text: '+2æ—¥', days: 2 }, group: '2' },
            { id: 2022, projectId: '2', no: '2-2', type: 'child', name: 'ç§»è¡Œè¨ˆç”»', assignee: 'ç”°ä¸­', manDays: 6, cost: 30, planStart: '02/05', planEnd: '02/14', actualStart: '', actualEnd: '', progress: 0, delay: { type: 'none', text: '-', days: 0 }, group: '2' },

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ3: ç¤¾å†…æ¥­å‹™ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºï¼ˆXYZæ ªå¼ä¼šç¤¾ï¼‰
            { id: 301, projectId: '3', no: '1', type: 'parent', name: 'ç”»é¢è¨­è¨ˆ', assignee: '-', manDays: 10, cost: 50, planStart: '01/06', planEnd: '01/17', actualStart: '01/06', actualEnd: '01/15', progress: 100, delay: { type: 'ahead', text: '-2æ—¥', days: -2 }, group: '1' },
            { id: 3011, projectId: '3', no: '1-1', type: 'child', name: 'ãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ ', assignee: 'å±±ç”°', manDays: 5, cost: 25, planStart: '01/06', planEnd: '01/10', actualStart: '01/06', actualEnd: '01/09', progress: 100, delay: { type: 'ahead', text: '-1æ—¥', days: -1 }, group: '1' },
            { id: 3012, projectId: '3', no: '1-2', type: 'child', name: 'ãƒ‡ã‚¶ã‚¤ãƒ³', assignee: 'ä½è—¤', manDays: 5, cost: 25, planStart: '01/13', planEnd: '01/17', actualStart: '01/10', actualEnd: '01/15', progress: 100, delay: { type: 'ahead', text: '-2æ—¥', days: -2 }, group: '1' },
            { id: 302, projectId: '3', no: '2', type: 'parent', name: 'APIé–‹ç™º', assignee: '-', manDays: 20, cost: 100, planStart: '01/20', planEnd: '02/14', actualStart: '01/18', actualEnd: '', progress: 75, delay: { type: 'ontime', text: '-', days: 0 }, group: '2' },
            { id: 3021, projectId: '3', no: '2-1', type: 'child', name: 'èªè¨¼API', assignee: 'éˆ´æœ¨', manDays: 5, cost: 25, planStart: '01/20', planEnd: '01/24', actualStart: '01/18', actualEnd: '01/23', progress: 100, delay: { type: 'ahead', text: '-1æ—¥', days: -1 }, group: '2' },
            { id: 3022, projectId: '3', no: '2-2', type: 'child', name: 'æ¥­å‹™API', assignee: 'éˆ´æœ¨', manDays: 10, cost: 50, planStart: '01/27', planEnd: '02/07', actualStart: '01/24', actualEnd: '', progress: 80, delay: { type: 'ontime', text: '-', days: 0 }, group: '2' },
            { id: 3023, projectId: '3', no: '2-3', type: 'child', name: 'ãƒ¬ãƒãƒ¼ãƒˆAPI', assignee: 'ç”°ä¸­', manDays: 5, cost: 25, planStart: '02/10', planEnd: '02/14', actualStart: '', actualEnd: '', progress: 0, delay: { type: 'none', text: '-', days: 0 }, group: '2' },

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ4: å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆXYZæ ªå¼ä¼šç¤¾ï¼‰
            { id: 401, projectId: '4', no: '1', type: 'parent', name: 'è¦ä»¶ãƒ’ã‚¢ãƒªãƒ³ã‚°', assignee: '-', manDays: 5, cost: 25, planStart: '01/20', planEnd: '01/24', actualStart: '01/20', actualEnd: '01/24', progress: 100, delay: { type: 'ontime', text: '-', days: 0 }, group: '1' },
            { id: 4011, projectId: '4', no: '1-1', type: 'child', name: 'ç¾å ´ãƒ’ã‚¢ãƒªãƒ³ã‚°', assignee: 'ä½è—¤', manDays: 3, cost: 15, planStart: '01/20', planEnd: '01/22', actualStart: '01/20', actualEnd: '01/22', progress: 100, delay: { type: 'ontime', text: '-', days: 0 }, group: '1' },
            { id: 4012, projectId: '4', no: '1-2', type: 'child', name: 'è¦ä»¶ã¾ã¨ã‚', assignee: 'ä½è—¤', manDays: 2, cost: 10, planStart: '01/23', planEnd: '01/24', actualStart: '01/23', actualEnd: '01/24', progress: 100, delay: { type: 'ontime', text: '-', days: 0 }, group: '1' },
            { id: 402, projectId: '4', no: '2', type: 'parent', name: 'ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ä½œæˆ', assignee: '-', manDays: 10, cost: 50, planStart: '01/27', planEnd: '02/07', actualStart: '01/27', actualEnd: '', progress: 50, delay: { type: 'ontime', text: '-', days: 0 }, group: '2' },
            { id: 4021, projectId: '4', no: '2-1', type: 'child', name: 'æ‰“åˆ»æ©Ÿèƒ½', assignee: 'ç”°ä¸­', manDays: 5, cost: 25, planStart: '01/27', planEnd: '01/31', actualStart: '01/27', actualEnd: '01/31', progress: 100, delay: { type: 'ontime', text: '-', days: 0 }, group: '2' },
            { id: 4022, projectId: '4', no: '2-2', type: 'child', name: 'é›†è¨ˆæ©Ÿèƒ½', assignee: 'ç”°ä¸­', manDays: 5, cost: 25, planStart: '02/03', planEnd: '02/07', actualStart: '02/03', actualEnd: '', progress: 0, delay: { type: 'none', text: '-', days: 0 }, group: '2' },

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ5: ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªé–‹ç™ºï¼ˆæ ªå¼ä¼šç¤¾ãƒ†ãƒƒã‚¯ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
            { id: 501, projectId: '5', no: '1', type: 'parent', name: 'UI/UXãƒ‡ã‚¶ã‚¤ãƒ³', assignee: '-', manDays: 15, cost: 75, planStart: '01/06', planEnd: '01/24', actualStart: '01/06', actualEnd: '', progress: 80, delay: { type: 'ontime', text: '-', days: 0 }, group: '1' },
            { id: 5011, projectId: '5', no: '1-1', type: 'child', name: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼èª¿æŸ»', assignee: 'é«˜æ©‹', manDays: 5, cost: 25, planStart: '01/06', planEnd: '01/10', actualStart: '01/06', actualEnd: '01/10', progress: 100, delay: { type: 'ontime', text: '-', days: 0 }, group: '1' },
            { id: 5012, projectId: '5', no: '1-2', type: 'child', name: 'UIãƒ‡ã‚¶ã‚¤ãƒ³', assignee: 'é«˜æ©‹', manDays: 7, cost: 35, planStart: '01/13', planEnd: '01/21', actualStart: '01/13', actualEnd: '', progress: 80, delay: { type: 'ontime', text: '-', days: 0 }, group: '1' },
            { id: 5013, projectId: '5', no: '1-3', type: 'child', name: 'ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—', assignee: 'å±±ç”°', manDays: 3, cost: 15, planStart: '01/22', planEnd: '01/24', actualStart: '', actualEnd: '', progress: 0, delay: { type: 'none', text: '-', days: 0 }, group: '1' },
            { id: 502, projectId: '5', no: '2', type: 'parent', name: 'iOSé–‹ç™º', assignee: '-', manDays: 25, cost: 125, planStart: '01/27', planEnd: '02/28', actualStart: '', actualEnd: '', progress: 0, delay: { type: 'none', text: '-', days: 0 }, group: '2' },
            { id: 5021, projectId: '5', no: '2-1', type: 'child', name: 'åŸºæœ¬æ©Ÿèƒ½å®Ÿè£…', assignee: 'éˆ´æœ¨', manDays: 15, cost: 75, planStart: '01/27', planEnd: '02/14', actualStart: '', actualEnd: '', progress: 0, delay: { type: 'none', text: '-', days: 0 }, group: '2' },
            { id: 5022, projectId: '5', no: '2-2', type: 'child', name: 'ãƒ†ã‚¹ãƒˆãƒ»èª¿æ•´', assignee: 'éˆ´æœ¨', manDays: 10, cost: 50, planStart: '02/17', planEnd: '02/28', actualStart: '', actualEnd: '', progress: 0, delay: { type: 'none', text: '-', days: 0 }, group: '2' },
        ];

        var singleProjectTaskData = [...taskData]; // å˜ä¸€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        var isAllProjectsMode = false;

        // å¤‰æ›´ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯IDã‚’è¨˜éŒ²
        var modifiedTaskIds = new Set();

        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿
        var importPreviewData = [];

        // TASK_DATAã®æ—¥ä»˜ã‚’taskDataã«åŒæœŸ
        function syncDatesFromGanttData() {
            TASK_DATA.forEach(function(ganttTask) {
                var task = taskData.find(function(t) { return t.id === ganttTask.id; });
                if (task) {
                    // å­ã‚¿ã‚¹ã‚¯ãƒ»å­«ã‚¿ã‚¹ã‚¯ã®ã¿åŒæœŸï¼ˆè¦ªã‚¿ã‚¹ã‚¯ã¯å­ã‹ã‚‰è¨ˆç®—ã•ã‚Œã‚‹ãŸã‚ï¼‰
                    if (task.type !== 'parent') {
                        task.planStart = ganttTask.startDate;
                        task.planEnd = ganttTask.endDate;
                    }
                }
            });
        }

        // ä»Šæœˆã‹ã‚‰1å¹´åˆ†ã®MONTHS_DATAã‚’å‹•çš„ã«ç”Ÿæˆ
        function generateMonthsData() {
            var months = [];
            var startDate = new Date(TODAY.getFullYear(), TODAY.getMonth(), 1);

            for (var i = 0; i < 12; i++) {
                var year = startDate.getFullYear();
                var month = startDate.getMonth() + 1; // 1-12
                var daysInMonth = new Date(year, month, 0).getDate();

                months.push({
                    year: year,
                    month: month,
                    days: daysInMonth,
                    name: year + 'å¹´' + month + 'æœˆ'
                });

                // æ¬¡ã®æœˆã¸
                startDate.setMonth(startDate.getMonth() + 1);
            }
            return months;
        }

        var MONTHS_DATA = [];

        // å¹´æœˆé¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
        function generateMonthSelect() {
            var $select = $('#month-select');
            $select.empty();

            $.each(MONTHS_DATA, function(index, monthData) {
                var value = monthData.year + '-' + monthData.month;
                var $option = $('<option>')
                    .val(value)
                    .text(monthData.name);

                // ä»Šæœˆã‚’åˆæœŸé¸æŠ
                if (monthData.year === TODAY.getFullYear() && monthData.month === TODAY.getMonth() + 1) {
                    $option.prop('selected', true);
                }

                $select.append($option);
            });
        }

        // æŒ‡å®šæœˆã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        function scrollToMonth(value) {
            var parts = value.split('-');
            var targetYear = parseInt(parts[0]);
            var targetMonth = parseInt(parts[1]);

            // è©²å½“æœˆã®é–‹å§‹ä½ç½®ã‚’è¨ˆç®—
            var scrollPos = 0;
            for (var i = 0; i < MONTHS_DATA.length; i++) {
                if (MONTHS_DATA[i].year === targetYear && MONTHS_DATA[i].month === targetMonth) {
                    break;
                }
                scrollPos += MONTHS_DATA[i].days * CELL_WIDTH;
            }

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Ÿè¡Œ
            $('#gantt-scroll').animate({ scrollLeft: scrollPos }, 300);
            $('#gantt-header-scroll').animate({ scrollLeft: scrollPos }, 300);
        }

        // ä»Šæ—¥ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        function scrollToToday() {
            var todayYear = TODAY.getFullYear();
            var todayMonth = TODAY.getMonth() + 1;
            var todayDay = TODAY.getDate();

            // ä»Šæ—¥ã®ä½ç½®ã‚’è¨ˆç®—
            var scrollPos = 0;
            for (var i = 0; i < MONTHS_DATA.length; i++) {
                if (MONTHS_DATA[i].year === todayYear && MONTHS_DATA[i].month === todayMonth) {
                    // ä»Šæ—¥ã®æ—¥ä»˜åˆ†ã‚’åŠ ç®—ï¼ˆç”»é¢ä¸­å¤®ã«è¡¨ç¤ºã™ã‚‹ãŸã‚èª¿æ•´ï¼‰
                    scrollPos += (todayDay - 1) * CELL_WIDTH;
                    // ç”»é¢ã®ä¸­å¤®ä»˜è¿‘ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã€å°‘ã—å·¦ã«ãšã‚‰ã™
                    scrollPos = Math.max(0, scrollPos - 200);
                    break;
                }
                scrollPos += MONTHS_DATA[i].days * CELL_WIDTH;
            }

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Ÿè¡Œ
            $('#gantt-scroll').animate({ scrollLeft: scrollPos }, 300);
            $('#gantt-header-scroll').animate({ scrollLeft: scrollPos }, 300);

            // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚‚ä»Šæœˆã«è¨­å®š
            $('#month-select').val(todayYear + '-' + todayMonth);
        }

        // ä»Šæ—¥ã®ãƒ”ã‚¯ã‚»ãƒ«ä½ç½®ã‚’è¨ˆç®—
        function calculateTodayPosition() {
            var todayYear = TODAY.getFullYear();
            var todayMonth = TODAY.getMonth() + 1;
            var todayDay = TODAY.getDate();

            var position = 0;
            for (var i = 0; i < MONTHS_DATA.length; i++) {
                if (MONTHS_DATA[i].year === todayYear && MONTHS_DATA[i].month === todayMonth) {
                    position += (todayDay - 1) * CELL_WIDTH;
                    return position;
                }
                position += MONTHS_DATA[i].days * CELL_WIDTH;
            }
            return -1; // ä»Šæ—¥ãŒã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç¯„å›²å¤–
        }

        // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰
        var currentMode = 'plan';
        var selectedTaskRow = null;

        // è¤‡æ•°é¸æŠç”¨
        var selectedTasks = new Set(); // é¸æŠã•ã‚ŒãŸã‚¿ã‚¹ã‚¯IDã®ã‚»ãƒƒãƒˆ

        // ã‚¿ã‚¹ã‚¯é¸æŠ
        function selectTask(taskId, $bar) {
            selectedTasks.add(taskId);
            $bar.addClass('task-bar-selected');
            // ã‚¿ã‚¹ã‚¯ä¸€è¦§å´ã‚‚é¸æŠè¡¨ç¤º
            $('.task-row-item[data-task="' + taskId + '"]').addClass('task-row-selected');
            updateSelectionUI();
        }

        // ã‚¿ã‚¹ã‚¯é¸æŠè§£é™¤
        function deselectTask(taskId, $bar) {
            selectedTasks.delete(taskId);
            $bar.removeClass('task-bar-selected');
            $('.task-row-item[data-task="' + taskId + '"]').removeClass('task-row-selected');
            updateSelectionUI();
        }

        // ã‚¿ã‚¹ã‚¯é¸æŠãƒˆã‚°ãƒ«
        function toggleTaskSelection(taskId, $bar) {
            if (selectedTasks.has(taskId)) {
                deselectTask(taskId, $bar);
            } else {
                selectTask(taskId, $bar);
            }
        }

        // å…¨é¸æŠã‚¯ãƒªã‚¢
        function clearTaskSelection() {
            selectedTasks.forEach(function(taskId) {
                $('.task-bar[data-task-id="' + taskId + '"]').removeClass('task-bar-selected');
                $('.task-row-item[data-task="' + taskId + '"]').removeClass('task-row-selected');
            });
            selectedTasks.clear();
            updateSelectionUI();
        }

        // é¸æŠUIã®æ›´æ–°
        function updateSelectionUI() {
            var count = selectedTasks.size;
            if (count > 0) {
                $('#selection-toolbar').show();
                $('#selection-count').text(count + 'ä»¶é¸æŠä¸­');
            } else {
                $('#selection-toolbar').hide();
            }
        }

        // é¸æŠã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚’ä¸€æ‹¬ç§»å‹•
        function bulkMoveSelected(days) {
            if (selectedTasks.size === 0) return;

            selectedTasks.forEach(function(taskId) {
                var $bar = $('.task-bar[data-task-id="' + taskId + '"]');
                if ($bar.length) {
                    var currentLeft = parseInt($bar.css('left')) || 0;
                    var newLeft = Math.max(0, currentLeft + (days * CELL_WIDTH));
                    $bar.css('left', newLeft + 'px');

                    // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                    var task = taskData.find(function(t) { return String(t.id) === String(taskId); });
                    if (task) {
                        task.planStart = addDaysToDate(task.planStart, days);
                        task.planEnd = addDaysToDate(task.planEnd, days);
                        modifiedTaskIds.add(taskId);
                    }
                }
            });

            generateTaskList();
        }

        // æ—¥ä»˜ã«æ—¥æ•°ã‚’åŠ ç®—
        function addDaysToDate(dateStr, days) {
            if (!dateStr || dateStr === '-') return dateStr;
            var date = parseDisplayDate(dateStr);
            if (!date) return dateStr;
            date.setDate(date.getDate() + days);
            return (date.getMonth() + 1).toString().padStart(2, '0') + '/' +
                   date.getDate().toString().padStart(2, '0');
        }

        // ä¸€æ‹¬å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openBulkEditModal() {
            $('#bulk-edit-count').text(selectedTasks.size);
            $('#bulk-move-days').val(0);
            $('#bulk-assignee').val('');
            $('#bulk-edit-modal').removeClass('hidden').addClass('flex');
        }

        // ä¸€æ‹¬å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeBulkEditModal() {
            $('#bulk-edit-modal').removeClass('flex').addClass('hidden');
        }

        // æ—¥æ•°èª¿æ•´ãƒœã‚¿ãƒ³
        function adjustBulkDays(delta) {
            var current = parseInt($('#bulk-move-days').val()) || 0;
            $('#bulk-move-days').val(current + delta);
        }

        // ä¸€æ‹¬å¤‰æ›´ã‚’é©ç”¨
        function applyBulkEdit() {
            var moveDays = parseInt($('#bulk-move-days').val()) || 0;
            var newAssignee = $('#bulk-assignee').val();

            if (moveDays !== 0) {
                bulkMoveSelected(moveDays);
            }

            if (newAssignee) {
                selectedTasks.forEach(function(taskId) {
                    var task = taskData.find(function(t) { return String(t.id) === String(taskId); });
                    if (task && task.type !== 'parent') {
                        task.assignee = newAssignee;
                        modifiedTaskIds.add(taskId);
                    }
                });
                generateTaskList();
            }

            closeBulkEditModal();
            clearTaskSelection();
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç”Ÿæˆ
        function generateCalendarHeaders() {
            var $monthHeader = $('#month-header');
            var $weekdayHeader = $('#weekday-header');
            var $dateHeader = $('#date-header');

            $monthHeader.empty();
            $weekdayHeader.empty();
            $dateHeader.empty();

            $.each(MONTHS_DATA, function(monthIndex, monthData) {
                var width = monthData.days * CELL_WIDTH;

                // æœˆãƒ˜ãƒƒãƒ€ãƒ¼
                var $monthDiv = $('<div>')
                    .addClass('text-center font-bold text-slate-700 flex items-center justify-center border-r border-slate-300 bg-slate-200')
                    .css('width', width + 'px')
                    .text(monthData.name);
                $monthHeader.append($monthDiv);

                // å„æ—¥ã®æ›œæ—¥ã¨æ—¥ä»˜
                for (var day = 1; day <= monthData.days; day++) {
                    var date = new Date(monthData.year, monthData.month - 1, day);
                    var weekday = date.getDay();
                    var isToday = date.getTime() === TODAY.getTime();
                    var isSaturday = weekday === 6;
                    var isSunday = weekday === 0;

                    // æ›œæ—¥ã‚»ãƒ«
                    var weekdayClass = 'gantt-cell flex items-center justify-center text-xs border-r border-slate-100';
                    if (isSunday) {
                        weekdayClass += ' text-rose-500 weekend-sun';
                    } else if (isSaturday) {
                        weekdayClass += ' text-blue-500 weekend-sat';
                    } else {
                        weekdayClass += ' text-slate-500';
                    }
                    if (day === monthData.days) {
                        weekdayClass = weekdayClass.replace('border-slate-100', 'border-slate-300');
                    }
                    var $weekdayCell = $('<div>')
                        .addClass(weekdayClass)
                        .css('height', '24px')
                        .text(WEEKDAY_NAMES[weekday]);
                    $weekdayHeader.append($weekdayCell);

                    // æ—¥ä»˜ã‚»ãƒ«
                    var dateClass = 'gantt-cell flex items-center justify-center text-sm border-r border-slate-100';
                    if (isToday) {
                        dateClass += ' today-marker';
                    } else if (isSunday) {
                        dateClass += ' text-rose-500 weekend-sun';
                    } else if (isSaturday) {
                        dateClass += ' text-blue-500 weekend-sat';
                    } else {
                        dateClass += ' text-slate-600';
                    }
                    if (day === monthData.days) {
                        dateClass = dateClass.replace('border-slate-100', 'border-slate-300');
                    }
                    var $dateCell = $('<div>')
                        .addClass(dateClass)
                        .text(day);
                    $dateHeader.append($dateCell);
                }
            });
        }

        // å…±é€šã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿
        var TASK_DATA = [
            { id: '1', type: 'parent', name: 'è¦ä»¶å®šç¾©', assignee: 'å±±ç”°', manDays: 5, startDate: '01/15', endDate: '02/15', status: 'completed', start: null, width: 0 },
            { id: '1-1', type: 'child', name: 'ãƒ’ã‚¢ãƒªãƒ³ã‚°', assignee: 'å±±ç”°', manDays: 2, startDate: '01/15', endDate: '01/25', status: 'completed', start: null, width: 0 },
            { id: '1-2', type: 'child', name: 'è¦ä»¶æ›¸ä½œæˆ', assignee: 'å±±ç”°', manDays: 3, startDate: '01/26', endDate: '02/15', status: 'completed', start: null, width: 0 },
            { id: '2', type: 'parent', name: 'è¨­è¨ˆ', assignee: 'ä½è—¤', manDays: 10, startDate: '02/16', endDate: '03/31', status: 'completed', start: null, width: 0 },
            { id: '2-1', type: 'child', name: 'ç”»é¢è¨­è¨ˆ', assignee: 'ä½è—¤', manDays: 4, startDate: '02/16', endDate: '03/10', status: 'completed', start: null, width: 0 },
            { id: '2-2', type: 'child', name: 'DBè¨­è¨ˆ', assignee: 'éˆ´æœ¨', manDays: 3, startDate: '03/01', endDate: '03/20', status: 'completed', start: null, width: 0 },
            { id: '2-3', type: 'child', name: 'APIè¨­è¨ˆ', assignee: 'éˆ´æœ¨', manDays: 3, startDate: '03/11', endDate: '03/31', status: 'completed', start: null, width: 0 },
            { id: '3', type: 'parent', name: 'PGãƒ•ã‚§ãƒ¼ã‚º', assignee: '', manDays: 25, startDate: '04/01', endDate: '05/20', status: 'in-progress', start: 0, width: 2000, label: 'PGãƒ•ã‚§ãƒ¼ã‚º', color: 'from-blue-100 to-indigo-100', border: 'border-blue-300', textColor: 'text-blue-800' },
            { id: '3-1', type: 'child', name: 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…', assignee: 'ç”°ä¸­', manDays: 10, startDate: '04/01', endDate: '04/28', status: 'in-progress', start: 0, width: 1120, label: 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…', color: 'from-blue-500 to-indigo-600' },
            { id: '3-1-1', type: 'grandchild', name: 'ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢', assignee: 'ç”°ä¸­', manDays: 2, startDate: '04/01', endDate: '04/05', status: 'completed', start: 0, width: 200, label: 'ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢', color: 'from-blue-400 to-indigo-500' },
            { id: '3-1-2', type: 'grandchild', name: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', assignee: 'ç”°ä¸­', manDays: 3, startDate: '04/06', endDate: '04/12', status: 'completed', start: 200, width: 280, label: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', color: 'from-blue-400 to-indigo-500' },
            { id: '3-1-3', type: 'grandchild', name: 'ä¸€è¦§ç”»é¢', assignee: 'ç”°ä¸­', manDays: 3, startDate: '04/13', endDate: '04/20', status: 'in-progress', start: 480, width: 320, label: 'ä¸€è¦§ç”»é¢', color: 'from-blue-400 to-indigo-500' },
            { id: '3-1-4', type: 'grandchild', name: 'è©³ç´°ç”»é¢', assignee: 'ç”°ä¸­', manDays: 2, startDate: '04/21', endDate: '04/28', status: 'not-started', start: 800, width: 320, label: 'è©³ç´°ç”»é¢', color: 'from-blue-400 to-indigo-500' },
            { id: '3-2', type: 'child', name: 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIå®Ÿè£…', assignee: 'éˆ´æœ¨', manDays: 10, startDate: '04/05', endDate: '05/10', status: 'in-progress', start: 160, width: 1440, label: 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIå®Ÿè£…', color: 'from-blue-500 to-indigo-600' },
            { id: '3-3', type: 'child', name: 'å˜ä½“ãƒ†ã‚¹ãƒˆ', assignee: 'é«˜æ©‹', manDays: 5, startDate: '04/15', endDate: '05/20', status: 'in-progress', start: 560, width: 1440, label: 'å˜ä½“ãƒ†ã‚¹ãƒˆ', color: 'from-purple-500 to-pink-600' },
            { id: '4', type: 'parent', name: 'ãƒ†ã‚¹ãƒˆãƒ•ã‚§ãƒ¼ã‚º', assignee: '', manDays: 8, startDate: '05/21', endDate: '06/15', status: 'not-started', start: 2000, width: 1040, label: 'ãƒ†ã‚¹ãƒˆãƒ•ã‚§ãƒ¼ã‚º', color: 'from-amber-100 to-yellow-100', border: 'border-amber-300', textColor: 'text-amber-800' },
            { id: '4-1', type: 'child', name: 'çµåˆãƒ†ã‚¹ãƒˆ', assignee: 'é«˜æ©‹', manDays: 4, startDate: '05/21', endDate: '06/05', status: 'not-started', start: 2000, width: 640, label: 'çµåˆãƒ†ã‚¹ãƒˆ', color: 'from-amber-500 to-yellow-600' },
            { id: '4-2', type: 'child', name: 'UAT', assignee: 'å±±ç”°', manDays: 4, startDate: '06/06', endDate: '06/15', status: 'not-started', start: 2640, width: 400, label: 'UAT', color: 'from-amber-500 to-yellow-600' },
            { id: '5', type: 'parent', name: 'ãƒªãƒªãƒ¼ã‚¹', assignee: '', manDays: 3, startDate: '06/16', endDate: '06/30', status: 'not-started', start: 3040, width: 600, label: 'ãƒªãƒªãƒ¼ã‚¹', color: 'from-emerald-100 to-green-100', border: 'border-emerald-300', textColor: 'text-emerald-800' },
            { id: '5-1', type: 'child', name: 'æœ¬ç•ªç’°å¢ƒæ§‹ç¯‰', assignee: 'éˆ´æœ¨', manDays: 2, startDate: '06/16', endDate: '06/25', status: 'not-started', start: 3040, width: 400, label: 'æœ¬ç•ªç’°å¢ƒæ§‹ç¯‰', color: 'from-emerald-500 to-green-600' },
            { id: '5-2', type: 'child', name: 'ãƒ‡ãƒ—ãƒ­ã‚¤', assignee: 'éˆ´æœ¨', manDays: 1, startDate: '06/26', endDate: '06/30', status: 'not-started', start: 3440, width: 200, label: 'ãƒ‡ãƒ—ãƒ­ã‚¤', color: 'from-emerald-500 to-green-600' }
        ];

        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæœ¬ä½“ã‚’ç”Ÿæˆ
        function generateGanttBody() {
            var $ganttBody = $('#gantt-body');
            $ganttBody.empty();

            var tasks = TASK_DATA;

            var TASK_ROW_HEIGHT = 44; // ã‚¿ã‚¹ã‚¯è¡Œã®é«˜ã•
            var totalHeight = tasks.length * TASK_ROW_HEIGHT;

            // ä»Šæ—¥ãƒãƒ¼ã‚«ãƒ¼ã®ä½ç½®ã‚’è¨ˆç®—
            var todayPosition = calculateTodayPosition();
            if (todayPosition >= 0) {
                var $todayMarker = $('<div>')
                    .addClass('absolute top-0 w-0.5 bg-amber-500 z-10')
                    .css({
                        'left': (todayPosition + CELL_WIDTH / 2) + 'px',
                        'height': totalHeight + 'px'
                    });
                $ganttBody.append($todayMarker);
            }

            // å…¨æ—¥æ•°ã‚’è¨ˆç®—
            var totalDays = 0;
            $.each(MONTHS_DATA, function(i, m) { totalDays += m.days; });
            var totalWidth = totalDays * CELL_WIDTH;

            $.each(tasks, function(index, task) {
                var rowClass = 'flex items-center task-row border-b ' + (task.type === 'parent' ? 'bg-slate-50 border-slate-200' : 'border-slate-100');
                var $row = $('<div>').addClass(rowClass).css('position', 'relative');

                // èƒŒæ™¯ã‚»ãƒ«ï¼ˆé€±æœ«è‰²ãƒ»ä»Šæ—¥ãƒãƒ¼ã‚«ãƒ¼ç”¨ï¼‰
                var $bgContainer = $('<div>').addClass('flex').css({ 'position': 'absolute', 'left': 0, 'top': 0, 'bottom': 0 });
                $.each(MONTHS_DATA, function(monthIndex, monthData) {
                    for (var day = 1; day <= monthData.days; day++) {
                        var date = new Date(monthData.year, monthData.month - 1, day);
                        var weekday = date.getDay();
                        var isToday = date.getTime() === TODAY.getTime();
                        var isSaturday = weekday === 6;
                        var isSunday = weekday === 0;

                        var cellClass = 'border-r border-slate-100';
                        if (isToday) {
                            cellClass += ' today-marker';
                        } else if (isSunday) {
                            cellClass += ' weekend-sun';
                        } else if (isSaturday) {
                            cellClass += ' weekend-sat';
                        }
                        if (day === monthData.days) {
                            cellClass = cellClass.replace('border-slate-100', 'border-slate-300');
                        }
                        var $cell = $('<div>').addClass(cellClass).css({ 'min-width': CELL_WIDTH + 'px', 'width': CELL_WIDTH + 'px' });
                        $bgContainer.append($cell);
                    }
                });
                $row.append($bgContainer);

                // ã‚¿ã‚¹ã‚¯ãƒãƒ¼ç”¨ã‚³ãƒ³ãƒ†ãƒŠ
                var $container = $('<div>').addClass('relative flex items-center px-1').css({ 'width': totalWidth + 'px', 'height': '100%', 'z-index': 1 });

                if (task.start !== null && task.width > 0) {
                    var barClass = 'task-bar task-bar-draggable bg-gradient-to-r ' + task.color + ' absolute flex items-center';
                    if (task.border) {
                        barClass += ' border-2 ' + task.border;
                    }
                    var $bar = $('<div>')
                        .addClass(barClass)
                        .css({
                            'left': task.start + 'px',
                            'width': task.width + 'px'
                        })
                        .attr('data-task-id', task.id)
                        .html(
                            '<div class="resize-handle resize-left"></div>' +
                            '<span class="text-sm ' + (task.textColor || 'text-white') + ' font-semibold ml-3 pointer-events-none">' + task.label + '</span>' +
                            '<div class="resize-handle resize-right"></div>'
                        );
                    $container.append($bar);
                }

                $row.append($container);
                $ganttBody.append($row);
            });

            // ã‚¿ã‚¹ã‚¯ãƒãƒ¼ã®ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’è¨­å®š
            setupDragHandlers();
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ©ã®è¨­å®š
        function setupDragHandlers() {
            $('.task-bar-draggable').each(function() {
                var $bar = $(this);
                var isDragging = false;
                var isResizing = false;
                var hasMoved = false; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«ç§»å‹•ã—ãŸã‹ã©ã†ã‹
                var resizeDirection = '';
                var startX = 0;
                var startLeft = 0;
                var startWidth = 0;

                $bar.on('mousedown', function(e) {
                    // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ‰ãƒ©ãƒƒã‚°ç„¡åŠ¹
                    if (currentEditMode !== 'edit') return;

                    hasMoved = false;
                    var $target = $(e.target);
                    if ($target.hasClass('resize-handle')) {
                        isResizing = true;
                        resizeDirection = $target.hasClass('resize-left') ? 'left' : 'right';
                    } else {
                        isDragging = true;
                    }
                    startX = e.clientX;
                    startLeft = parseInt($bar.css('left')) || 0;
                    startWidth = parseInt($bar.css('width')) || 0;
                    e.stopPropagation();
                    e.preventDefault();
                });

                // ã‚¿ã‚¹ã‚¯ãƒãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠï¼ˆCtrl+ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠï¼‰
                $bar.on('click', function(e) {
                    if (currentEditMode !== 'edit') return;
                    if (hasMoved) return; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ç„¡è¦–

                    var taskId = $(this).attr('data-task-id');
                    var $bar = $(this);

                    if (e.ctrlKey || e.metaKey) {
                        // Ctrl+ã‚¯ãƒªãƒƒã‚¯: è¤‡æ•°é¸æŠãƒˆã‚°ãƒ«
                        toggleTaskSelection(taskId, $bar);
                    } else {
                        // é€šå¸¸ã‚¯ãƒªãƒƒã‚¯: é¸æŠã‚’ã‚¯ãƒªã‚¢ã—ã¦å˜ä¸€é¸æŠ
                        clearTaskSelection();
                        selectTask(taskId, $bar);
                    }
                    e.stopPropagation();
                });

                $(document).on('mousemove', function(e) {
                    if (!isDragging && !isResizing) return;

                    var diff = e.clientX - startX;
                    if (Math.abs(diff) > 3) hasMoved = true; // å°‘ã—ç§»å‹•ã—ãŸã‚‰ãƒ‰ãƒ©ãƒƒã‚°æ‰±ã„

                    if (isDragging) {
                        var newLeft = startLeft + diff;
                        newLeft = Math.round(newLeft / CELL_WIDTH) * CELL_WIDTH;
                        newLeft = Math.max(0, newLeft);
                        var daysMoved = Math.round(diff / CELL_WIDTH);

                        // é¸æŠã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹å ´åˆã¯å…¨ã¦ä¸€ç·’ã«ç§»å‹•
                        var currentTaskId = $bar.attr('data-task-id');
                        if (selectedTasks.size > 0 && selectedTasks.has(currentTaskId)) {
                            // é¸æŠä¸­ã®ã‚¿ã‚¹ã‚¯å…¨ã¦ã‚’ç§»å‹•
                            selectedTasks.forEach(function(taskId) {
                                var $selectedBar = $('.task-bar[data-task-id="' + taskId + '"]');
                                if ($selectedBar.length) {
                                    var origLeft = $selectedBar.data('drag-start-left');
                                    if (origLeft === undefined) {
                                        origLeft = parseInt($selectedBar.css('left')) || 0;
                                        $selectedBar.data('drag-start-left', origLeft);
                                    }
                                    var selectedNewLeft = origLeft + daysMoved * CELL_WIDTH;
                                    selectedNewLeft = Math.max(0, selectedNewLeft);
                                    $selectedBar.css('left', selectedNewLeft + 'px');
                                }
                            });
                        } else {
                            // å˜ä¸€ã‚¿ã‚¹ã‚¯ã®ç§»å‹•
                            $bar.css('left', newLeft + 'px');
                        }
                    } else if (isResizing) {
                        var currentTaskId = $bar.attr('data-task-id');
                        var daysChange = Math.round(diff / CELL_WIDTH);

                        // è¤‡æ•°é¸æŠæ™‚ã¯å…¨ã¦ä¸€æ‹¬ã§ãƒªã‚µã‚¤ã‚º
                        if (selectedTasks.size > 0 && selectedTasks.has(currentTaskId)) {
                            selectedTasks.forEach(function(taskId) {
                                var $selectedBar = $('.task-bar[data-task-id="' + taskId + '"]');
                                if ($selectedBar.length) {
                                    var origLeft = $selectedBar.data('resize-start-left');
                                    var origWidth = $selectedBar.data('resize-start-width');
                                    if (origLeft === undefined) {
                                        origLeft = parseInt($selectedBar.css('left')) || 0;
                                        origWidth = parseInt($selectedBar.css('width')) || 0;
                                        $selectedBar.data('resize-start-left', origLeft);
                                        $selectedBar.data('resize-start-width', origWidth);
                                    }

                                    if (resizeDirection === 'right') {
                                        // çµ‚äº†æ—¥ã‚’å¤‰æ›´ï¼ˆå¹…ã‚’å¤‰æ›´ï¼‰
                                        var selNewWidth = origWidth + daysChange * CELL_WIDTH;
                                        selNewWidth = Math.max(CELL_WIDTH, selNewWidth);
                                        $selectedBar.css('width', selNewWidth + 'px');
                                    } else {
                                        // é–‹å§‹æ—¥ã‚’å¤‰æ›´ï¼ˆå·¦ç«¯ã¨å¹…ã‚’å¤‰æ›´ï¼‰
                                        var selNewLeft = origLeft + daysChange * CELL_WIDTH;
                                        var selNewWidth = origWidth - daysChange * CELL_WIDTH;
                                        if (selNewWidth >= CELL_WIDTH && selNewLeft >= 0) {
                                            $selectedBar.css({
                                                'left': selNewLeft + 'px',
                                                'width': selNewWidth + 'px'
                                            });
                                        }
                                    }
                                }
                            });
                        } else {
                            // å˜ä¸€ã‚¿ã‚¹ã‚¯ã®ãƒªã‚µã‚¤ã‚º
                            if (resizeDirection === 'right') {
                                var newWidth = startWidth + diff;
                                newWidth = Math.round(newWidth / CELL_WIDTH) * CELL_WIDTH;
                                newWidth = Math.max(CELL_WIDTH, newWidth);
                                $bar.css('width', newWidth + 'px');
                            } else {
                                var newLeft = startLeft + diff;
                                var newWidth = startWidth - diff;
                                newLeft = Math.round(newLeft / CELL_WIDTH) * CELL_WIDTH;
                                newWidth = Math.round(newWidth / CELL_WIDTH) * CELL_WIDTH;
                                if (newWidth >= CELL_WIDTH && newLeft >= 0) {
                                    $bar.css({
                                        'left': newLeft + 'px',
                                        'width': newWidth + 'px'
                                    });
                                }
                            }
                        }
                    }
                });

                $(document).on('mouseup', function() {
                    if ((isDragging || isResizing) && hasMoved) {
                        var currentTaskId = $bar.attr('data-task-id');

                        // è¤‡æ•°é¸æŠã•ã‚Œã¦ã„ã¦ã€æ“ä½œã—ãŸã‚¿ã‚¹ã‚¯ãŒé¸æŠä¸­ã®å ´åˆï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã¾ãŸã¯ãƒªã‚µã‚¤ã‚ºï¼‰
                        if (selectedTasks.size > 0 && selectedTasks.has(currentTaskId)) {
                            // é¸æŠã•ã‚ŒãŸå…¨ã‚¿ã‚¹ã‚¯ã®æ—¥ä»˜ã‚’æ›´æ–°
                            selectedTasks.forEach(function(taskId) {
                                var $selectedBar = $('.task-bar[data-task-id="' + taskId + '"]');
                                if ($selectedBar.length) {
                                    var selNewLeft = parseInt($selectedBar.css('left')) || 0;
                                    var selNewWidth = parseInt($selectedBar.css('width')) || 0;

                                    // æ—¥å˜ä½ã§ã‚¹ãƒŠãƒƒãƒ—
                                    selNewLeft = Math.round(selNewLeft / CELL_WIDTH) * CELL_WIDTH;
                                    selNewWidth = Math.round(selNewWidth / CELL_WIDTH) * CELL_WIDTH;
                                    selNewWidth = Math.max(CELL_WIDTH, selNewWidth);

                                    $selectedBar.css({
                                        'left': selNewLeft + 'px',
                                        'width': selNewWidth + 'px'
                                    });

                                    var selNewStartDate = pixelToDate(selNewLeft);
                                    var selNewEndDate = pixelToDate(selNewLeft + selNewWidth - CELL_WIDTH);

                                    // ã‚¿ã‚¹ã‚¯è¡Œã®æ—¥ä»˜ã‚’æ›´æ–°
                                    updateTaskRowDates(taskId, selNewStartDate, selNewEndDate, selNewLeft, selNewWidth);

                                    // ã‚¿ã‚¹ã‚¯ã®å¤‰æ›´ã‚’ãƒãƒ¼ã‚¯
                                    modifiedTaskIds.add(taskId);
                                    markRowAsModified(taskId);

                                    // å­ã‚¿ã‚¹ã‚¯ã®å ´åˆã€è¦ªã‚¿ã‚¹ã‚¯ã®æ—¥ä»˜ã‚’å†è¨ˆç®—
                                    updateParentTaskDates(taskId);

                                    // é–‹å§‹ä½ç½®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                                    $selectedBar.removeData('drag-start-left');
                                    $selectedBar.removeData('resize-start-left');
                                    $selectedBar.removeData('resize-start-width');
                                }
                            });
                        } else {
                            // å˜ä¸€ã‚¿ã‚¹ã‚¯ã®æ›´æ–°ï¼ˆå¾“æ¥ã®å‡¦ç†ï¼‰
                            var taskId = currentTaskId;
                            var newLeft = parseInt($bar.css('left')) || 0;
                            var newWidth = parseInt($bar.css('width')) || 0;

                            // æ—¥å˜ä½ã§ã‚¹ãƒŠãƒƒãƒ—
                            newLeft = Math.round(newLeft / CELL_WIDTH) * CELL_WIDTH;
                            newWidth = Math.round(newWidth / CELL_WIDTH) * CELL_WIDTH;
                            newWidth = Math.max(CELL_WIDTH, newWidth);

                            // ã‚¹ãƒŠãƒƒãƒ—å¾Œã®ä½ç½®ã‚’é©ç”¨
                            $bar.css({
                                'left': newLeft + 'px',
                                'width': newWidth + 'px'
                            });

                            var newStartDate = pixelToDate(newLeft);
                            var newEndDate = pixelToDate(newLeft + newWidth - CELL_WIDTH);

                            // å…ƒã®æ—¥ä»˜ã‚’è¨ˆç®—
                            var origStartDate = pixelToDate(startLeft);
                            var origEndDate = pixelToDate(startLeft + startWidth - CELL_WIDTH);

                            // å¤‰æ›´ã‚’è¨˜éŒ²ï¼ˆå…ƒã®çŠ¶æ…‹ã‚‚ä¿å­˜ï¼‰
                            recordChange(taskId, 'date_change', {
                                left: newLeft,
                                width: newWidth,
                                startDate: newStartDate,
                                endDate: newEndDate,
                                // å…ƒã«æˆ»ã™ç”¨
                                originalLeft: startLeft,
                                originalWidth: startWidth,
                                originalStartDate: origStartDate,
                                originalEndDate: origEndDate
                            });

                            // ã‚¿ã‚¹ã‚¯è¡Œã®æ—¥ä»˜ã‚’æ›´æ–°ï¼ˆã‚¿ã‚¹ã‚¯ãƒãƒ¼ã®ä½ç½®ã‚‚å«ã‚ã¦ï¼‰
                            updateTaskRowDates(taskId, newStartDate, newEndDate, newLeft, newWidth);

                            // ã‚¿ã‚¹ã‚¯ã®å¤‰æ›´ã‚’ãƒãƒ¼ã‚¯
                            modifiedTaskIds.add(taskId);
                            markRowAsModified(taskId);

                            // å­ã‚¿ã‚¹ã‚¯ã®å ´åˆã€è¦ªã‚¿ã‚¹ã‚¯ã®æ—¥ä»˜ã‚’å†è¨ˆç®—
                            updateParentTaskDates(taskId);
                        }
                    }
                    isDragging = false;
                    isResizing = false;
                });
            });
        }

        // jQuery Ready
        $(function() {
            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‹é–‰æ©Ÿèƒ½
            var $sidebarModal = $('#sidebar-modal');
            var $sidebarOverlay = $('#sidebar-overlay');
            var $menuToggle = $('#menu-toggle');

            function toggleSidebarModal() {
                $sidebarModal.toggleClass('show');
                $sidebarOverlay.toggleClass('show');
            }

            function closeSidebarModal() {
                $sidebarModal.removeClass('show');
                $sidebarOverlay.removeClass('show');
            }

            // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰
            $menuToggle.on('click', function() {
                toggleSidebarModal();
            });

            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            $sidebarOverlay.on('click', function() {
                closeSidebarModal();
            });

            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            $('#sidebar-close').on('click', function() {
                closeSidebarModal();
            });

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸã®è¨­å®š
            var $taskPanel = $('#task-panel');
            var $ganttScroll = $('#gantt-scroll');
            var $ganttHeaderScroll = $('#gantt-header-scroll');

            // ã‚¿ã‚¹ã‚¯ãƒ‘ãƒãƒ«ã¨ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸï¼ˆå¾ªç’°é˜²æ­¢ä»˜ãï¼‰
            var isSyncingScroll = false;
            if ($taskPanel.length && $ganttScroll.length) {
                $taskPanel.on('scroll', function() {
                    if (isSyncingScroll) return;
                    isSyncingScroll = true;
                    $ganttScroll.scrollTop($(this).scrollTop());
                    setTimeout(function() { isSyncingScroll = false; }, 10);
                });
                $ganttScroll.on('scroll', function() {
                    if (isSyncingScroll) return;
                    isSyncingScroll = true;
                    $taskPanel.scrollTop($(this).scrollTop());
                    // æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚‚ãƒ˜ãƒƒãƒ€ãƒ¼ã«åæ˜ 
                    if ($ganttHeaderScroll.length) {
                        $ganttHeaderScroll.scrollLeft($(this).scrollLeft());
                    }
                    setTimeout(function() { isSyncingScroll = false; }, 10);
                });
            }

            // ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            var isScrollDragging = false;
            var scrollStartX = 0;
            var scrollStartY = 0;
            var scrollStartScrollLeft = 0;
            var scrollStartScrollTop = 0;

            if ($ganttScroll.length) {
                $ganttScroll.on('mousedown', function(e) {
                    if ($(e.target).closest('.task-bar-draggable').length) { return; }
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ç©ºç™½ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯é¸æŠè§£é™¤ï¼ˆCtrlã‚­ãƒ¼ãªã—ã®å ´åˆï¼‰
                    if (currentEditMode === 'edit' && !e.ctrlKey && !e.metaKey) {
                        clearTaskSelection();
                    }
                    isScrollDragging = true;
                    scrollStartX = e.clientX;
                    scrollStartY = e.clientY;
                    scrollStartScrollLeft = $ganttScroll.scrollLeft();
                    scrollStartScrollTop = $ganttScroll.scrollTop();
                    $ganttScroll.css('cursor', 'grabbing');
                    e.preventDefault();
                });

                $(document).on('mousemove', function(e) {
                    if (!isScrollDragging) return;
                    var dx = e.clientX - scrollStartX;
                    var dy = e.clientY - scrollStartY;
                    $ganttScroll.scrollLeft(scrollStartScrollLeft - dx);
                    $ganttScroll.scrollTop(scrollStartScrollTop - dy);
                });

                $(document).on('mouseup', function() {
                    if (isScrollDragging) {
                        isScrollDragging = false;
                        $ganttScroll.css('cursor', 'grab');
                    }
                });

                $ganttScroll.css('cursor', 'grab');
            }

            // æ¤œç´¢ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            $('#search-toggle').on('click', function() {
                $('#search-panel').toggleClass('show');
            });

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é–‹é–‰
            var $userMenuTrigger = $('#user-menu-trigger');
            var $userMenuDropdown = $('#user-menu-dropdown');
            var $userMenuArrow = $('#user-menu-arrow');

            $userMenuTrigger.on('click', function(e) {
                e.stopPropagation();
                $userMenuDropdown.toggleClass('show');
                var isOpen = $userMenuDropdown.hasClass('show');
                $userMenuArrow.css('transform', isOpen ? 'rotate(180deg)' : 'rotate(0deg)');
            });

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            $(document).on('click', function(e) {
                if (!$userMenuTrigger.is(e.target) && !$userMenuTrigger.has(e.target).length &&
                    !$userMenuDropdown.is(e.target) && !$userMenuDropdown.has(e.target).length) {
                    $userMenuDropdown.removeClass('show');
                    $userMenuArrow.css('transform', 'rotate(0deg)');
                }
            });

            // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            var $contextMenu = $('#context-menu');

            $('.task-row-item').on('contextmenu', function(e) {
                e.preventDefault();
                // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ãªã„
                if (currentEditMode !== 'edit') return;

                selectedTaskRow = this;

                $contextMenu.css({
                    'left': e.pageX + 'px',
                    'top': e.pageY + 'px'
                }).addClass('show');
            });

            $(document).on('click', function() {
                $contextMenu.removeClass('show');
            });

            // é€²æ—ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤è¡¨ç¤º
            $('#modal-progress').on('input', function() {
                $('#modal-progress-value').text($(this).val() + '%');
            });

            // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeTaskModal();
                }
            });

            // åˆæœŸåŒ–
            MONTHS_DATA = generateMonthsData();

            // TASK_DATAã®æ—¥ä»˜ã‚’taskDataã«åŒæœŸï¼ˆã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã¨ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã®æ—¥ä»˜ã‚’ä¸€è‡´ã•ã›ã‚‹ï¼‰
            syncDatesFromGanttData();

            generateMonthSelect();
            generateCalendarHeaders();
            generateTaskList();
            generateGanttBody();

            // è¦ªãƒ»å·¥ç¨‹ã®æ—¥ä»˜ã‚’å­ã‚¿ã‚¹ã‚¯ã‹ã‚‰å†è¨ˆç®—ï¼ˆåˆæœŸåŒ–æ™‚ã¯å¤‰æ›´ãƒãƒ¼ã‚¯ã—ãªã„ï¼‰
            recalculateAllParentDates(false);


            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ç„¡åŠ¹åŒ–ï¼‰
            disableEditMode();

            // è²¼ã‚Šä»˜ã‘ã‚¨ãƒªã‚¢ã®ç›£è¦–
            $('#paste-area').on('input', function() {
                var text = $(this).val().trim();
                if (text) {
                    parseClipboardData(text);
                }
            });
        });

        // äºˆå®š/å®Ÿç¸¾ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function switchMode(mode) {
            currentMode = mode;

            $('#btn-plan').toggleClass('active', mode === 'plan');
            $('#btn-actual').toggleClass('active', mode === 'actual');

            $('#header-plan').css('display', mode === 'plan' ? 'flex' : 'none');
            $('#header-actual').css('display', mode === 'actual' ? 'flex' : 'none');

            $('.plan-data').css('display', mode === 'plan' ? 'inline' : 'none');
            $('.actual-data').css('display', mode === 'actual' ? 'inline' : 'none');
        }

        // ç¾åœ¨ã®ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
        var currentEditMode = 'view';

        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ/ã‚¿ã‚¹ã‚¯åˆ‡ã‚Šæ›¿ãˆ
        function switchView(view) {
            $('#btn-gantt').toggleClass('active', view === 'gantt');
            $('#btn-task').toggleClass('active', view === 'task');

            if (view === 'task') {
                // ã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒšãƒ¼ã‚¸ã¸é·ç§»
                location.href = '../tasks/index.html';
            }
            // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã¯ãã®ã¾ã¾ï¼ˆç¾åœ¨ã®ãƒšãƒ¼ã‚¸ï¼‰
        }

        // è¡¨ç¤º/ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function switchEditMode(mode) {
            currentEditMode = mode;

            $('#btn-view-mode').toggleClass('active', mode === 'view');
            $('#btn-edit-mode').toggleClass('active', mode === 'edit');

            if (mode === 'edit') {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã€ã‚¿ã‚¹ã‚¯ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«
                enableEditMode();
            } else {
                // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼šãƒ‰ãƒ©ãƒƒã‚°ä¸å¯ã€ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹
                disableEditMode();
            }
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–
        function enableEditMode() {
            // bodyã«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            $('body').addClass('edit-mode');

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
            showEditModeIndicator();
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ç„¡åŠ¹åŒ–
        function disableEditMode() {
            // é¸æŠã‚’ã‚¯ãƒªã‚¢
            clearTaskSelection();
            // bodyã‹ã‚‰ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            $('body').removeClass('edit-mode');

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼éè¡¨ç¤º
            hideEditModeIndicator();
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
        function showEditModeIndicator() {
            $('#view-mode-indicator').addClass('hidden');
            $('#edit-mode-indicator').removeClass('hidden');
            $('#save-changes-btn').removeClass('hidden');
            $('#cancel-changes-btn').removeClass('hidden');
            $('#undo-btn').removeClass('hidden');
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼éè¡¨ç¤ºï¼ˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆï¼‰
        function hideEditModeIndicator() {
            $('#edit-mode-indicator').addClass('hidden');
            $('#view-mode-indicator').removeClass('hidden');
            $('#save-changes-btn').addClass('hidden');
            $('#cancel-changes-btn').addClass('hidden');
            $('#undo-btn').addClass('hidden');
        }

        // å¤‰æ›´ç®¡ç†ç”¨
        var pendingChanges = [];
        var hasUnsavedChanges = false;

        // å¤‰æ›´ã‚’è¨˜éŒ²
        function recordChange(taskId, changeType, data) {
            pendingChanges.push({
                taskId: taskId,
                changeType: changeType,
                data: data,
                timestamp: new Date()
            });
            hasUnsavedChanges = true;
            updateSaveButtonState();
        }

        // ä¿å­˜ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
        function updateSaveButtonState() {
            var $btn = $('#save-changes-btn');
            if (hasUnsavedChanges) {
                $btn.addClass('animate-pulse');
            } else {
                $btn.removeClass('animate-pulse');
            }
        }

        // å…¨å¤‰æ›´ã‚’ä¿å­˜
        function saveAllChanges() {
            if (!hasUnsavedChanges) {
                alert('å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯APIã«é€ä¿¡
            console.log('ä¿å­˜ã™ã‚‹å¤‰æ›´:', pendingChanges);
            alert('å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ï¼ˆ' + pendingChanges.length + 'ä»¶ï¼‰');

            // å¤‰æ›´ã‚’ã‚¯ãƒªã‚¢
            pendingChanges = [];
            hasUnsavedChanges = false;
            modifiedTaskIds.clear();

            // å¤‰æ›´æ¸ˆã¿ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤
            $('.task-row-modified').removeClass('task-row-modified');

            updateSaveButtonState();

            // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
            disableEditMode();
        }

        // æœ€å¾Œã®å¤‰æ›´ã‚’å…ƒã«æˆ»ã™
        function undoLastChange() {
            if (pendingChanges.length === 0) {
                alert('å…ƒã«æˆ»ã™å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            var lastChange = pendingChanges.pop();
            console.log('å…ƒã«æˆ»ã™å¤‰æ›´:', lastChange);

            if (lastChange.changeType === 'date_change') {
                // ã‚¿ã‚¹ã‚¯ãƒãƒ¼ã®ä½ç½®ã‚’å…ƒã«æˆ»ã™
                var $bar = $('.task-bar[data-task-id="' + lastChange.taskId + '"]');
                if ($bar.length && lastChange.data.originalLeft !== undefined) {
                    $bar.css({
                        'left': lastChange.data.originalLeft + 'px',
                        'width': lastChange.data.originalWidth + 'px'
                    });
                    // ã‚¿ã‚¹ã‚¯è¡Œã®æ—¥ä»˜ã‚‚å…ƒã«æˆ»ã™ï¼ˆã‚¿ã‚¹ã‚¯ãƒãƒ¼ã®ä½ç½®ã‚‚å«ã‚ã¦ï¼‰
                    updateTaskRowDates(lastChange.taskId, lastChange.data.originalStartDate, lastChange.data.originalEndDate, lastChange.data.originalLeft, lastChange.data.originalWidth);
                }
            }
            // task_edit ã‚„ task_add ã®å ´åˆã¯ã€ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆå†ç”ŸæˆãŒå¿…è¦ãªã®ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¨åŒã˜å‡¦ç†

            // å¤‰æ›´ãŒãªããªã£ãŸå ´åˆ
            if (pendingChanges.length === 0) {
                hasUnsavedChanges = false;
            }
            updateSaveButtonState();
        }

        // å…¨å¤‰æ›´ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelAllChanges() {
            if (!hasUnsavedChanges) {
                alert('å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            if (!confirm('å…¨ã¦ã®å¤‰æ›´ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            // å…¨ã¦ã®å¤‰æ›´ã‚’å…ƒã«æˆ»ã™ï¼ˆé€†é †ï¼‰
            while (pendingChanges.length > 0) {
                var change = pendingChanges.pop();
                if (change.changeType === 'date_change') {
                    var $bar = $('.task-bar[data-task-id="' + change.taskId + '"]');
                    if ($bar.length && change.data.originalLeft !== undefined) {
                        $bar.css({
                            'left': change.data.originalLeft + 'px',
                            'width': change.data.originalWidth + 'px'
                        });
                        updateTaskRowDates(change.taskId, change.data.originalStartDate, change.data.originalEndDate, change.data.originalLeft, change.data.originalWidth);
                    }
                }
            }

            // å¤‰æ›´ã‚’ã‚¯ãƒªã‚¢
            pendingChanges = [];
            hasUnsavedChanges = false;
            updateSaveButtonState();
            console.log('å…¨ã¦ã®å¤‰æ›´ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');

            // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
            switchEditMode('view');
        }

        // ãƒ”ã‚¯ã‚»ãƒ«ä½ç½®ã‹ã‚‰æ—¥ä»˜ã‚’è¨ˆç®—
        function pixelToDate(pixelLeft) {
            var dayIndex = Math.floor(pixelLeft / CELL_WIDTH);
            var accumulatedDays = 0;

            for (var i = 0; i < MONTHS_DATA.length; i++) {
                if (accumulatedDays + MONTHS_DATA[i].days > dayIndex) {
                    var day = dayIndex - accumulatedDays + 1;
                    return new Date(MONTHS_DATA[i].year, MONTHS_DATA[i].month - 1, day);
                }
                accumulatedDays += MONTHS_DATA[i].days;
            }
            return null;
        }

        // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆMM/DDï¼‰
        function formatDateShort(date) {
            if (!date) return '-';
            var month = ('0' + (date.getMonth() + 1)).slice(-2);
            var day = ('0' + date.getDate()).slice(-2);
            return month + '/' + day;
        }

        // ã‚¿ã‚¹ã‚¯è¡Œã®æ—¥ä»˜ã‚’æ›´æ–°
        function updateTaskRowDates(taskId, startDate, endDate, newLeft, newWidth) {
            var $row = $('.task-row-item[data-task="' + taskId + '"]');
            var formattedStart = formatDateShort(startDate);
            var formattedEnd = formatDateShort(endDate);

            if ($row.length) {
                // .plan-data: eq(0)=å·¥æ•°, eq(1)=åŸä¾¡, eq(2)=é–‹å§‹æ—¥, eq(3)=çµ‚äº†æ—¥
                $row.find('.plan-data').eq(2).text(formattedStart); // é–‹å§‹æ—¥
                $row.find('.plan-data').eq(3).text(formattedEnd);   // çµ‚äº†æ—¥
            }

            // TASK_DATAã‚‚æ›´æ–°
            for (var i = 0; i < TASK_DATA.length; i++) {
                if (TASK_DATA[i].id === taskId) {
                    TASK_DATA[i].startDate = formattedStart;
                    TASK_DATA[i].endDate = formattedEnd;
                    // ã‚¿ã‚¹ã‚¯ãƒãƒ¼ã®ä½ç½®ã‚‚æ›´æ–°
                    if (newLeft !== undefined) {
                        TASK_DATA[i].start = newLeft;
                    }
                    if (newWidth !== undefined) {
                        TASK_DATA[i].width = newWidth;
                    }
                    break;
                }
            }

            // taskDataã‚‚æ›´æ–°ï¼ˆè¦ªã‚¿ã‚¹ã‚¯æ—¥ä»˜è¨ˆç®—ç”¨ï¼‰
            var task = taskData.find(function(t) { return t.id === taskId; });
            if (task) {
                task.planStart = formattedStart;
                task.planEnd = formattedEnd;
            }
        }

        // å­ã‚¿ã‚¹ã‚¯ã®å¤‰æ›´æ™‚ã«è¦ªã‚¿ã‚¹ã‚¯ã®æ—¥ä»˜ã‚’æ›´æ–°
        function updateParentTaskDates(childTaskId) {
            var childTask = taskData.find(function(t) { return t.id === childTaskId; });
            if (!childTask || childTask.type === 'parent') {
                return;
            }

            // è¦ªã‚¿ã‚¹ã‚¯IDã‚’å–å¾—ï¼ˆä¾‹: '3-1-1' â†’ '3-1' â†’ '3'ï¼‰
            var parentId = getParentTaskId(childTaskId);
            if (!parentId) return;

            var parentTask = taskData.find(function(t) { return t.id === parentId; });
            if (!parentTask) return;

            // è¦ªã‚¿ã‚¹ã‚¯ã®å­ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’å–å¾—
            var childTasks = taskData.filter(function(t) {
                return t.id !== parentId && t.id.indexOf(parentId + '-') === 0 && t.id.split('-').length === parentId.split('-').length + 1;
            });

            if (childTasks.length === 0) return;

            // å­ã‚¿ã‚¹ã‚¯ã®æœ€æ—©é–‹å§‹æ—¥ã¨æœ€é…çµ‚äº†æ—¥ã‚’è¨ˆç®—ï¼ˆäºˆå®šãƒ»å®Ÿç¸¾ä¸¡æ–¹ï¼‰
            var planResult = calculateDateRange(childTasks, 'plan');
            var actualResult = calculateDateRange(childTasks, 'actual');

            // äºˆå®šæ—¥ä»˜ã‚’æ›´æ–°
            if (planResult.earliest && planResult.latest) {
                var newPlanStart = formatDateForDisplay(planResult.earliest);
                var newPlanEnd = formatDateForDisplay(planResult.latest);
                parentTask.planStart = newPlanStart;
                parentTask.planEnd = newPlanEnd;
            }

            // å®Ÿç¸¾æ—¥ä»˜ã‚’æ›´æ–°
            if (actualResult.earliest) {
                parentTask.actualStart = formatDateForDisplay(actualResult.earliest);
            }
            if (actualResult.latest && actualResult.allCompleted) {
                parentTask.actualEnd = formatDateForDisplay(actualResult.latest);
            } else {
                parentTask.actualEnd = '-';
            }

            // ç”»é¢ä¸Šã®è¡¨ç¤ºã‚’æ›´æ–°
            updateTaskRowDisplay(parentId, parentTask);

            // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®ãƒãƒ¼ã‚‚æ›´æ–°
            if (planResult.earliest && planResult.latest) {
                updateParentGanttBar(parentId, planResult.earliest, planResult.latest);
            }

            // å¤‰æ›´ã‚’ãƒãƒ¼ã‚¯
            modifiedTaskIds.add(parentId);
            markRowAsModified(parentId);

            // ã•ã‚‰ã«ä¸Šä½ã®è¦ªãŒã‚ã‚‹å ´åˆã¯å†å¸°çš„ã«æ›´æ–°
            updateParentTaskDates(parentId);

            // å·¥ç¨‹ï¼ˆæœ€ä¸Šä½è¦ªï¼‰ã®æ›´æ–°
            updateProcessDates(childTaskId);
        }

        // æ—¥ä»˜ç¯„å›²ã‚’è¨ˆç®—ï¼ˆäºˆå®š/å®Ÿç¸¾å…±é€šï¼‰
        function calculateDateRange(tasks, type) {
            var earliest = null;
            var latest = null;
            var allCompleted = true;

            tasks.forEach(function(task) {
                var startStr = type === 'plan' ? task.planStart : task.actualStart;
                var endStr = type === 'plan' ? task.planEnd : task.actualEnd;

                var startDate = parseDisplayDate(startStr);
                var endDate = parseDisplayDate(endStr);

                if (startDate && (!earliest || startDate < earliest)) {
                    earliest = startDate;
                }
                if (endDate && (!latest || endDate > latest)) {
                    latest = endDate;
                }

                // å®Ÿç¸¾ã®å ´åˆã€å…¨ã¦å®Œäº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (type === 'actual' && (!endStr || endStr === '-')) {
                    allCompleted = false;
                }
            });

            return { earliest: earliest, latest: latest, allCompleted: allCompleted };
        }

        // å·¥ç¨‹ã®æ—¥ä»˜ã‚’æ›´æ–°ï¼ˆé…ä¸‹ã®å…¨ã‚¿ã‚¹ã‚¯ã‹ã‚‰è¨ˆç®—ï¼‰
        function updateProcessDates(taskId) {
            // å·¥ç¨‹IDï¼ˆæœ€ä¸Šä½ï¼‰ã‚’å–å¾—
            var processId = taskId.split('-')[0];
            var processTask = taskData.find(function(t) { return t.id === processId && t.type === 'parent'; });
            if (!processTask) return;

            // å·¥ç¨‹é…ä¸‹ã®å…¨ã‚¿ã‚¹ã‚¯ï¼ˆå­ãƒ»å­«ï¼‰ã‚’å–å¾—
            var allChildTasks = taskData.filter(function(t) {
                return t.id !== processId && t.id.indexOf(processId + '-') === 0;
            });

            if (allChildTasks.length === 0) return;

            // æœ€æ—©é–‹å§‹æ—¥ã¨æœ€é…çµ‚äº†æ—¥ã‚’è¨ˆç®—
            var planResult = calculateDateRange(allChildTasks, 'plan');
            var actualResult = calculateDateRange(allChildTasks, 'actual');

            // äºˆå®šæ—¥ä»˜ã‚’æ›´æ–°
            if (planResult.earliest && planResult.latest) {
                processTask.planStart = formatDateForDisplay(planResult.earliest);
                processTask.planEnd = formatDateForDisplay(planResult.latest);
            }

            // å®Ÿç¸¾æ—¥ä»˜ã‚’æ›´æ–°
            if (actualResult.earliest) {
                processTask.actualStart = formatDateForDisplay(actualResult.earliest);
            }
            if (actualResult.latest && actualResult.allCompleted) {
                processTask.actualEnd = formatDateForDisplay(actualResult.latest);
            } else {
                processTask.actualEnd = '-';
            }

            // ç”»é¢ä¸Šã®è¡¨ç¤ºã‚’æ›´æ–°
            updateTaskRowDisplay(processId, processTask);

            // ã‚¬ãƒ³ãƒˆãƒãƒ¼ã‚‚æ›´æ–°
            if (planResult.earliest && planResult.latest) {
                updateParentGanttBar(processId, planResult.earliest, planResult.latest);
            }

            modifiedTaskIds.add(processId);
            markRowAsModified(processId);
        }

        // ã‚¿ã‚¹ã‚¯è¡Œã®è¡¨ç¤ºã‚’æ›´æ–°
        function updateTaskRowDisplay(taskId, task) {
            var $row = $('.task-row-item[data-task="' + taskId + '"]');
            if (!$row.length) return;

            // äºˆå®šãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
            $row.find('.plan-data').eq(2).text(task.planStart || '-');
            $row.find('.plan-data').eq(3).text(task.planEnd || '-');
        }

        // å…¨ã‚¿ã‚¹ã‚¯ã®è¦ªãƒ»å·¥ç¨‹æ—¥ä»˜ã‚’å†è¨ˆç®—
        function recalculateAllParentDates(markAsModified) {
            // å­«ã‚¿ã‚¹ã‚¯ â†’ å­ã‚¿ã‚¹ã‚¯ â†’ è¦ªã‚¿ã‚¹ã‚¯ã®é †ã§æ›´æ–°
            var grandchildTasks = taskData.filter(function(t) { return t.type === 'grandchild'; });
            var processedParents = new Set();

            grandchildTasks.forEach(function(task) {
                var parentId = getParentTaskId(task.id);
                if (parentId && !processedParents.has(parentId)) {
                    processedParents.add(parentId);
                    updateParentTaskDatesById(parentId, markAsModified);
                }
            });

            // å­ã‚¿ã‚¹ã‚¯ã‹ã‚‰å·¥ç¨‹ã‚’æ›´æ–°
            var childTasks = taskData.filter(function(t) { return t.type === 'child'; });
            var processedProcesses = new Set();

            childTasks.forEach(function(task) {
                var processId = task.id.split('-')[0];
                if (!processedProcesses.has(processId)) {
                    processedProcesses.add(processId);
                    updateProcessDatesById(processId, markAsModified);
                }
            });
        }

        // IDã‚’æŒ‡å®šã—ã¦è¦ªã‚¿ã‚¹ã‚¯ã®æ—¥ä»˜ã‚’æ›´æ–°
        function updateParentTaskDatesById(parentId, markAsModified) {
            var parentTask = taskData.find(function(t) { return t.id === parentId; });
            if (!parentTask) return;

            var childTasks = taskData.filter(function(t) {
                return t.id !== parentId && t.id.indexOf(parentId + '-') === 0 && t.id.split('-').length === parentId.split('-').length + 1;
            });

            if (childTasks.length === 0) return;

            var planResult = calculateDateRange(childTasks, 'plan');
            var actualResult = calculateDateRange(childTasks, 'actual');

            if (planResult.earliest && planResult.latest) {
                parentTask.planStart = formatDateForDisplay(planResult.earliest);
                parentTask.planEnd = formatDateForDisplay(planResult.latest);
            }

            if (actualResult.earliest) {
                parentTask.actualStart = formatDateForDisplay(actualResult.earliest);
            }
            if (actualResult.latest && actualResult.allCompleted) {
                parentTask.actualEnd = formatDateForDisplay(actualResult.latest);
            } else {
                parentTask.actualEnd = '-';
            }

            updateTaskRowDisplay(parentId, parentTask);

            if (planResult.earliest && planResult.latest) {
                updateParentGanttBar(parentId, planResult.earliest, planResult.latest);
            }

            if (markAsModified) {
                modifiedTaskIds.add(parentId);
                markRowAsModified(parentId);
            }
        }

        // å·¥ç¨‹IDã‚’æŒ‡å®šã—ã¦æ—¥ä»˜ã‚’æ›´æ–°
        function updateProcessDatesById(processId, markAsModified) {
            var processTask = taskData.find(function(t) { return t.id === processId && t.type === 'parent'; });
            if (!processTask) return;

            var allChildTasks = taskData.filter(function(t) {
                return t.id !== processId && t.id.indexOf(processId + '-') === 0;
            });

            if (allChildTasks.length === 0) return;

            var planResult = calculateDateRange(allChildTasks, 'plan');
            var actualResult = calculateDateRange(allChildTasks, 'actual');

            if (planResult.earliest && planResult.latest) {
                processTask.planStart = formatDateForDisplay(planResult.earliest);
                processTask.planEnd = formatDateForDisplay(planResult.latest);
            }

            if (actualResult.earliest) {
                processTask.actualStart = formatDateForDisplay(actualResult.earliest);
            }
            if (actualResult.latest && actualResult.allCompleted) {
                processTask.actualEnd = formatDateForDisplay(actualResult.latest);
            } else {
                processTask.actualEnd = '-';
            }

            updateTaskRowDisplay(processId, processTask);

            if (planResult.earliest && planResult.latest) {
                updateParentGanttBar(processId, planResult.earliest, planResult.latest);
            }

            if (markAsModified) {
                modifiedTaskIds.add(processId);
                markRowAsModified(processId);
            }
        }

        // è¦ªã‚¿ã‚¹ã‚¯IDã‚’å–å¾—
        function getParentTaskId(taskId) {
            var parts = taskId.split('-');
            if (parts.length <= 1) return null;
            parts.pop();
            return parts.join('-');
        }

        // è¦ªã‚¿ã‚¹ã‚¯ã®ã‚¬ãƒ³ãƒˆãƒãƒ¼ã‚’æ›´æ–°
        function updateParentGanttBar(parentId, startDate, endDate) {
            var $bar = $('.task-bar[data-task-id="' + parentId + '"]');
            if (!$bar.length) return;

            // é–‹å§‹ä½ç½®ã¨å¹…ã‚’è¨ˆç®—
            var startPos = calculateDatePosition(startDate);
            var endPos = calculateDatePosition(endDate);
            var newWidth = endPos - startPos + CELL_WIDTH;

            $bar.css({
                'left': startPos + 'px',
                'width': newWidth + 'px'
            });

            // TASK_DATAã‚‚æ›´æ–°
            for (var i = 0; i < TASK_DATA.length; i++) {
                if (TASK_DATA[i].id === parentId) {
                    TASK_DATA[i].start = startPos;
                    TASK_DATA[i].width = newWidth;
                    TASK_DATA[i].startDate = formatDateForDisplay(startDate);
                    TASK_DATA[i].endDate = formatDateForDisplay(endDate);
                    break;
                }
            }
        }

        // æ—¥ä»˜ã‹ã‚‰ãƒ”ã‚¯ã‚»ãƒ«ä½ç½®ã‚’è¨ˆç®—
        function calculateDatePosition(date) {
            var position = 0;
            var targetYear = date.getFullYear();
            var targetMonth = date.getMonth() + 1;
            var targetDay = date.getDate();

            for (var i = 0; i < MONTHS_DATA.length; i++) {
                if (MONTHS_DATA[i].year === targetYear && MONTHS_DATA[i].month === targetMonth) {
                    position += (targetDay - 1) * CELL_WIDTH;
                    return position;
                }
                position += MONTHS_DATA[i].days * CELL_WIDTH;
            }
            return position;
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ãƒ­ã‚°ã‚¢ã‚¦ãƒˆAPIã‚’å‘¼ã³å‡ºã—
                alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
                // location.href = '/login';
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        var modalMode = 'add'; // 'add', 'edit', or 'view'
        var modalAction = ''; // 'above', 'below', 'child', 'edit', 'view'

        function openTaskModal(action) {
            $('#context-menu').removeClass('show');
            modalAction = action;

            var $modal = $('#task-modal');
            var $modalTitle = $('#modal-title');

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            $('#task-form')[0].reset();

            // å‚ç…§ãƒ¢ãƒ¼ãƒ‰/ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
            var isViewMode = (action === 'view');
            setModalReadOnly(isViewMode);

            if (action === 'view') {
                modalMode = 'view';
                $modalTitle.text('ã‚¿ã‚¹ã‚¯è©³ç´°');
                $('#multi-create-section').addClass('hidden');

                // é¸æŠã—ãŸã‚¿ã‚¹ã‚¯ã®æƒ…å ±ã‚’å–å¾—
                var taskId = selectedTaskRow ? $(selectedTaskRow).data('task') : null;
                if (taskId) {
                    var task = taskData.find(function(t) { return t.id === taskId; });
                    if (task) {
                        $('#modal-task-name').val(task.name);
                        $('#modal-progress').val(task.progress || 0);
                        $('#modal-progress-num').val(task.progress || 0);
                        $('#modal-cost').val(task.cost ? task.cost * 1000 : 0);
                        updateCostActual();
                    }

                    var taskIdStr = String(taskId);
                    if (taskIdStr.indexOf('1') === 0) $('#modal-process').val('1');
                    else if (taskIdStr.indexOf('2') === 0) $('#modal-process').val('2');
                    else if (taskIdStr.indexOf('3') === 0) $('#modal-process').val('3');
                    else if (taskIdStr.indexOf('4') === 0) $('#modal-process').val('4');
                    else if (taskIdStr.indexOf('5') === 0) $('#modal-process').val('5');
                }
            } else if (action === 'edit') {
                modalMode = 'edit';
                $modalTitle.text('ã‚¿ã‚¹ã‚¯ç·¨é›†');
                $('#multi-create-section').addClass('hidden');

                // é¸æŠã—ãŸã‚¿ã‚¹ã‚¯ã®æƒ…å ±ã‚’å–å¾—
                var taskId = selectedTaskRow ? $(selectedTaskRow).data('task') : null;
                if (taskId) {
                    var task = taskData.find(function(t) { return t.id === taskId; });
                    if (task) {
                        $('#modal-task-name').val(task.name);
                        $('#modal-progress').val(task.progress || 0);
                        $('#modal-progress-num').val(task.progress || 0);
                        $('#modal-cost').val(task.cost ? task.cost * 1000 : 0);
                        updateCostActual();
                    }

                    // å·¥ç¨‹ã‚’æ¨å®šã—ã¦ã‚»ãƒƒãƒˆ
                    var taskIdStr = String(taskId);
                    if (taskIdStr.indexOf('1') === 0) $('#modal-process').val('1');
                    else if (taskIdStr.indexOf('2') === 0) $('#modal-process').val('2');
                    else if (taskIdStr.indexOf('3') === 0) $('#modal-process').val('3');
                    else if (taskIdStr.indexOf('4') === 0) $('#modal-process').val('4');
                    else if (taskIdStr.indexOf('5') === 0) $('#modal-process').val('5');
                }
            } else {
                modalMode = 'add';

                if (action === 'above') {
                    $modalTitle.text('ã‚¿ã‚¹ã‚¯è¿½åŠ ï¼ˆä¸Šã«æŒ¿å…¥ï¼‰');
                } else if (action === 'below') {
                    $modalTitle.text('ã‚¿ã‚¹ã‚¯è¿½åŠ ï¼ˆä¸‹ã«æŒ¿å…¥ï¼‰');
                } else if (action === 'child') {
                    $modalTitle.text('å­ã‚¿ã‚¹ã‚¯è¿½åŠ ');
                }

                // æ–°è¦è¿½åŠ æ™‚ã¯åŸä¾¡ã‚’ãƒªã‚»ãƒƒãƒˆ
                $('#modal-progress-num').val(0);
                $('#modal-cost').val('');
                $('#modal-cost-actual').text('Â¥0');

                // åŒæ™‚ä½œæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                resetMultiCreateSection();

                // è¦ªã‚¿ã‚¹ã‚¯ã®å·¥ç¨‹ã‚’å¼•ãç¶™ã
                var taskId = selectedTaskRow ? $(selectedTaskRow).data('task') : null;
                var isDesignProcess = false;
                if (taskId) {
                    var taskIdStr = String(taskId);
                    if (taskIdStr.indexOf('1') === 0) $('#modal-process').val('1');
                    else if (taskIdStr.indexOf('2') === 0) {
                        $('#modal-process').val('2');
                        isDesignProcess = true;
                    }
                    else if (taskIdStr.indexOf('3') === 0) $('#modal-process').val('3');
                    else if (taskIdStr.indexOf('4') === 0) $('#modal-process').val('4');
                    else if (taskIdStr.indexOf('5') === 0) $('#modal-process').val('5');
                }

                // è¨­è¨ˆå·¥ç¨‹ã®å ´åˆã®ã¿åŒæ™‚ä½œæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                if (isDesignProcess) {
                    $('#multi-create-section').removeClass('hidden');
                } else {
                    $('#multi-create-section').addClass('hidden');
                }
            }

            // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            loadTaskHistory(taskId);

            // å±¥æ­´å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
            closeHistoryEntryForm();

            // å±¥æ­´ãƒ•ã‚©ãƒ¼ãƒ ã®é€²æ—ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼åˆæœŸåŒ–
            $('#history-progress').off('input').on('input', function() {
                $('#history-progress-value').text($(this).val() + '%');
            });

            $modal.addClass('show').removeClass('hidden');
        }

        function closeTaskModal() {
            $('#task-modal').removeClass('show').addClass('hidden');
            currentEditingTaskId = null;
        }

        // åŒæ™‚ä½œæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è©³ç´°è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleMultiCreateDetail(type) {
            var isChecked = $('#create-' + type + '-task').is(':checked');
            var $detail = $('#' + type + '-detail');
            if (isChecked) {
                $detail.removeClass('hidden');
            } else {
                $detail.addClass('hidden');
            }
        }

        // åŒæ™‚ä½œæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒªã‚»ãƒƒãƒˆ
        function resetMultiCreateSection() {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚ªãƒ•
            $('#create-pg-task').prop('checked', false);
            $('#create-test-task').prop('checked', false);

            // è©³ç´°ã‚’éè¡¨ç¤º
            $('#pg-detail').addClass('hidden');
            $('#test-detail').addClass('hidden');

            // å…¥åŠ›å€¤ã‚’ã‚¯ãƒªã‚¢
            $('#pg-assignee').val('');
            $('#pg-man-days').val('');
            $('#pg-cost').val('');
            $('#pg-start-date').val('');
            $('#pg-end-date').val('');

            $('#test-assignee').val('');
            $('#test-man-days').val('');
            $('#test-cost').val('');
            $('#test-start-date').val('');
            $('#test-end-date').val('');
        }

        // å·¥ç¨‹å¤‰æ›´æ™‚ã«åŒæ™‚ä½œæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        function onProcessChange() {
            if (modalMode !== 'add') return;

            var process = $('#modal-process').val();
            if (process === '2') {
                // è¨­è¨ˆã®å ´åˆã®ã¿è¡¨ç¤º
                $('#multi-create-section').removeClass('hidden');
            } else {
                $('#multi-create-section').addClass('hidden');
                resetMultiCreateSection();
            }
        }

        // æ‹…å½“è€…åã®ãƒãƒƒãƒ”ãƒ³ã‚°
        function getAssigneeName(value) {
            var map = {
                'yamada': 'å±±ç”°',
                'sato': 'ä½è—¤',
                'suzuki': 'éˆ´æœ¨',
                'tanaka': 'ç”°ä¸­',
                'takahashi': 'é«˜æ©‹'
            };
            return map[value] || '-';
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’èª­ã¿å–ã‚Šå°‚ç”¨ã«è¨­å®š
        function setModalReadOnly(isReadOnly) {
            var $form = $('#task-form');
            var $inputs = $form.find('input, select, textarea');
            var $historyAddBtn = $('#history-add-btn');
            var $saveBtn = $('#modal-save-btn');
            var $cancelBtn = $('#modal-cancel-btn');

            if (isReadOnly) {
                // èª­ã¿å–ã‚Šå°‚ç”¨
                $inputs.prop('disabled', true);
                $historyAddBtn.addClass('hidden');
                $saveBtn.addClass('hidden');
                $cancelBtn.text('é–‰ã˜ã‚‹');
            } else {
                // ç·¨é›†å¯èƒ½
                $inputs.prop('disabled', false);
                $historyAddBtn.removeClass('hidden');
                $saveBtn.removeClass('hidden');
                $cancelBtn.text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
            }
        }

        // ===== ã‚¿ã‚¹ã‚¯å±¥æ­´æ©Ÿèƒ½ =====
        var currentEditingTaskId = null;
        var editingHistoryId = null;

        // ã‚¿ã‚¹ã‚¯å±¥æ­´ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¿ã‚¹ã‚¯ID => å±¥æ­´é…åˆ—ï¼‰
        var taskHistoryData = {
            '3-1-1': [
                { id: 1, date: '2024-04-01', hours: 4, progress: 30, content: 'ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä½œæˆ' },
                { id: 2, date: '2024-04-02', hours: 4, progress: 60, content: 'èªè¨¼APIé€£æºå®Ÿè£…' },
                { id: 3, date: '2024-04-03', hours: 2, progress: 80, content: 'ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã€‚localStorageã®å®¹é‡åˆ¶é™ã«æ³¨æ„ãŒå¿…è¦' },
                { id: 4, date: '2024-04-05', hours: 4, progress: 100, content: 'å®Œäº†ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼æ¸ˆã¿' }
            ],
            '3-1-2': [
                { id: 1, date: '2024-04-06', hours: 8, progress: 40, content: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆé–‹å§‹' },
                { id: 2, date: '2024-04-08', hours: 6, progress: 70, content: 'ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ›´ä¾é ¼ã‚ã‚Šã€‚ç¢ºèªå¾Œå¯¾å¿œäºˆå®š' },
                { id: 3, date: '2024-04-10', hours: 8, progress: 100, content: 'ãƒ‡ã‚¶ã‚¤ãƒ³ä¿®æ­£å®Œäº†ã€‚ãƒ†ã‚¹ãƒˆä¾é ¼æ¸ˆã¿' }
            ],
            '3-1-3': [
                { id: 1, date: '2024-04-15', hours: 6, progress: 20, content: 'ä¸€è¦§ç”»é¢ã®è¨­è¨ˆé–‹å§‹' },
                { id: 2, date: '2024-04-17', hours: 8, progress: 50, content: 'ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…ä¸­ã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œç™ºç”Ÿ' }
            ]
        };

        // å±¥æ­´IDã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
        var historyIdCounter = 100;

        // ã‚¿ã‚¹ã‚¯å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        function loadTaskHistory(taskId) {
            currentEditingTaskId = taskId;
            $('#modal-task-id').text(taskId ? 'ID: ' + taskId : '');

            var histories = taskHistoryData[taskId] || [];
            renderHistoryList(histories);
            updateActualSummary(histories);
        }

        // å±¥æ­´ä¸€è¦§ã‚’æç”»
        function renderHistoryList(histories) {
            var $list = $('#history-list');
            $list.empty();
            var isViewMode = (modalMode === 'view');

            if (histories.length === 0) {
                var emptyMsg = isViewMode ?
                    '<div class="text-center py-10 text-slate-400"><i class="fas fa-history text-4xl mb-3"></i><p>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p></div>' :
                    '<div class="text-center py-10 text-slate-400"><i class="fas fa-history text-4xl mb-3"></i><p>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p><p class="text-sm mt-1">ã€Œå±¥æ­´è¿½åŠ ã€ãƒœã‚¿ãƒ³ã§ä½œæ¥­è¨˜éŒ²ã‚’è¿½åŠ ã§ãã¾ã™</p></div>';
                $list.html(emptyMsg);
                return;
            }

            // æ—¥ä»˜ã®æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
            var sorted = histories.slice().sort(function(a, b) {
                return new Date(b.date) - new Date(a.date);
            });

            sorted.forEach(function(h) {
                var dateFormatted = formatHistoryDate(h.date);
                var actionButtons = isViewMode ? '' :
                    '<button onclick="editHistoryEntry(' + h.id + ')" class="p-1 text-slate-400 hover:text-blue-600"><i class="fas fa-edit text-xs"></i></button>' +
                    '<button onclick="deleteHistoryEntry(' + h.id + ')" class="p-1 text-slate-400 hover:text-red-600"><i class="fas fa-trash-alt text-xs"></i></button>';

                var html = '<div class="history-card" data-history-id="' + h.id + '">' +
                    '<div class="history-card-header bg-slate-50">' +
                        '<div class="flex items-center">' +
                            '<span class="text-sm font-bold text-slate-700">' + dateFormatted + '</span>' +
                        '</div>' +
                        '<div class="flex items-center space-x-1">' +
                            '<span class="text-xs text-slate-500 mr-2">' + (h.hours || 0) + 'h</span>' +
                            '<span class="text-xs font-bold ' + (h.progress >= 100 ? 'text-emerald-600' : 'text-blue-600') + '">' + h.progress + '%</span>' +
                            actionButtons +
                        '</div>' +
                    '</div>' +
                    (h.content ? '<div class="history-card-body"><p class="text-sm text-slate-600">' + escapeHtml(h.content) + '</p></div>' : '') +
                '</div>';

                $list.append(html);
            });
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatHistoryDate(dateStr) {
            var d = new Date(dateStr);
            var weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            return (d.getMonth() + 1) + '/' + d.getDate() + ' (' + weekdays[d.getDay()] + ')';
        }

        // å®Ÿç¸¾ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
        function updateActualSummary(histories) {
            if (!histories || histories.length === 0) {
                $('#modal-actual-start').text('-');
                $('#modal-actual-end').text('-');
                $('#modal-actual-days').text('-');
                $('#modal-actual-progress').text('0%');
                return;
            }

            var dates = histories.map(function(h) { return new Date(h.date); });
            var minDate = new Date(Math.min.apply(null, dates));
            var maxDate = new Date(Math.max.apply(null, dates));
            var totalHours = histories.reduce(function(sum, h) { return sum + (h.hours || 0); }, 0);
            var latestProgress = histories.reduce(function(max, h) {
                return new Date(h.date) >= new Date(max.date) ? h : max;
            }).progress;

            $('#modal-actual-start').text((minDate.getMonth() + 1) + '/' + minDate.getDate());
            $('#modal-actual-end').text(latestProgress >= 100 ? (maxDate.getMonth() + 1) + '/' + maxDate.getDate() : '-');
            $('#modal-actual-days').text((totalHours / 8).toFixed(1) + 'æ—¥');
            $('#modal-actual-progress').text(latestProgress + '%').removeClass('text-emerald-600 text-blue-600').addClass(latestProgress >= 100 ? 'text-emerald-600' : 'text-blue-600');

            // é€²æ—ãƒãƒ¼ã‚‚æ›´æ–°
            $('#modal-progress').val(latestProgress);
            $('#modal-progress-num').val(latestProgress);
            updateCostActual();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é€²æ—ç‡ã®åŒæœŸï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨æ•°å€¤å…¥åŠ›ï¼‰
        function syncModalProgress(value, source) {
            var val = parseInt(value) || 0;
            if (val < 0) val = 0;
            if (val > 100) val = 100;
            $('#modal-progress').val(val);
            $('#modal-progress-num').val(val);
            updateCostActual();
        }

        // åŸä¾¡å®Ÿç¸¾ã‚’æ›´æ–°ï¼ˆé€²æ—ç‡æ›ç®—ï¼‰
        function updateCostActual() {
            var cost = parseFloat($('#modal-cost').val()) || 0;
            var progress = parseInt($('#modal-progress').val()) || 0;
            var actualCost = Math.round(cost * progress / 100);
            $('#modal-cost-actual').text('Â¥' + actualCost.toLocaleString());
        }

        // é€²æ—ç‡ã®åŒæœŸï¼ˆå±¥æ­´ãƒ•ã‚©ãƒ¼ãƒ ç”¨ï¼‰
        function syncHistoryProgress(value, source) {
            var val = parseInt(value) || 0;
            if (val < 0) val = 0;
            if (val > 100) val = 100;
            $('#history-progress').val(val);
            $('#history-progress-num').val(val);
        }

        // å±¥æ­´å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã
        function openHistoryEntryForm() {
            editingHistoryId = null;
            $('#history-date').val(new Date().toISOString().slice(0, 10));
            $('#history-hours').val('');
            $('#history-progress').val(0);
            $('#history-progress-num').val(0);
            $('#history-content').val('');
            $('#history-entry-form').removeClass('hidden');
        }

        // å±¥æ­´å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
        function closeHistoryEntryForm() {
            $('#history-entry-form').addClass('hidden');
            editingHistoryId = null;
        }

        // å±¥æ­´ã‚’ç·¨é›†
        function editHistoryEntry(historyId) {
            if (!currentEditingTaskId) return;

            var histories = taskHistoryData[currentEditingTaskId] || [];
            var history = histories.find(function(h) { return h.id === historyId; });
            if (!history) return;

            editingHistoryId = historyId;
            $('#history-date').val(history.date);
            $('#history-hours').val(history.hours || '');
            $('#history-progress').val(history.progress || 0);
            $('#history-progress-num').val(history.progress || 0);
            $('#history-content').val(history.content || '');
            $('#history-entry-form').removeClass('hidden');
        }

        // å±¥æ­´ã‚’ä¿å­˜
        function saveHistoryEntry() {
            var date = $('#history-date').val();
            if (!date) {
                alert('ä½œæ¥­æ—¥ã¯å¿…é ˆã§ã™');
                return;
            }

            var entry = {
                id: editingHistoryId || ++historyIdCounter,
                date: date,
                hours: parseFloat($('#history-hours').val()) || 0,
                progress: parseInt($('#history-progress').val()) || 0,
                content: $('#history-content').val()
            };

            if (!taskHistoryData[currentEditingTaskId]) {
                taskHistoryData[currentEditingTaskId] = [];
            }

            if (editingHistoryId) {
                // ç·¨é›†
                var index = taskHistoryData[currentEditingTaskId].findIndex(function(h) { return h.id === editingHistoryId; });
                if (index >= 0) {
                    taskHistoryData[currentEditingTaskId][index] = entry;
                }
            } else {
                // æ–°è¦è¿½åŠ 
                taskHistoryData[currentEditingTaskId].push(entry);
            }

            closeHistoryEntryForm();
            loadTaskHistory(currentEditingTaskId);
        }

        // å±¥æ­´ã‚’å‰Šé™¤
        function deleteHistoryEntry(historyId) {
            if (!confirm('ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            if (taskHistoryData[currentEditingTaskId]) {
                taskHistoryData[currentEditingTaskId] = taskHistoryData[currentEditingTaskId].filter(function(h) {
                    return h.id !== historyId;
                });
            }

            loadTaskHistory(currentEditingTaskId);
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function saveTask() {
            var process = $('#modal-process').val();
            var taskName = $('#modal-task-name').val();

            if (!process || !taskName) {
                alert('å·¥ç¨‹ã¨ã‚¿ã‚¹ã‚¯åã¯å¿…é ˆã§ã™ã€‚');
                return;
            }

            // ä¿å­˜å‡¦ç†ï¼ˆãƒ¢ãƒƒã‚¯ãªã®ã§å¤‰æ›´ã‚’è¨˜éŒ²ï¼‰
            var data = {
                process: $('#modal-process').val(),
                screen: $('#modal-screen').val(),
                taskName: $('#modal-task-name').val(),
                assignee: $('#modal-assignee').val(),
                startDate: $('#modal-start-date').val(),
                endDate: $('#modal-end-date').val(),
                manDays: $('#modal-man-days').val(),
                cost: $('#modal-cost').val(),
                progress: $('#modal-progress').val(),
                note: $('#modal-note').val()
            };

            var taskId = selectedTaskRow ? $(selectedTaskRow).data('task') : null;

            // taskDataã‚’æ›´æ–°
            if (taskId && modalMode === 'edit') {
                var task = taskData.find(function(t) { return t.id === taskId; });
                if (task) {
                    task.name = data.taskName;
                    task.assignee = data.assignee || task.assignee;
                    if (data.startDate) task.planStart = formatDateForDisplay(new Date(data.startDate));
                    if (data.endDate) task.planEnd = formatDateForDisplay(new Date(data.endDate));
                    if (data.manDays) task.manDays = parseFloat(data.manDays);
                    if (data.cost) task.cost = parseFloat(data.cost) / 1000; // å††â†’ä¸‡å††
                    task.progress = parseInt(data.progress) || 0;

                    modifiedTaskIds.add(taskId);

                    // è¦ªãƒ»å·¥ç¨‹ã®æ—¥ä»˜ã‚’å†è¨ˆç®—
                    updateParentTaskDates(taskId);

                    // ç”»é¢ã‚’å†æç”»
                    generateTaskList();
                    generateGanttBody();

                    if (currentEditMode === 'edit') {
                        enableEditMode();
                    } else {
                        disableEditMode();
                    }
                }
            }

            // æ–°è¦è¿½åŠ æ™‚ã®åŒæ™‚ä½œæˆå‡¦ç†
            if (modalMode === 'add') {
                var createdTasks = [];

                // ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ä½œæˆ
                var newTaskId = createNewTask(data);
                if (newTaskId) {
                    createdTasks.push({ id: newTaskId, type: 'åŸºæœ¬', name: data.taskName });
                }

                // PGåŒæ™‚ä½œæˆ
                if ($('#create-pg-task').is(':checked')) {
                    var pgData = {
                        process: '3', // PGå·¥ç¨‹
                        screen: data.screen,
                        taskName: data.taskName,
                        assignee: $('#pg-assignee').val(),
                        startDate: $('#pg-start-date').val(),
                        endDate: $('#pg-end-date').val(),
                        manDays: $('#pg-man-days').val(),
                        cost: $('#pg-cost').val(),
                        progress: 0,
                        note: data.note
                    };
                    var pgTaskId = createNewTask(pgData);
                    if (pgTaskId) {
                        createdTasks.push({ id: pgTaskId, type: 'PG', name: data.taskName });
                    }
                }

                // ãƒ†ã‚¹ãƒˆåŒæ™‚ä½œæˆ
                if ($('#create-test-task').is(':checked')) {
                    var testData = {
                        process: '4', // ãƒ†ã‚¹ãƒˆå·¥ç¨‹
                        screen: data.screen,
                        taskName: data.taskName,
                        assignee: $('#test-assignee').val(),
                        startDate: $('#test-start-date').val(),
                        endDate: $('#test-end-date').val(),
                        manDays: $('#test-man-days').val(),
                        cost: $('#test-cost').val(),
                        progress: 0,
                        note: data.note
                    };
                    var testTaskId = createNewTask(testData);
                    if (testTaskId) {
                        createdTasks.push({ id: testTaskId, type: 'ãƒ†ã‚¹ãƒˆ', name: data.taskName });
                    }
                }

                // ä½œæˆçµæœã‚’è¡¨ç¤º
                if (createdTasks.length > 1) {
                    var msg = 'ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸ:\n';
                    createdTasks.forEach(function(t) {
                        msg += 'ãƒ»[' + t.type + '] ' + t.id + ' - ' + t.name + '\n';
                    });
                    alert(msg);
                }

                // ç”»é¢ã‚’å†æç”»
                generateTaskList();
                generateGanttBody();

                if (currentEditMode === 'edit') {
                    enableEditMode();
                } else {
                    disableEditMode();
                }
            }

            // å¤‰æ›´ã‚’è¨˜éŒ²ï¼ˆç™»éŒ²ãƒœã‚¿ãƒ³ã§ç¢ºå®šï¼‰
            recordChange(taskId, modalMode === 'edit' ? 'task_edit' : 'task_add', data);

            closeTaskModal();
            hasUnsavedChanges = true;
            updateSaveButtonState();
        }

        // æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
        function createNewTask(data) {
            var processId = data.process;
            var processNames = { '1': 'è¦ä»¶å®šç¾©', '2': 'è¨­è¨ˆ', '3': 'PG', '4': 'ãƒ†ã‚¹ãƒˆ', '5': 'ãƒªãƒªãƒ¼ã‚¹' };

            // å·¥ç¨‹é…ä¸‹ã®å­ã‚¿ã‚¹ã‚¯ã‚’å–å¾—ã—ã¦æ¬¡ã®IDã‚’æ±ºå®š
            var childTasks = taskData.filter(function(t) {
                return t.id.indexOf(processId + '-') === 0 && t.id.split('-').length === 2;
            });

            var nextNum = childTasks.length + 1;
            var newTaskId = processId + '-' + nextNum;

            // æ‹…å½“è€…åã‚’å–å¾—
            var assigneeName = getAssigneeName(data.assignee);

            // æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            var newTask = {
                id: newTaskId,
                name: data.taskName,
                type: 'child',
                no: newTaskId,
                group: '',
                assignee: assigneeName,
                manDays: parseFloat(data.manDays) || 0,
                cost: data.cost ? parseFloat(data.cost) / 1000 : 0,
                planStart: data.startDate ? formatDateForDisplay(new Date(data.startDate)) : '-',
                planEnd: data.endDate ? formatDateForDisplay(new Date(data.endDate)) : '-',
                actualManDays: null,
                actualCost: null,
                actualStart: '-',
                actualEnd: '-',
                progress: 0,
                delay: { type: 'ontime', text: '-' }
            };

            // taskDataã«è¿½åŠ ï¼ˆå·¥ç¨‹ã®å¾Œã€é©åˆ‡ãªä½ç½®ã«æŒ¿å…¥ï¼‰
            var insertIndex = taskData.findIndex(function(t) { return t.id === processId; });
            if (insertIndex !== -1) {
                // åŒã˜å·¥ç¨‹ã®æœ€å¾Œã®å­ã‚¿ã‚¹ã‚¯ã®å¾Œã«æŒ¿å…¥
                for (var i = insertIndex + 1; i < taskData.length; i++) {
                    if (taskData[i].id.indexOf(processId + '-') !== 0) {
                        insertIndex = i;
                        break;
                    }
                    insertIndex = i + 1;
                }
            }
            taskData.splice(insertIndex, 0, newTask);

            // TASK_DATAã«ã‚‚è¿½åŠ 
            var ganttTask = {
                id: newTaskId,
                type: 'child',
                name: data.taskName,
                assignee: assigneeName,
                manDays: parseFloat(data.manDays) || 0,
                startDate: newTask.planStart,
                endDate: newTask.planEnd,
                status: 'not-started',
                start: 0,
                width: 200,
                label: data.taskName,
                color: getProcessColor(processId)
            };

            // æ—¥ä»˜ã‹ã‚‰startä½ç½®ã‚’è¨ˆç®—
            if (newTask.planStart !== '-') {
                var startDate = parseDisplayDate(newTask.planStart);
                if (startDate) {
                    ganttTask.start = calculateDatePosition(startDate);
                }
            }
            if (newTask.planStart !== '-' && newTask.planEnd !== '-') {
                var startDate = parseDisplayDate(newTask.planStart);
                var endDate = parseDisplayDate(newTask.planEnd);
                if (startDate && endDate) {
                    ganttTask.width = (calculateDatePosition(endDate) - calculateDatePosition(startDate)) + CELL_WIDTH;
                }
            }

            TASK_DATA.push(ganttTask);

            // å¤‰æ›´ã‚’ãƒãƒ¼ã‚¯
            modifiedTaskIds.add(newTaskId);

            // è¦ªã‚¿ã‚¹ã‚¯ã®æ—¥ä»˜ã‚’å†è¨ˆç®—
            updateParentTaskDates(newTaskId);

            return newTaskId;
        }

        // å·¥ç¨‹ã«å¿œã˜ãŸã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®è‰²ã‚’å–å¾—
        function getProcessColor(processId) {
            var colors = {
                '1': 'from-blue-500 to-indigo-600',
                '2': 'from-purple-500 to-pink-600',
                '3': 'from-blue-500 to-indigo-600',
                '4': 'from-amber-500 to-yellow-600',
                '5': 'from-emerald-500 to-green-600'
            };
            return colors[processId] || 'from-gray-400 to-gray-500';
        }

        function duplicateTask() {
            var taskId = selectedTaskRow ? $(selectedTaskRow).data('task') : null;
            if (confirm('ã‚¿ã‚¹ã‚¯ã€Œ' + taskId + 'ã€ã‚’è¤‡è£½ã—ã¾ã™ã‹ï¼Ÿ')) {
                alert('ã‚¿ã‚¹ã‚¯ã‚’è¤‡è£½ã—ã¾ã—ãŸ');
            }
            $('#context-menu').removeClass('show');
        }

        function deleteTask() {
            var taskId = selectedTaskRow ? $(selectedTaskRow).data('task') : null;
            if (confirm('ã‚¿ã‚¹ã‚¯ã€Œ' + taskId + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                alert('ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
            $('#context-menu').removeClass('show');
        }

        // ===== ã‚¿ã‚¹ã‚¯ä¸€è¦§ç”Ÿæˆ =====
        function generateTaskList() {
            var $taskList = $('#task-list');
            $taskList.empty();

            taskData.forEach(function(task) {
                var isParent = task.type === 'parent';
                var isChild = task.type === 'child';
                var isGrandchild = task.type === 'grandchild';
                var isModified = modifiedTaskIds.has(task.id);

                var bgClass = isParent ? 'bg-slate-50' : '';
                var borderClass = isParent ? 'border-b border-slate-200' : 'border-b border-slate-100';
                var modifiedClass = isModified ? 'task-row-modified' : '';
                var paddingClass = isGrandchild ? 'pl-10' : (isChild ? 'pl-5' : '');

                var assigneeColor = ASSIGNEE_COLORS[task.assignee] || 'from-gray-400 to-gray-500';
                var progressColorClass = task.progress === 100 ? 'text-emerald-600' :
                                          (task.progress > 0 ? 'text-blue-600' : 'text-slate-400');
                var delayBadgeClass = 'delay-' + task.delay.type;

                // chevronã¯ä¸è¦ãªã®ã§å‰Šé™¤
                var chevronHtml = '';

                var assigneeHtml = task.assignee === '-' ?
                    '<span class="text-slate-500 text-xs">-</span>' :
                    '<div class="flex items-center justify-center">' +
                        '<div class="w-5 h-5 rounded-full bg-gradient-to-br ' + assigneeColor + ' mr-1"></div>' +
                        '<span class="text-xs text-slate-600">' + task.assignee + '</span>' +
                    '</div>';

                var costDisplay = task.cost ? task.cost + 'ä¸‡' : '-';
                var actualCostDisplay = task.actualCost ? task.actualCost + 'ä¸‡' : '-';

                var html = '<div class="flex task-row items-center ' + bgClass + ' ' + borderClass + ' hover:bg-blue-50 cursor-pointer task-row-item ' + modifiedClass + '" data-task="' + task.id + '" data-no="' + (task.no || '') + '" data-group="' + (task.group || '') + '" data-index="' + taskData.indexOf(task) + '">' +
                    '<div class="w-8 px-1 text-center border-r border-slate-200 flex items-center justify-center">' +
                        '<input type="checkbox" class="row-checkbox rounded border-slate-300 cursor-pointer mr-1" onclick="event.stopPropagation();">' +
                        chevronHtml +
                    '</div>' +
                    '<div class="w-14 px-1 text-center border-r border-slate-200">' +
                        '<span class="text-xs text-slate-600">' + (task.no || '-') + '</span>' +
                    '</div>' +
                    '<div class="flex-1 px-2 ' + paddingClass + ' border-r border-slate-200">' +
                        '<span class="' + (isParent ? 'font-bold text-slate-800' : 'text-slate-700') + ' text-sm">' + task.name + '</span>' +
                    '</div>' +
                    '<div class="w-16 px-1 border-r border-slate-200">' + assigneeHtml + '</div>' +
                    '<div class="w-12 px-1 text-center border-r border-slate-200">' +
                        '<span class="plan-data text-xs ' + (isParent ? 'font-semibold' : '') + ' text-slate-600">' + task.manDays + 'æ—¥</span>' +
                        '<span class="actual-data text-xs ' + (isParent ? 'font-semibold' : '') + ' text-slate-600" style="display:none;">' + (task.actualManDays || '-') + (task.actualManDays ? 'æ—¥' : '') + '</span>' +
                    '</div>' +
                    '<div class="w-16 px-1 text-center border-r border-slate-200">' +
                        '<span class="plan-data text-xs ' + (isParent ? 'font-semibold' : '') + ' text-slate-700">' + costDisplay + '</span>' +
                        '<span class="actual-data text-xs ' + (isParent ? 'font-semibold' : '') + ' text-slate-700" style="display:none;">' + actualCostDisplay + '</span>' +
                    '</div>' +
                    '<div class="w-16 px-1 text-center border-r border-slate-200">' +
                        '<span class="plan-data text-xs text-slate-600">' + task.planStart + '</span>' +
                        '<span class="actual-data text-xs text-slate-600" style="display:none;">' + task.actualStart + '</span>' +
                    '</div>' +
                    '<div class="w-16 px-1 text-center border-r border-slate-200">' +
                        '<span class="plan-data text-xs text-slate-600">' + task.planEnd + '</span>' +
                        '<span class="actual-data text-xs text-slate-600" style="display:none;">' + task.actualEnd + '</span>' +
                    '</div>' +
                    '<div class="w-12 px-1 text-center border-r border-slate-200">' +
                        '<span class="text-xs ' + (isParent ? 'font-bold' : 'font-semibold') + ' ' + progressColorClass + '">' + task.progress + '%</span>' +
                    '</div>' +
                    '<div class="w-16 px-1 text-center">' +
                        '<span class="delay-badge ' + delayBadgeClass + '">' + task.delay.text + '</span>' +
                    '</div>' +
                '</div>';

                $taskList.append(html);
            });

            // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å†ãƒã‚¤ãƒ³ãƒ‰
            bindContextMenu();

            // ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºã‚’åæ˜ 
            switchMode(currentMode);
        }

        // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒã‚¤ãƒ³ãƒ‰
        function bindContextMenu() {
            var $contextMenu = $('#context-menu');
            $('.task-row-item').off('contextmenu').on('contextmenu', function(e) {
                e.preventDefault();
                if (currentEditMode !== 'edit') return;
                selectedTaskRow = this;
                $contextMenu.css({
                    'left': e.pageX + 'px',
                    'top': e.pageY + 'px'
                }).addClass('show');
            });

        }

        // ã‚°ãƒ«ãƒ¼ãƒ—ã®æ›´æ–°
        function updateTaskGroup(taskId, newGroup) {
            var task = taskData.find(function(t) { return t.id === taskId; });
            if (task) {
                task.group = newGroup;
                modifiedTaskIds.add(taskId);
                markRowAsModified(taskId);
                recordChange(taskId, 'group_change', { group: newGroup });
            }
        }

        // ===== ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ =====
        var groupData = {}; // ã‚°ãƒ«ãƒ¼ãƒ—å => ã‚¿ã‚¹ã‚¯IDã®é…åˆ—

        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
        function initGroupData() {
            groupData = {};
            taskData.forEach(function(task) {
                if (task.group && task.group !== '') {
                    if (!groupData[task.group]) {
                        groupData[task.group] = [];
                    }
                    groupData[task.group].push(task.id);
                }
            });
        }

        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openGroupModal() {
            initGroupData();
            renderGroupList();
            $('#group-modal').addClass('show');
        }

        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeGroupModal() {
            $('#group-modal').removeClass('show');
        }

        // ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ã‚’æç”»
        function renderGroupList() {
            var $groupList = $('#group-list');
            $groupList.empty();

            var groupNames = Object.keys(groupData).sort();

            if (groupNames.length === 0) {
                $groupList.html('<div class="col-span-full flex flex-col items-center justify-center py-20 text-slate-400"><i class="fas fa-layer-group text-6xl mb-4"></i><p class="text-lg">ã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</p><p class="text-sm mt-2">ã€Œæ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¦ãã ã•ã„</p></div>');
                return;
            }

            groupNames.forEach(function(groupName) {
                var taskIds = groupData[groupName];
                var tasks = taskIds.map(function(id) {
                    return taskData.find(function(t) { return t.id === id; });
                }).filter(function(t) { return t; });

                var groupHtml = '<div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden" data-group-name="' + groupName + '">' +
                    '<div class="bg-gradient-to-r from-purple-500 to-indigo-600 px-4 py-3">' +
                        '<div class="flex items-center justify-between">' +
                            '<div class="flex items-center">' +
                                '<span class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-white text-lg font-bold mr-3">' + groupName.charAt(0) + '</span>' +
                                '<div>' +
                                    '<input type="text" class="group-name-input text-base font-bold text-white bg-transparent border-b border-transparent hover:border-white/50 focus:border-white focus:outline-none" value="' + groupName + '" onchange="renameGroup(\'' + groupName + '\', this.value)">' +
                                    '<p class="text-xs text-white/70">' + tasks.length + 'ä»¶ã®ã‚¿ã‚¹ã‚¯</p>' +
                                '</div>' +
                            '</div>' +
                            '<div class="flex items-center space-x-1">' +
                                '<button onclick="showAddTaskToGroup(\'' + groupName + '\')" class="p-2 text-white/80 hover:text-white hover:bg-white/20 rounded-lg transition-colors" title="ã‚¿ã‚¹ã‚¯è¿½åŠ "><i class="fas fa-plus"></i></button>' +
                                '<button onclick="deleteGroup(\'' + groupName + '\')" class="p-2 text-white/80 hover:text-white hover:bg-red-500/50 rounded-lg transition-colors" title="ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤"><i class="fas fa-trash-alt"></i></button>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="divide-y divide-slate-100 max-h-64 overflow-y-auto">';

                if (tasks.length === 0) {
                    groupHtml += '<div class="px-4 py-6 text-center text-slate-400 text-sm"><i class="fas fa-inbox text-2xl mb-2"></i><p>ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
                } else {
                    tasks.forEach(function(task, index) {
                        var assigneeColor = ASSIGNEE_COLORS[task.assignee] || 'from-gray-400 to-gray-500';
                        groupHtml += '<div class="px-4 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors">' +
                            '<div class="flex items-center flex-1 min-w-0">' +
                                '<span class="w-6 h-6 rounded-full bg-purple-100 text-purple-600 text-xs flex items-center justify-center mr-3 flex-shrink-0">' + (index + 1) + '</span>' +
                                '<span class="text-sm text-slate-700 truncate">' + task.name + '</span>' +
                            '</div>' +
                            '<div class="flex items-center space-x-2 flex-shrink-0 ml-2">' +
                                '<div class="flex items-center">' +
                                    '<div class="w-5 h-5 rounded-full bg-gradient-to-br ' + assigneeColor + ' mr-1"></div>' +
                                    '<span class="text-xs text-slate-500">' + task.assignee + '</span>' +
                                '</div>' +
                                '<span class="text-xs text-slate-400 hidden sm:inline">' + task.planStart + '-' + task.planEnd + '</span>' +
                                '<button onclick="removeTaskFromGroup(\'' + task.id + '\', \'' + groupName + '\')" class="p-1 text-slate-400 hover:text-red-500 transition-colors"><i class="fas fa-times"></i></button>' +
                            '</div>' +
                        '</div>';
                    });
                }

                groupHtml += '</div></div>';
                $groupList.append(groupHtml);
            });
        }

        // æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ 
        function addNewGroup() {
            var newGroupName = 'ã‚°ãƒ«ãƒ¼ãƒ—' + (Object.keys(groupData).length + 1);
            var counter = 1;
            while (groupData[newGroupName]) {
                counter++;
                newGroupName = 'ã‚°ãƒ«ãƒ¼ãƒ—' + counter;
            }
            groupData[newGroupName] = [];
            renderGroupList();
        }

        // ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å¤‰æ›´
        function renameGroup(oldName, newName) {
            if (oldName === newName || !newName.trim()) return;
            if (groupData[newName]) {
                alert('åŒã˜åå‰ã®ã‚°ãƒ«ãƒ¼ãƒ—ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™');
                renderGroupList();
                return;
            }
            // ã‚¿ã‚¹ã‚¯ã®ã‚°ãƒ«ãƒ¼ãƒ—åã‚’æ›´æ–°
            taskData.forEach(function(task) {
                if (task.group === oldName) {
                    task.group = newName;
                    modifiedTaskIds.add(task.id);
                }
            });
            groupData[newName] = groupData[oldName];
            delete groupData[oldName];
            renderGroupList();
            generateTaskList();
        }

        // ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤
        function deleteGroup(groupName) {
            if (!confirm('ã‚°ãƒ«ãƒ¼ãƒ—ã€Œ' + groupName + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã‚¿ã‚¹ã‚¯è‡ªä½“ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚')) return;
            // ã‚¿ã‚¹ã‚¯ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç©ºã«
            taskData.forEach(function(task) {
                if (task.group === groupName) {
                    task.group = '';
                    modifiedTaskIds.add(task.id);
                }
            });
            delete groupData[groupName];
            renderGroupList();
            generateTaskList();
        }

        // ã‚¿ã‚¹ã‚¯ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰å‰Šé™¤
        function removeTaskFromGroup(taskId, groupName) {
            var task = taskData.find(function(t) { return t.id === taskId; });
            if (task) {
                task.group = '';
                modifiedTaskIds.add(taskId);
            }
            groupData[groupName] = groupData[groupName].filter(function(id) { return id !== taskId; });
            renderGroupList();
            generateTaskList();
        }

        // ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showAddTaskToGroup(groupName) {
            var availableTasks = taskData.filter(function(t) {
                return !t.group || t.group === '';
            });

            if (availableTasks.length === 0) {
                alert('ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã§ãã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            var modalHtml = '<div id="add-task-overlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">' +
                '<div class="bg-white rounded-xl shadow-2xl w-96 max-h-96 overflow-hidden">' +
                    '<div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-4 py-3 flex items-center justify-between">' +
                        '<h4 class="text-white font-semibold"><i class="fas fa-plus mr-2"></i>ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ : ' + groupName + '</h4>' +
                        '<button onclick="closeAddTaskOverlay()" class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button>' +
                    '</div>' +
                    '<div class="p-4 max-h-60 overflow-y-auto">' +
                        '<div class="space-y-1">';

            availableTasks.forEach(function(task) {
                modalHtml += '<label class="flex items-center p-2 hover:bg-slate-50 rounded cursor-pointer">' +
                    '<input type="checkbox" class="add-task-checkbox mr-3" value="' + task.id + '">' +
                    '<span class="text-sm text-slate-700">' + task.name + '</span>' +
                '</label>';
            });

            modalHtml += '</div></div>' +
                    '<div class="bg-slate-50 px-4 py-3 flex justify-end space-x-2">' +
                        '<button onclick="closeAddTaskOverlay()" class="px-3 py-1.5 text-sm text-slate-600 hover:bg-slate-200 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>' +
                        '<button onclick="addSelectedTasksToGroup(\'' + groupName + '\')" class="px-3 py-1.5 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">è¿½åŠ </button>' +
                    '</div>' +
                '</div>' +
            '</div>';

            $('body').append(modalHtml);
        }

        // ã‚¿ã‚¹ã‚¯è¿½åŠ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é–‰ã˜ã‚‹
        function closeAddTaskOverlay() {
            $('#add-task-overlay').remove();
        }

        // é¸æŠã—ãŸã‚¿ã‚¹ã‚¯ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ 
        function addSelectedTasksToGroup(groupName) {
            var selectedIds = [];
            $('.add-task-checkbox:checked').each(function() {
                selectedIds.push($(this).val());
            });

            selectedIds.forEach(function(taskId) {
                var task = taskData.find(function(t) { return t.id === taskId; });
                if (task) {
                    task.group = groupName;
                    modifiedTaskIds.add(taskId);
                    if (!groupData[groupName]) {
                        groupData[groupName] = [];
                    }
                    groupData[groupName].push(taskId);
                }
            });

            closeAddTaskOverlay();
            renderGroupList();
            generateTaskList();
        }

        // è¡Œã‚’å¤‰æ›´æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯
        function markRowAsModified(taskId) {
            var $row = $('.task-row-item[data-task="' + taskId + '"]');
            if ($row.length) {
                $row.addClass('task-row-modified');
            }
        }

        // ===== ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§ã®æ—¥ä»˜è‡ªå‹•è¨ˆç®— =====
        // åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ã‚¿ã‚¹ã‚¯ã¯ã€Noé †ã§é€£ç¶šã™ã‚‹ã‚ˆã†ã«æ—¥ä»˜ãŒèª¿æ•´ã•ã‚Œã‚‹
        function recalculateDatesInGroup(startTaskId, groupName, newStartDate, newEndDate) {
            // æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã®é–‹å§‹æ—¥ãƒ»çµ‚äº†æ—¥ã‚’æ›´æ–°
            var startTask = taskData.find(function(t) { return t.id === startTaskId; });
            if (!startTask || !groupName) return;

            var startNo = startTask.no;
            startTask.planStart = formatDateForDisplay(newStartDate);
            startTask.planEnd = formatDateForDisplay(newEndDate);
            modifiedTaskIds.add(startTaskId);

            // ç¾åœ¨ã®çµ‚äº†æ—¥ã‚’åŸºæº–ã«å¾Œç¶šã‚¿ã‚¹ã‚¯ã®æ—¥ä»˜ã‚’æ›´æ–°
            var currentEndDate = new Date(newEndDate);

            // åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§ã€Noé †ã§ã‚½ãƒ¼ãƒˆã—ãŸã‚¿ã‚¹ã‚¯ã‚’å–å¾—ï¼ˆå¤‰æ›´ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚ˆã‚Šå¾Œã®ã‚‚ã®ï¼‰
            var groupTasks = taskData
                .filter(function(t) { return t.group === groupName && t.no > startNo; })
                .sort(function(a, b) { return a.no - b.no; });

            groupTasks.forEach(function(task) {
                // æ¬¡ã®ã‚¿ã‚¹ã‚¯ã®é–‹å§‹æ—¥ = å‰ã®ã‚¿ã‚¹ã‚¯ã®çµ‚äº†æ—¥ã®ç¿Œå–¶æ¥­æ—¥
                var nextStartDate = getNextBusinessDay(currentEndDate);
                var taskDays = task.manDays || 1;

                // çµ‚äº†æ—¥ = é–‹å§‹æ—¥ + å·¥æ•° - 1ï¼ˆå–¶æ¥­æ—¥ãƒ™ãƒ¼ã‚¹ï¼‰
                var nextEndDate = addBusinessDays(nextStartDate, taskDays - 1);

                // é…å»¶æ—¥æ•°ã‚’è¨ˆç®—ï¼ˆå…ƒã®çµ‚äº†æ—¥ã¨æ¯”è¼ƒï¼‰
                var originalEnd = parseDisplayDate(task.planEnd);
                var delayDays = 0;
                if (originalEnd) {
                    delayDays = Math.ceil((nextEndDate - originalEnd) / (1000 * 60 * 60 * 24));
                }

                task.planStart = formatDateForDisplay(nextStartDate);
                task.planEnd = formatDateForDisplay(nextEndDate);

                // é…å»¶æƒ…å ±ã‚’æ›´æ–°
                if (delayDays > 0) {
                    task.delay = { type: 'late', text: delayDays + 'æ—¥é…ã‚Œ' };
                } else if (delayDays < 0) {
                    task.delay = { type: 'ahead', text: Math.abs(delayDays) + 'æ—¥å…ˆè¡Œ' };
                } else {
                    task.delay = { type: 'ontime', text: 'äºˆå®šé€šã‚Š' };
                }

                modifiedTaskIds.add(task.id);
                currentEndDate = nextEndDate;
            });

            // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’å†æç”»
            generateTaskList();
            generateGanttBody();

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãªã‚‰å†åº¦æœ‰åŠ¹åŒ–
            if (currentEditMode === 'edit') {
                enableEditMode();
            }
        }

        // æ—¥ä»˜è¡¨ç¤ºç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆMM/DDï¼‰
        function formatDateForDisplay(date) {
            var month = ('0' + (date.getMonth() + 1)).slice(-2);
            var day = ('0' + date.getDate()).slice(-2);
            return month + '/' + day;
        }

        // è¡¨ç¤ºå½¢å¼ã‹ã‚‰æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
        function parseDisplayDate(dateStr) {
            if (!dateStr || dateStr === '-') return null;
            var parts = dateStr.split('/');
            var year = TODAY.getFullYear();
            return new Date(year, parseInt(parts[0]) - 1, parseInt(parts[1]));
        }

        // ç¿Œå–¶æ¥­æ—¥ã‚’å–å¾—
        function getNextBusinessDay(date) {
            var next = new Date(date);
            next.setDate(next.getDate() + 1);
            while (next.getDay() === 0 || next.getDay() === 6) {
                next.setDate(next.getDate() + 1);
            }
            return next;
        }

        // å–¶æ¥­æ—¥ã‚’åŠ ç®—
        function addBusinessDays(date, days) {
            var result = new Date(date);
            var addedDays = 0;
            while (addedDays < days) {
                result.setDate(result.getDate() + 1);
                if (result.getDay() !== 0 && result.getDay() !== 6) {
                    addedDays++;
                }
            }
            return result;
        }

        // ===== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ =====
        function openExportModal() {
            $('#export-modal').addClass('show');
            updateExportPreview();

            // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
            $('input[name="export-format"]').off('change').on('change', function() {
                updateExportPreview();
            });

            // é …ç›®å¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
            $('.export-field').off('change').on('change', function() {
                updateExportPreview();
            });
        }

        function closeExportModal() {
            $('#export-modal').removeClass('show');
        }

        function getSelectedExportFields() {
            var fields = [];
            $('.export-field:checked').each(function() {
                fields.push($(this).val());
            });
            return fields;
        }

        function getFieldLabel(field) {
            var labels = {
                'no': 'No',
                'name': 'ã‚¿ã‚¹ã‚¯å',
                'assignee': 'æ‹…å½“è€…',
                'group': 'ã‚°ãƒ«ãƒ¼ãƒ—',
                'planStart': 'äºˆå®šé–‹å§‹æ—¥',
                'planEnd': 'äºˆå®šçµ‚äº†æ—¥',
                'manDays': 'äºˆå®šå·¥æ•°',
                'cost': 'äºˆå®šåŸä¾¡',
                'actualStart': 'å®Ÿç¸¾é–‹å§‹æ—¥',
                'actualEnd': 'å®Ÿç¸¾çµ‚äº†æ—¥',
                'actualManDays': 'å®Ÿç¸¾å·¥æ•°',
                'actualCost': 'å®Ÿç¸¾åŸä¾¡',
                'progress': 'é€²æ—ç‡',
                'delay': 'é…å»¶çŠ¶æ³'
            };
            return labels[field] || field;
        }

        function getTaskFieldValue(task, field) {
            switch (field) {
                case 'no': return task.no || '';
                case 'name': return task.name || '';
                case 'assignee': return task.assignee || '';
                case 'group': return task.group || '';
                case 'planStart': return task.planStart || '';
                case 'planEnd': return task.planEnd || '';
                case 'manDays': return task.manDays ? task.manDays + 'æ—¥' : '';
                case 'cost': return task.cost ? task.cost + 'ä¸‡' : '';
                case 'actualStart': return task.actualStart || '';
                case 'actualEnd': return task.actualEnd || '';
                case 'actualManDays': return task.actualManDays ? task.actualManDays + 'æ—¥' : '';
                case 'actualCost': return task.actualCost ? task.actualCost + 'ä¸‡' : '';
                case 'progress': return task.progress !== undefined ? task.progress + '%' : '';
                case 'delay': return task.delay ? task.delay.text : '';
                default: return '';
            }
        }

        function updateExportPreview() {
            var format = $('input[name="export-format"]:checked').val();
            var fields = getSelectedExportFields();
            var preview = '';

            $('#export-count').text(taskData.length);

            if (fields.length === 0) {
                $('#export-preview').text('å‡ºåŠ›é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (format === 'csv') {
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
                var headers = fields.map(function(f) { return getFieldLabel(f); });
                preview = headers.join(',') + '\n';

                // ãƒ‡ãƒ¼ã‚¿è¡Œï¼ˆæœ€åˆã®3ä»¶ã®ã¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
                var previewCount = Math.min(3, taskData.length);
                for (var i = 0; i < previewCount; i++) {
                    var values = fields.map(function(f) {
                        var val = getTaskFieldValue(taskData[i], f);
                        // ã‚«ãƒ³ãƒã‚’å«ã‚€å ´åˆã¯ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€
                        if (val.indexOf(',') >= 0) {
                            val = '"' + val + '"';
                        }
                        return val;
                    });
                    preview += values.join(',') + '\n';
                }
                if (taskData.length > 3) {
                    preview += '... ä»– ' + (taskData.length - 3) + 'ä»¶';
                }
            } else if (format === 'json') {
                var jsonData = taskData.slice(0, 2).map(function(task) {
                    var obj = {};
                    fields.forEach(function(f) {
                        obj[f] = getTaskFieldValue(taskData[taskData.indexOf(task)], f);
                    });
                    return obj;
                });
                preview = JSON.stringify(jsonData, null, 2);
                if (taskData.length > 2) {
                    preview += '\n... ä»– ' + (taskData.length - 2) + 'ä»¶';
                }
            } else if (format === 'excel') {
                preview = '[Excelãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼]\n';
                preview += 'ãƒ˜ãƒƒãƒ€ãƒ¼: ' + fields.map(function(f) { return getFieldLabel(f); }).join(' | ') + '\n';
                preview += 'ãƒ‡ãƒ¼ã‚¿: ' + taskData.length + 'è¡Œ';
            }

            $('#export-preview').text(preview);
        }

        function executeExport() {
            var format = $('input[name="export-format"]:checked').val();
            var fields = getSelectedExportFields();

            if (fields.length === 0) {
                alert('å‡ºåŠ›é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            var content = '';
            var filename = 'tasks_' + new Date().toISOString().slice(0, 10);
            var mimeType = '';

            if (format === 'csv') {
                // BOMä»˜ãUTF-8 CSV
                var headers = fields.map(function(f) { return getFieldLabel(f); });
                content = '\uFEFF' + headers.join(',') + '\n';

                taskData.forEach(function(task) {
                    var values = fields.map(function(f) {
                        var val = getTaskFieldValue(task, f);
                        // ã‚«ãƒ³ãƒã€æ”¹è¡Œã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’å«ã‚€å ´åˆã®å‡¦ç†
                        if (val.indexOf(',') >= 0 || val.indexOf('\n') >= 0 || val.indexOf('"') >= 0) {
                            val = '"' + val.replace(/"/g, '""') + '"';
                        }
                        return val;
                    });
                    content += values.join(',') + '\n';
                });

                filename += '.csv';
                mimeType = 'text/csv;charset=utf-8';

            } else if (format === 'json') {
                var jsonData = taskData.map(function(task) {
                    var obj = {};
                    fields.forEach(function(f) {
                        obj[f] = getTaskFieldValue(task, f);
                    });
                    return obj;
                });
                content = JSON.stringify(jsonData, null, 2);
                filename += '.json';
                mimeType = 'application/json;charset=utf-8';

            } else if (format === 'excel') {
                // ã‚·ãƒ³ãƒ—ãƒ«ãªXMLå½¢å¼ã®Excelï¼ˆSpreadsheetMLï¼‰
                content = '<?xml version="1.0" encoding="UTF-8"?>\n';
                content += '<?mso-application progid="Excel.Sheet"?>\n';
                content += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"\n';
                content += ' xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n';
                content += '<Worksheet ss:Name="ã‚¿ã‚¹ã‚¯ä¸€è¦§">\n';
                content += '<Table>\n';

                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
                content += '<Row>\n';
                fields.forEach(function(f) {
                    content += '<Cell><Data ss:Type="String">' + escapeXml(getFieldLabel(f)) + '</Data></Cell>\n';
                });
                content += '</Row>\n';

                // ãƒ‡ãƒ¼ã‚¿è¡Œ
                taskData.forEach(function(task) {
                    content += '<Row>\n';
                    fields.forEach(function(f) {
                        content += '<Cell><Data ss:Type="String">' + escapeXml(getTaskFieldValue(task, f)) + '</Data></Cell>\n';
                    });
                    content += '</Row>\n';
                });

                content += '</Table>\n';
                content += '</Worksheet>\n';
                content += '</Workbook>';

                filename += '.xls';
                mimeType = 'application/vnd.ms-excel;charset=utf-8';
            }

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
            var blob = new Blob([content], { type: mimeType });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            closeExportModal();
            alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ: ' + filename);
        }

        function escapeXml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        // ===== ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ =====
        function openImportModal() {
            $('#import-modal').addClass('show');
            $('#paste-area').val('');
            $('#import-preview').addClass('hidden');
            $('#import-btn').prop('disabled', true);
            importPreviewData = [];
        }

        function closeImportModal() {
            $('#import-modal').removeClass('show');
        }

        function setupImportDropZone() {
            var $dropZone = $('#drop-zone');

            $dropZone.on('dragover', function(e) {
                e.preventDefault();
                $(this).addClass('drag-over');
            });

            $dropZone.on('dragleave', function(e) {
                e.preventDefault();
                $(this).removeClass('drag-over');
            });

            $dropZone.on('drop', function(e) {
                e.preventDefault();
                $(this).removeClass('drag-over');

                var files = e.originalEvent.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        function handleFileSelect(event) {
            var file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            var fileName = file.name.toLowerCase();

            if (fileName.endsWith('.csv')) {
                readCSVFile(file);
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                alert('Excelå½¢å¼ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚CSVã¾ãŸã¯ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã®è²¼ã‚Šä»˜ã‘ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
            } else {
                alert('å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚CSVå½¢å¼ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
            }
        }

        function readCSVFile(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var text = e.target.result;
                parseClipboardData(text);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseClipboardData(text) {
            var lines = text.trim().split('\n');
            importPreviewData = [];

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è§£æã—ã¦ã‚«ãƒ©ãƒ ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆ
            var headerMap = {};
            var hasHeader = false;

            lines.forEach(function(line, index) {
                // ã‚¿ãƒ–ã¾ãŸã¯ã‚«ãƒ³ãƒã§åˆ†å‰²
                var cols = line.includes('\t') ? line.split('\t') : line.split(',');

                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’æ¤œå‡º
                if (index === 0 && (line.includes('ã‚¿ã‚¹ã‚¯å') || line.includes('No') || line.includes('äºˆå®š') || line.includes('å®Ÿç¸¾'))) {
                    hasHeader = true;
                    cols.forEach(function(col, colIndex) {
                        var colName = col.trim().toLowerCase();
                        if (colName.includes('no') || colName === 'no') headerMap.order = colIndex;
                        else if (colName.includes('ã‚¿ã‚¹ã‚¯å') || colName.includes('å')) headerMap.name = colIndex;
                        else if (colName.includes('æ‹…å½“')) headerMap.assignee = colIndex;
                        else if (colName.includes('ã‚°ãƒ«ãƒ¼ãƒ—')) headerMap.group = colIndex;
                        else if (colName.includes('äºˆå®šé–‹å§‹') || colName === 'äºˆå®šé–‹å§‹æ—¥') headerMap.startDate = colIndex;
                        else if (colName.includes('äºˆå®šçµ‚äº†') || colName === 'äºˆå®šçµ‚äº†æ—¥') headerMap.endDate = colIndex;
                        else if (colName.includes('äºˆå®šå·¥æ•°')) headerMap.manDays = colIndex;
                        else if (colName.includes('äºˆå®šåŸä¾¡')) headerMap.cost = colIndex;
                        else if (colName.includes('å®Ÿç¸¾é–‹å§‹') || colName === 'å®Ÿç¸¾é–‹å§‹æ—¥') headerMap.actualStart = colIndex;
                        else if (colName.includes('å®Ÿç¸¾çµ‚äº†') || colName === 'å®Ÿç¸¾çµ‚äº†æ—¥') headerMap.actualEnd = colIndex;
                        else if (colName.includes('å®Ÿç¸¾å·¥æ•°')) headerMap.actualManDays = colIndex;
                        else if (colName.includes('å®Ÿç¸¾åŸä¾¡')) headerMap.actualCost = colIndex;
                        else if (colName.includes('é€²æ—')) headerMap.progress = colIndex;
                    });
                    return;
                }

                // ãƒ‡ãƒ¼ã‚¿è¡Œ
                if (cols.length >= 2) {
                    var row = {};
                    if (hasHeader) {
                        // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½¿ç”¨
                        row.order = headerMap.order !== undefined ? (cols[headerMap.order] || '').trim() : '';
                        row.name = headerMap.name !== undefined ? (cols[headerMap.name] || '').trim() : '';
                        row.assignee = headerMap.assignee !== undefined ? (cols[headerMap.assignee] || '').trim() : '';
                        row.group = headerMap.group !== undefined ? (cols[headerMap.group] || '').trim() : '';
                        row.startDate = headerMap.startDate !== undefined ? (cols[headerMap.startDate] || '').trim() : '';
                        row.endDate = headerMap.endDate !== undefined ? (cols[headerMap.endDate] || '').trim() : '';
                        row.manDays = headerMap.manDays !== undefined ? parseFloat((cols[headerMap.manDays] || '').replace(/æ—¥/g, '')) || 0 : 0;
                        row.cost = headerMap.cost !== undefined ? parseFloat((cols[headerMap.cost] || '').replace(/ä¸‡/g, '')) || 0 : 0;
                        row.actualStart = headerMap.actualStart !== undefined ? (cols[headerMap.actualStart] || '').trim() : '';
                        row.actualEnd = headerMap.actualEnd !== undefined ? (cols[headerMap.actualEnd] || '').trim() : '';
                        row.actualManDays = headerMap.actualManDays !== undefined ? parseFloat((cols[headerMap.actualManDays] || '').replace(/æ—¥/g, '')) || null : null;
                        row.actualCost = headerMap.actualCost !== undefined ? parseFloat((cols[headerMap.actualCost] || '').replace(/ä¸‡/g, '')) || null : null;
                        row.progress = headerMap.progress !== undefined ? parseFloat((cols[headerMap.progress] || '').replace(/%/g, '')) || 0 : 0;
                    } else {
                        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé †åºï¼ˆå¾“æ¥äº’æ›ï¿½ï¿½ï¿½
                        row.order = (cols[0] || '').trim();
                        row.name = (cols[1] || '').trim();
                        row.assignee = (cols[2] || '').trim();
                        row.manDays = parseFloat(cols[3]) || 0;
                        row.cost = parseFloat(cols[4]) || 0;
                        row.startDate = (cols[5] || '').trim();
                        row.endDate = (cols[6] || '').trim();
                    }
                    importPreviewData.push(row);
                }
            });

            if (importPreviewData.length > 0) {
                showImportPreview();
            }
        }

        function showImportPreview() {
            var $preview = $('#import-preview');
            var $body = $('#preview-body');
            var $count = $('#preview-count');

            $body.empty();
            importPreviewData.forEach(function(row) {
                $body.append(
                    '<tr class="border-b border-slate-100">' +
                        '<td class="px-2 py-1">' + row.order + '</td>' +
                        '<td class="px-2 py-1">' + row.name + '</td>' +
                        '<td class="px-2 py-1">' + row.assignee + '</td>' +
                        '<td class="px-2 py-1 text-right">' + row.manDays + '</td>' +
                        '<td class="px-2 py-1 text-right">' + row.cost + '</td>' +
                        '<td class="px-2 py-1">' + row.startDate + '</td>' +
                        '<td class="px-2 py-1">' + row.endDate + '</td>' +
                    '</tr>'
                );
            });

            $count.text(importPreviewData.length);
            $preview.removeClass('hidden');
            $('#import-btn').prop('disabled', false);
        }

        function executeImport() {
            if (importPreviewData.length === 0) {
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            var updatedCount = 0;
            var insertedCount = 0;

            importPreviewData.forEach(function(row) {
                var no = row.order;
                // åŒã˜Noã®ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢
                var existingTask = taskData.find(function(t) { return t.no === no; });

                if (existingTask) {
                    // æ—¢å­˜ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°
                    existingTask.name = row.name || existingTask.name;
                    existingTask.assignee = row.assignee || existingTask.assignee;
                    existingTask.manDays = row.manDays || existingTask.manDays;
                    existingTask.cost = row.cost || existingTask.cost;
                    existingTask.planStart = row.startDate || existingTask.planStart;
                    existingTask.planEnd = row.endDate || existingTask.planEnd;
                    // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°æ›´æ–°
                    if (row.actualStart) existingTask.actualStart = row.actualStart;
                    if (row.actualEnd) existingTask.actualEnd = row.actualEnd;
                    if (row.actualManDays) existingTask.actualManDays = row.actualManDays;
                    if (row.actualCost) existingTask.actualCost = row.actualCost;
                    if (row.progress !== undefined) existingTask.progress = row.progress;
                    modifiedTaskIds.add(existingTask.id);
                    updatedCount++;
                } else {
                    // æ–°è¦ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
                    var newTask = {
                        id: no || 'imported-' + Date.now() + '-' + insertedCount,
                        no: no,
                        name: row.name,
                        type: determineTaskType(no),
                        group: row.group || '',
                        assignee: row.assignee || '-',
                        manDays: row.manDays || 1,
                        cost: row.cost || 0,
                        planStart: row.startDate || '-',
                        planEnd: row.endDate || '-',
                        actualManDays: row.actualManDays || null,
                        actualCost: row.actualCost || null,
                        actualStart: row.actualStart || '-',
                        actualEnd: row.actualEnd || '-',
                        progress: row.progress || 0,
                        delay: { type: 'ontime', text: '-' }
                    };
                    taskData.push(newTask);
                    modifiedTaskIds.add(newTask.id);
                    insertedCount++;
                }
            });

            // å†æç”»
            generateTaskList();
            generateGanttBody();

            // è¦ªãƒ»å·¥ç¨‹ã®æ—¥ä»˜ã‚’å†è¨ˆç®—ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã¯å¤‰æ›´ãƒãƒ¼ã‚¯ã™ã‚‹ï¼‰
            recalculateAllParentDates(true);

            if (currentEditMode === 'edit') {
                enableEditMode();
            } else {
                disableEditMode();
            }

            var message = '';
            if (updatedCount > 0) message += updatedCount + 'ä»¶ã‚’æ›´æ–°';
            if (insertedCount > 0) {
                if (message) message += 'ã€';
                message += insertedCount + 'ä»¶ã‚’æ–°è¦è¿½åŠ ';
            }
            alert(message + 'ã—ã¾ã—ãŸã€‚');
            closeImportModal();
            hasUnsavedChanges = true;
            updateSaveButtonState();
        }

        // Noã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š
        function determineTaskType(no) {
            if (!no) return 'child';
            var parts = no.split('-');
            if (parts.length === 1) return 'parent';
            if (parts.length === 2) return 'child';
            return 'grandchild';
        }

        // ========================================
        // é¸æŠæ©Ÿèƒ½
        // ========================================

        // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        $('#select-all, #select-all-actual').on('change', function() {
            var isChecked = $(this).prop('checked');
            $('.row-checkbox').prop('checked', isChecked);
            // ä¸¡æ–¹ã®å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’åŒæœŸ
            $('#select-all, #select-all-actual').prop('checked', isChecked);
            updateSelectionCount();
            updateRowSelection();
        });

        // è¡Œãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²
        $(document).on('change', '.row-checkbox', function() {
            updateSelectionCount();
            updateRowSelection();
            // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹æ›´æ–°
            var allCheckboxes = $('.row-checkbox');
            var checkedBoxes = $('.row-checkbox:checked');
            var isAllChecked = allCheckboxes.length === checkedBoxes.length && allCheckboxes.length > 0;
            $('#select-all, #select-all-actual').prop('checked', isAllChecked);
        });

        // é¸æŠæ•°æ›´æ–°
        function updateSelectionCount() {
            var checkedBoxes = $('.row-checkbox:checked');
            var count = checkedBoxes.length;
            var actionBar = $('#selection-action-bar');
            var countEl = $('#selected-count');

            if (count > 0) {
                actionBar.removeClass('hidden');
                countEl.text(count);
            } else {
                actionBar.addClass('hidden');
            }
        }

        // é¸æŠã•ã‚ŒãŸè¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
        function updateRowSelection() {
            $('.task-row-item').each(function() {
                var checkbox = $(this).find('.row-checkbox');
                if (checkbox.prop('checked')) {
                    $(this).addClass('selected');
                } else {
                    $(this).removeClass('selected');
                }
            });
        }

        // é¸æŠè§£é™¤
        function clearSelection() {
            $('#select-all, #select-all-actual').prop('checked', false);
            $('.row-checkbox').prop('checked', false);
            updateSelectionCount();
            updateRowSelection();
        }

        // é¸æŠã•ã‚ŒãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
        function getSelectedIndices() {
            var indices = [];
            $('.row-checkbox').each(function(index) {
                if ($(this).prop('checked')) {
                    var dataIndex = $(this).closest('.task-row-item').data('index');
                    if (dataIndex !== undefined) {
                        indices.push(parseInt(dataIndex));
                    }
                }
            });
            return indices;
        }

        // ========================================
        // ä¸€æ‹¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
        // ========================================

        // ä¸€æ‹¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openBulkEditModal() {
            var selectedIndices = getSelectedIndices();
            if (selectedIndices.length === 0) {
                alert('ã‚¿ã‚¹ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            $('#bulk-edit-count').text(selectedIndices.length);
            $('#bulk-assignee').val('');
            $('#bulk-progress').val('');
            $('#bulk-process').val('');
            $('#bulk-edit-modal').removeClass('hidden');
        }

        // ä¸€æ‹¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeBulkEditModal() {
            $('#bulk-edit-modal').addClass('hidden');
        }

        // ä¸€æ‹¬ç·¨é›†ã‚’é©ç”¨
        function applyBulkEdit() {
            var selectedIndices = getSelectedIndices();
            if (selectedIndices.length === 0) return;

            var assignee = $('#bulk-assignee').val();
            var progress = $('#bulk-progress').val();
            var process = $('#bulk-process').val();

            if (!assignee && !progress && !process) {
                alert('å¤‰æ›´ã™ã‚‹é …ç›®ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            selectedIndices.forEach(function(index) {
                if (assignee) taskData[index].assignee = assignee;
                if (progress !== '') taskData[index].progress = parseInt(progress);
                if (process) taskData[index].process = process;
                modifiedTaskIds.add(taskData[index].id);
            });

            generateTaskList();
            generateGanttChart();
            closeBulkEditModal();
            clearSelection();
            alert(selectedIndices.length + 'ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
        }

        // ä¸€æ‹¬å‰Šé™¤
        function bulkDelete() {
            var selectedIndices = getSelectedIndices();
            if (selectedIndices.length === 0) {
                alert('ã‚¿ã‚¹ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (!confirm(selectedIndices.length + 'ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            // å¾Œã‚ã‹ã‚‰å‰Šé™¤ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒãšã‚Œãªã„ã‚ˆã†ã«ï¼‰
            selectedIndices.sort(function(a, b) { return b - a; }).forEach(function(index) {
                taskData.splice(index, 1);
            });

            generateTaskList();
            generateGanttChart();
            clearSelection();
            alert('å‰Šé™¤ã—ã¾ã—ãŸã€‚');
        }

        // ========================================
        // ãƒšãƒ¼ã‚¹ãƒˆæ©Ÿèƒ½
        // ========================================

        // ãƒšãƒ¼ã‚¹ãƒˆé ˜åŸŸã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
        var pasteArea = document.getElementById('paste-area');
        if (pasteArea) {
            pasteArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                pasteArea.classList.add('dragover');
            });
            pasteArea.addEventListener('dragleave', function() {
                pasteArea.classList.remove('dragover');
            });
            pasteArea.addEventListener('drop', function(e) {
                e.preventDefault();
                pasteArea.classList.remove('dragover');
            });
        }

        // ãƒšãƒ¼ã‚¹ãƒˆå‡¦ç†
        function handlePaste(event) {
            event.preventDefault();
            var pasteData = (event.clipboardData || window.clipboardData).getData('text');
            if (!pasteData) return;

            var rows = pasteData.trim().split('\n');
            if (rows.length === 0) return;

            var newTasks = [];
            var maxId = Math.max.apply(null, taskData.map(function(t) { return t.id; })) || 0;

            rows.forEach(function(row, index) {
                var cols = row.includes('\t') ? row.split('\t') : row.split(',');
                if (cols.length < 2 || !cols[0].trim()) return;

                maxId++;
                newTasks.push({
                    id: maxId,
                    no: '',
                    type: 'child',
                    name: cols[0]?.trim() || '',
                    assignee: cols[1]?.trim() || '-',
                    manDays: parseFloat(cols[2]) || 1,
                    cost: parseFloat(cols[3]) || 0,
                    planStart: cols[4]?.trim() || '',
                    planEnd: cols[5]?.trim() || '',
                    actualManDays: cols[6]?.trim() || '',
                    actualCost: cols[7]?.trim() || '',
                    actualStart: cols[8]?.trim() || '',
                    actualEnd: cols[9]?.trim() || '',
                    progress: parseInt(cols[10]) || 0,
                    delay: { type: 'none', text: '-', days: 0 },
                    group: ''
                });
            });

            if (newTasks.length > 0) {
                taskData = taskData.concat(newTasks);
                newTasks.forEach(function(t) { modifiedTaskIds.add(t.id); });
                generateTaskList();
                generateGanttChart();
                alert(newTasks.length + 'ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚');
            } else {
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            }
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function handleFileImport(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                var content = e.target.result;
                var rows = content.trim().split('\n');

                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                var dataRows = rows.slice(1);

                if (dataRows.length === 0) {
                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }

                var newTasks = [];
                var maxId = Math.max.apply(null, taskData.map(function(t) { return t.id; })) || 0;

                dataRows.forEach(function(row) {
                    var cols = row.includes('\t') ? row.split('\t') : row.split(',');
                    if (cols.length < 2 || !cols[0].trim()) return;

                    maxId++;
                    newTasks.push({
                        id: maxId,
                        no: '',
                        type: 'child',
                        name: cols[0]?.trim() || '',
                        assignee: cols[1]?.trim() || '-',
                        manDays: parseFloat(cols[2]) || 1,
                        cost: parseFloat(cols[3]) || 0,
                        planStart: cols[4]?.trim() || '',
                        planEnd: cols[5]?.trim() || '',
                        actualManDays: cols[6]?.trim() || '',
                        actualCost: cols[7]?.trim() || '',
                        actualStart: cols[8]?.trim() || '',
                        actualEnd: cols[9]?.trim() || '',
                        progress: parseInt(cols[10]) || 0,
                        delay: { type: 'none', text: '-', days: 0 },
                        group: ''
                    });
                });

                if (newTasks.length > 0) {
                    taskData = taskData.concat(newTasks);
                    newTasks.forEach(function(t) { modifiedTaskIds.add(t.id); });
                    generateTaskList();
                    generateGanttChart();
                    alert(newTasks.length + 'ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚');
                } else {
                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                }

                event.target.value = '';
            };
            reader.readAsText(file, 'UTF-8');
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadTemplate() {
            var headers = ['ã‚¿ã‚¹ã‚¯å', 'æ‹…å½“è€…', 'å·¥æ•°', 'åŸä¾¡', 'é–‹å§‹æ—¥', 'çµ‚äº†æ—¥', 'å®Ÿå·¥æ•°', 'å®ŸåŸä¾¡', 'å®Ÿé–‹å§‹æ—¥', 'å®Ÿçµ‚äº†æ—¥', 'é€²æ—'];
            var sampleData = [
                ['ç”»é¢è¨­è¨ˆ', 'å±±ç”°', '2', '10', '2024-04-01', '2024-04-05', '', '', '', '', '0'],
                ['ãƒ•ãƒ­ãƒ³ãƒˆå®Ÿè£…', 'ä½è—¤', '3', '15', '2024-04-06', '2024-04-10', '', '', '', '', '0'],
            ];

            var csvContent = [headers.join(',')].concat(sampleData.map(function(row) { return row.join(','); })).join('\n');
            var bom = '\uFEFF';
            var blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);

            var link = document.createElement('a');
            link.href = url;
            link.download = 'schedule_template.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // è¡Œè¿½åŠ 
        function addNewRow() {
            var maxId = Math.max.apply(null, taskData.map(function(t) { return t.id; })) || 0;
            var newTask = {
                id: maxId + 1,
                no: '',
                type: 'child',
                name: 'æ–°è¦ã‚¿ã‚¹ã‚¯',
                assignee: '-',
                manDays: 1,
                cost: 0,
                planStart: '',
                planEnd: '',
                actualManDays: '',
                actualCost: '',
                actualStart: '',
                actualEnd: '',
                progress: 0,
                delay: { type: 'none', text: '-', days: 0 },
                group: ''
            };
            taskData.push(newTask);
            modifiedTaskIds.add(newTask.id);
            generateTaskList();
            generateGanttChart();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearAllData() {
            if (!confirm('ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
            taskData = [];
            modifiedTaskIds.clear();
            generateTaskList();
            generateGanttChart();
        }

        // ESCã‚­ãƒ¼ã§ä¸€æ‹¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚é–‰ã˜ã‚‹
        $(document).on('keydown', function(e) {
            if (e.key === 'Escape') {
                closeBulkEditModal();
            }
        });

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ™‚ã«ãƒšãƒ¼ã‚¹ãƒˆãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
        // Note: toggleEditModeãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ‹¡å¼µ
        if (typeof toggleEditMode === 'function') {
            var originalToggleEditMode = toggleEditMode;
            toggleEditMode = function(mode) {
                originalToggleEditMode(mode);
                if (mode === 'edit') {
                    $('#paste-panel').removeClass('hidden');
                } else {
                    $('#paste-panel').addClass('hidden');
                }
            };
        }

        // ========================================
        // ã‚«ãƒ©ãƒ ä¸¦ã³æ›¿ãˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½
        // ========================================
        var currentSortColumn = null;
        var currentSortOrder = null;
        var currentFilterColumn = null;
        var currentFilterValue = null;
        var originalTaskData = [...taskData];

        function openColumnMenu(event, column) {
            event.stopPropagation();
            var menu = $('#column-menu');
            var header = $(event.currentTarget);

            // ä½ç½®ã‚’è¨ˆç®—
            var rect = header[0].getBoundingClientRect();
            menu.css({
                left: rect.left + 'px',
                top: rect.bottom + 'px'
            });

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é¸æŠè‚¢ã‚’ç”Ÿæˆ
            var filterSelect = $('#column-filter-select');
            filterSelect.empty();
            filterSelect.append('<option value="">ã™ã¹ã¦è¡¨ç¤º</option>');

            var uniqueValues = new Set();
            originalTaskData.forEach(function(task) {
                var value = getColumnValue(task, column);
                if (value !== undefined && value !== null && value !== '') {
                    uniqueValues.add(String(value));
                }
            });

            Array.from(uniqueValues).sort().forEach(function(value) {
                var selected = (currentFilterColumn === column && currentFilterValue === value) ? ' selected' : '';
                filterSelect.append('<option value="' + value + '"' + selected + '>' + value + '</option>');
            });

            // æ‹…å½“è€…ã®å ´åˆã¯ç‰¹åˆ¥ãªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (column === 'assignee') {
                filterSelect.empty();
                filterSelect.append('<option value="">ã™ã¹ã¦è¡¨ç¤º</option>');
                ['å±±ç”°', 'ä½è—¤', 'éˆ´æœ¨', 'ç”°ä¸­', 'é«˜æ©‹'].forEach(function(name) {
                    var selected = (currentFilterColumn === column && currentFilterValue === name) ? ' selected' : '';
                    filterSelect.append('<option value="' + name + '"' + selected + '>' + name + '</option>');
                });
            }

            // é€²æ—ã®å ´åˆ
            if (column === 'progress') {
                filterSelect.empty();
                filterSelect.append('<option value="">ã™ã¹ã¦è¡¨ç¤º</option>');
                filterSelect.append('<option value="0"' + (currentFilterValue === '0' ? ' selected' : '') + '>æœªç€æ‰‹(0%)</option>');
                filterSelect.append('<option value="1-99"' + (currentFilterValue === '1-99' ? ' selected' : '') + '>é€²è¡Œä¸­(1-99%)</option>');
                filterSelect.append('<option value="100"' + (currentFilterValue === '100' ? ' selected' : '') + '>å®Œäº†(100%)</option>');
            }

            // é…å»¶ã®å ´åˆ
            if (column === 'delay') {
                filterSelect.empty();
                filterSelect.append('<option value="">ã™ã¹ã¦è¡¨ç¤º</option>');
                filterSelect.append('<option value="late"' + (currentFilterValue === 'late' ? ' selected' : '') + '>é…å»¶ã‚ã‚Š</option>');
                filterSelect.append('<option value="ahead"' + (currentFilterValue === 'ahead' ? ' selected' : '') + '>å…ˆè¡Œ</option>');
                filterSelect.append('<option value="ontime"' + (currentFilterValue === 'ontime' ? ' selected' : '') + '>äºˆå®šé€šã‚Š</option>');
            }

            currentSortColumn = column;
            // ç¢ºå®Ÿã«è¡¨ç¤ºã™ã‚‹
            menu.css({
                'display': 'block',
                'visibility': 'visible',
                'opacity': '1'
            }).addClass('show');
        }

        function getColumnValue(task, column) {
            switch(column) {
                case 'no': return task.no;
                case 'name': return task.name;
                case 'assignee': return task.assignee;
                case 'manDays': return task.manDays;
                case 'planStart': return task.planStart;
                case 'planEnd': return task.planEnd;
                case 'actualStart': return task.actualStart;
                case 'actualEnd': return task.actualEnd;
                case 'progress': return task.progress;
                case 'delay': return task.delay ? task.delay.type : 'none';
                case 'customer': return task.projectId && allProjectsData[task.projectId] ? allProjectsData[task.projectId].customer : '';
                case 'project': return task.projectId && allProjectsData[task.projectId] ? allProjectsData[task.projectId].name : '';
                default: return '';
            }
        }

        function sortColumn(order) {
            currentSortOrder = order;
            var column = currentSortColumn;

            taskData.sort(function(a, b) {
                var valA = getColumnValue(a, column);
                var valB = getColumnValue(b, column);

                // æ•°å€¤ã®å ´åˆ
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return order === 'asc' ? valA - valB : valB - valA;
                }

                // æ–‡å­—åˆ—ã®å ´åˆ
                valA = String(valA || '');
                valB = String(valB || '');
                if (order === 'asc') {
                    return valA.localeCompare(valB, 'ja');
                } else {
                    return valB.localeCompare(valA, 'ja');
                }
            });

            // ã¾ãšãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            closeColumnMenu();

            // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            $('.column-header').removeClass('sorted');
            $('.column-header[data-column="' + column + '"]').addClass('sorted');
            $('.column-header .sort-icon').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
            $('.column-header[data-column="' + column + '"] .sort-icon')
                .removeClass('fa-sort')
                .addClass(order === 'asc' ? 'fa-sort-up' : 'fa-sort-down');

            generateTaskList();
            generateGanttChart();
        }

        function applyColumnFilter() {
            var value = $('#column-filter-select').val();
            var column = currentSortColumn;

            // ã¾ãšãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            closeColumnMenu();

            if (!value) {
                clearColumnFilter();
                return;
            }

            currentFilterColumn = column;
            currentFilterValue = value;

            taskData = originalTaskData.filter(function(task) {
                var taskValue = getColumnValue(task, column);

                // é€²æ—ã®ç‰¹åˆ¥å‡¦ç†
                if (column === 'progress') {
                    if (value === '0') return taskValue === 0;
                    if (value === '1-99') return taskValue > 0 && taskValue < 100;
                    if (value === '100') return taskValue === 100;
                }

                // é…å»¶ã®ç‰¹åˆ¥å‡¦ç†
                if (column === 'delay') {
                    return taskValue === value;
                }

                return String(taskValue) === value;
            });

            generateTaskList();
            generateGanttChart();
        }

        function clearColumnFilter() {
            // ã¾ãšãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            closeColumnMenu();

            currentFilterColumn = null;
            currentFilterValue = null;
            taskData = [...originalTaskData];
            generateTaskList();
            generateGanttChart();
        }

        function closeColumnMenu() {
            var $menu = $('#column-menu');
            $menu.removeClass('show');
            // ç¢ºå®Ÿã«éè¡¨ç¤ºã«ã™ã‚‹
            $menu.css({
                'display': 'none',
                'visibility': 'hidden',
                'opacity': '0'
            });
        }

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        $(document).on('click', function(e) {
            if (!$(e.target).closest('#column-menu, .column-header').length) {
                closeColumnMenu();
            }
        });

        // ========================================
        // å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ - é–¢æ•°å®šç¾©
        // ========================================
        function onProjectChange(value) {
            if (value === 'all') {
                // å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¨ªæ–­è¡¨ç¤º
                isAllProjectsMode = true;
                taskData = [...allProjectsTaskData];
                originalTaskData = [...allProjectsTaskData];
                // å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’1æœˆã‹ã‚‰é–‹å§‹
                MONTHS_DATA = generateMonthsDataFromJanuary();
                generateMonthSelect();
                generateCalendarHeaders();
                showProjectLegend();
                generateTaskList();
                generateGanttChart();
            } else {
                // é€šå¸¸ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¤º
                isAllProjectsMode = false;
                taskData = [...singleProjectTaskData];
                originalTaskData = [...singleProjectTaskData];
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã¯TODAYã‹ã‚‰é–‹å§‹
                MONTHS_DATA = generateMonthsData();
                generateMonthSelect();
                generateCalendarHeaders();
                hideProjectLegend();
                generateTaskList();
                generateGanttChart();
            }
        }

        // 1æœˆã‹ã‚‰é–‹å§‹ã™ã‚‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆï¼ˆå…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
        function generateMonthsDataFromJanuary() {
            var months = [];
            var year = TODAY.getFullYear();
            var startDate = new Date(year, 0, 1); // 1æœˆ1æ—¥ã‹ã‚‰é–‹å§‹

            for (var i = 0; i < 12; i++) {
                var y = startDate.getFullYear();
                var m = startDate.getMonth() + 1;
                var daysInMonth = new Date(y, m, 0).getDate();

                months.push({
                    year: y,
                    month: m,
                    days: daysInMonth,
                    name: y + 'å¹´' + m + 'æœˆ'
                });

                startDate.setMonth(startDate.getMonth() + 1);
            }
            return months;
        }

        // æ‹…å½“è€…åˆ¥ã‚µãƒãƒªãƒ¼ã‚’è¨ˆç®—
        function calculateAssigneeSummary() {
            var summary = {};

            allProjectsTaskData.forEach(function(task) {
                if (task.assignee === '-' || task.type === 'parent') return; // è¦ªã‚¿ã‚¹ã‚¯ã¨æœªå‰²å½“ã‚’ã‚¹ã‚­ãƒƒãƒ—

                var assignee = task.assignee;
                var projectId = task.projectId;
                var project = allProjectsData[projectId];
                if (!project) return;

                if (!summary[assignee]) {
                    summary[assignee] = {
                        totalDays: 0,
                        projects: {},
                        customers: {}
                    };
                }

                summary[assignee].totalDays += task.manDays;

                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥
                if (!summary[assignee].projects[projectId]) {
                    summary[assignee].projects[projectId] = {
                        name: project.name,
                        customer: project.customer,
                        color: project.color,
                        days: 0,
                        tasks: 0
                    };
                }
                summary[assignee].projects[projectId].days += task.manDays;
                summary[assignee].projects[projectId].tasks++;

                // é¡§å®¢åˆ¥
                var customer = project.customer;
                if (!summary[assignee].customers[customer]) {
                    summary[assignee].customers[customer] = 0;
                }
                summary[assignee].customers[customer] += task.manDays;
            });

            return summary;
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‡¡ä¾‹ã‚’è¡¨ç¤ºï¼ˆä¼šç¤¾ååˆ—ã‚‚è¿½åŠ ï¼‰
        function showProjectLegend() {
            // æ—¢å­˜ã®å‡¡ä¾‹ãŒã‚ã‚Œã°æ›´æ–°
            $('#project-legend').remove();

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‡¡ä¾‹
            var legendHtml = '<div id="project-legend" class="bg-white border-b border-slate-200 px-6 py-2">' +
                '<div class="flex items-center flex-wrap gap-3">' +
                '<span class="text-xs font-medium text-slate-600 mr-2">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</span>';

            Object.keys(allProjectsData).forEach(function(id) {
                var project = allProjectsData[id];
                legendHtml += '<div class="flex items-center">' +
                    '<div class="w-3 h-3 rounded mr-1" style="background: ' + project.color + '"></div>' +
                    '<span class="text-xs text-slate-600">' + project.name + '</span>' +
                '</div>';
            });

            legendHtml += '</div></div>';

            $('#search-panel').after(legendHtml);

            // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ä¼šç¤¾ååˆ—ã‚’è¿½åŠ 
            addCustomerColumnToHeader();
        }

        function hideProjectLegend() {
            $('#project-legend').hide();
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ä¼šç¤¾ååˆ—ã‚’å‰Šé™¤
            removeCustomerColumnFromHeader();
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ä¼šç¤¾åãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ—ã‚’è¿½åŠ ï¼ˆä¸€åˆ—ã«ã¾ã¨ã‚ã¦ä¸Šä¸‹è¡¨ç¤ºï¼‰
        function addCustomerColumnToHeader() {
            if ($('#header-plan .project-info-column').length === 0) {
                var projectInfoHeader = '<div class="px-1 text-xs font-bold text-slate-700 text-center border-r border-slate-200 column-header project-info-column resizable-column" data-column="project" style="width: 110px;" onclick="openColumnMenu(event, \'project\')">' +
                    '<div style="font-size: 9px; line-height: 1.1;" class="text-slate-500">ä¼šç¤¾å</div>' +
                    '<div style="font-size: 10px; line-height: 1.1;">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</div>' +
                    '<i class="fas fa-sort sort-icon"></i>' +
                    '<div class="column-resize-handle" onmousedown="startColumnResize(event, \'project\')"></div>' +
                '</div>';
                // Noåˆ—ã®å¾Œã«è¿½åŠ 
                $('#header-plan .column-header[data-column="no"]').after(projectInfoHeader);
                $('#header-actual .column-header[data-column="no"]').after(projectInfoHeader);
            }
        }

        // åˆ—å¹…ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½
        var resizingColumn = null;
        var resizeStartX = 0;
        var resizeStartWidth = 0;

        function startColumnResize(event, columnName) {
            event.stopPropagation();
            event.preventDefault();
            resizingColumn = columnName;
            resizeStartX = event.clientX;

            var headerSelector = columnName === 'project' ? '.project-info-column' :
                                 columnName === 'name' ? '.column-header[data-column="name"]' : null;
            if (headerSelector) {
                resizeStartWidth = $(headerSelector).first().outerWidth();
            }

            $(document).on('mousemove.columnResize', handleColumnResize);
            $(document).on('mouseup.columnResize', stopColumnResize);
        }

        function handleColumnResize(event) {
            if (!resizingColumn) return;

            var diff = event.clientX - resizeStartX;
            var newWidth = Math.max(60, resizeStartWidth + diff);

            if (resizingColumn === 'project') {
                $('.project-info-column').css('width', newWidth + 'px');
                $('.project-info-cell').css('width', newWidth + 'px');
            } else if (resizingColumn === 'name') {
                // ã‚¿ã‚¹ã‚¯ååˆ—ã¯flex-1ãªã®ã§ã€min-widthã‚’èª¿æ•´
                $('.column-header[data-column="name"]').css('min-width', newWidth + 'px');
                $('.task-name-cell').css('min-width', newWidth + 'px');
            }
        }

        function stopColumnResize() {
            resizingColumn = null;
            $(document).off('mousemove.columnResize');
            $(document).off('mouseup.columnResize');
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±åˆ—ã‚’å‰Šé™¤
        function removeCustomerColumnFromHeader() {
            $('.project-info-column').remove();
        }

        // æ‹…å½“è€…ç¨¼åƒãƒšãƒ¼ã‚¸ã‚’é–‹ã
        function openAssigneeWorkloadPage() {
            window.open('assignee_workload.html', '_blank');
        }

        // ã‚¿ã‚¹ã‚¯åãƒãƒƒã‚¸ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openTaskModalFromBadge(event, taskId) {
            event.stopPropagation();
            // ã‚¿ã‚¹ã‚¯è¡Œã‚’å–å¾—ã—ã¦selectedTaskRowã«è¨­å®š
            selectedTaskRow = $(event.target).closest('.task-row-item')[0];
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ç·¨é›†å¯èƒ½ã€ãã‚Œä»¥å¤–ã¯å‚ç…§ãƒ¢ãƒ¼ãƒ‰
            openTaskModal(currentEditMode === 'edit' ? 'edit' : 'view');
        }

        // generateTaskListã‚’æ‹¡å¼µï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’è¡¨ç¤ºï¼‰
        var originalGenerateTaskList = generateTaskList;
        generateTaskList = function() {
            var $taskList = $('#task-list');
            $taskList.empty();

            taskData.forEach(function(task) {
                var isParent = task.type === 'parent';
                var isChild = task.type === 'child';
                var isGrandchild = task.type === 'grandchild';
                var isModified = modifiedTaskIds.has(task.id);

                var bgClass = isParent ? 'bg-slate-50' : '';
                var borderClass = isParent ? 'border-b border-slate-200' : 'border-b border-slate-100';
                var modifiedClass = isModified ? 'task-row-modified' : '';
                var paddingClass = isGrandchild ? 'pl-10' : (isChild ? 'pl-5' : '');

                var assigneeColor = ASSIGNEE_COLORS[task.assignee] || 'from-gray-400 to-gray-500';
                var progressColorClass = task.progress === 100 ? 'text-emerald-600' :
                                          (task.progress > 0 ? 'text-blue-600' : 'text-slate-400');
                var delayBadgeClass = 'delay-' + task.delay.type;

                // å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¤ºæ™‚ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ©ãƒ¼ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚’è¿½åŠ 
                var projectIndicator = '';
                if (isAllProjectsMode && task.projectId) {
                    var projectColor = allProjectsData[task.projectId] ? allProjectsData[task.projectId].color : '#94a3b8';
                    projectIndicator = '<div class="w-1 h-full absolute left-0 top-0" style="background: ' + projectColor + '"></div>';
                }

                var assigneeHtml = task.assignee === '-' ?
                    '<span class="text-slate-500 text-xs">-</span>' :
                    '<div class="flex items-center justify-center">' +
                        '<div class="w-5 h-5 rounded-full bg-gradient-to-br ' + assigneeColor + ' mr-1"></div>' +
                        '<span class="text-xs text-slate-600">' + task.assignee + '</span>' +
                    '</div>';

                var costDisplay = task.cost ? task.cost + 'ä¸‡' : '-';
                var actualCostDisplay = task.actualCost ? task.actualCost + 'ä¸‡' : '-';

                // ã‚¿ã‚¹ã‚¯åã‚’ãƒªãƒ³ã‚¯ã‚¹ã‚¿ã‚¤ãƒ«ã«ã—ã¦ã€ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                var taskNameHtml = '';
                var linkClass = isParent ? 'task-name-link parent' : 'task-name-link';
                taskNameHtml = '<span class="' + linkClass + ' text-sm truncate" data-task-id="' + task.id + '" onclick="openTaskModalFromBadge(event, \'' + task.id + '\')">' + task.name + '<i class="fas fa-external-link-alt"></i></span>';

                // å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ä¼šç¤¾åãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’ä¸€åˆ—ï¼ˆä¸Šä¸‹ä¸¦ã³ï¼‰ã§è¡¨ç¤º
                var projectInfoColumnHtml = '';
                if (isAllProjectsMode && task.projectId && allProjectsData[task.projectId]) {
                    var customerName = allProjectsData[task.projectId].customer;
                    var projectName = allProjectsData[task.projectId].name;
                    // ä¼šç¤¾åã‚’çŸ­ç¸®è¡¨ç¤º
                    var shortCustomer = customerName.replace('æ ªå¼ä¼šç¤¾', '(æ ª)').replace('ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‰', 'Gãƒˆãƒ¬ãƒ¼ãƒ‰');
                    projectInfoColumnHtml = '<div class="px-1 border-r border-slate-200 project-info-cell" style="width: 110px;">' +
                        '<div class="text-xs text-slate-500 truncate" style="font-size: 10px; line-height: 1.2;" title="' + customerName + '">' + shortCustomer + '</div>' +
                        '<div class="text-xs text-slate-700 truncate font-medium" style="font-size: 11px; line-height: 1.2;" title="' + projectName + '">' + projectName + '</div>' +
                    '</div>';
                }

                var html = '<div class="flex task-row items-center ' + bgClass + ' ' + borderClass + ' hover:bg-blue-50/50 task-row-item ' + modifiedClass + ' relative" data-task="' + task.id + '" data-no="' + (task.no || '') + '" data-group="' + (task.group || '') + '" data-index="' + taskData.indexOf(task) + '" data-project="' + (task.projectId || '') + '">' +
                    projectIndicator +
                    '<div class="w-8 px-1 text-center border-r border-slate-200 flex items-center justify-center">' +
                        '<input type="checkbox" class="row-checkbox rounded border-slate-300 cursor-pointer" onclick="event.stopPropagation();">' +
                    '</div>' +
                    '<div class="w-14 px-1 text-center border-r border-slate-200">' +
                        '<span class="text-xs text-slate-600">' + (task.no || '-') + '</span>' +
                    '</div>' +
                    projectInfoColumnHtml +
                    '<div class="flex-1 px-2 ' + paddingClass + ' border-r border-slate-200 overflow-hidden">' +
                        taskNameHtml +
                    '</div>' +
                    '<div class="w-16 px-1 border-r border-slate-200">' + assigneeHtml + '</div>' +
                    '<div class="w-12 px-1 text-center border-r border-slate-200">' +
                        '<span class="plan-data text-xs ' + (isParent ? 'font-semibold' : '') + ' text-slate-600">' + task.manDays + 'æ—¥</span>' +
                        '<span class="actual-data text-xs ' + (isParent ? 'font-semibold' : '') + ' text-slate-600" style="display:none;">' + (task.actualManDays || '-') + (task.actualManDays ? 'æ—¥' : '') + '</span>' +
                    '</div>' +
                    '<div class="w-16 px-1 text-center border-r border-slate-200">' +
                        '<span class="plan-data text-xs ' + (isParent ? 'font-semibold' : '') + ' text-slate-700">' + costDisplay + '</span>' +
                        '<span class="actual-data text-xs ' + (isParent ? 'font-semibold' : '') + ' text-slate-700" style="display:none;">' + actualCostDisplay + '</span>' +
                    '</div>' +
                    '<div class="w-16 px-1 text-center border-r border-slate-200">' +
                        '<span class="plan-data text-xs text-slate-600">' + task.planStart + '</span>' +
                        '<span class="actual-data text-xs text-slate-600" style="display:none;">' + task.actualStart + '</span>' +
                    '</div>' +
                    '<div class="w-16 px-1 text-center border-r border-slate-200">' +
                        '<span class="plan-data text-xs text-slate-600">' + task.planEnd + '</span>' +
                        '<span class="actual-data text-xs text-slate-600" style="display:none;">' + task.actualEnd + '</span>' +
                    '</div>' +
                    '<div class="w-12 px-1 text-center border-r border-slate-200">' +
                        '<span class="text-xs ' + (isParent ? 'font-bold' : 'font-semibold') + ' ' + progressColorClass + '">' + task.progress + '%</span>' +
                    '</div>' +
                    '<div class="w-16 px-1 text-center">' +
                        '<span class="delay-badge ' + delayBadgeClass + '">' + task.delay.text + '</span>' +
                    '</div>' +
                '</div>';

                $taskList.append(html);
            });

            // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å†ãƒã‚¤ãƒ³ãƒ‰
            bindContextMenu();

            // ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºã‚’åæ˜ 
            switchMode(currentMode);
        };

        // generateGanttChartã‚’æ‹¡å¼µï¼ˆtaskDataã®é †åºã§ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚’ç”Ÿæˆï¼‰
        function generateGanttChart() {
            var $ganttBody = $('#gantt-body');
            $ganttBody.empty();

            var TASK_ROW_HEIGHT = 44;
            var totalHeight = taskData.length * TASK_ROW_HEIGHT;

            // ä»Šæ—¥ãƒãƒ¼ã‚«ãƒ¼ã®ä½ç½®ã‚’è¨ˆç®—
            var todayPosition = calculateTodayPosition();
            if (todayPosition >= 0) {
                var $todayMarker = $('<div>')
                    .addClass('absolute top-0 w-0.5 bg-amber-500 z-10')
                    .css({
                        'left': (todayPosition + CELL_WIDTH / 2) + 'px',
                        'height': totalHeight + 'px'
                    });
                $ganttBody.append($todayMarker);
            }

            // å…¨æ—¥æ•°ã‚’è¨ˆç®—
            var totalDays = 0;
            $.each(MONTHS_DATA, function(i, m) { totalDays += m.days; });
            var totalWidth = totalDays * CELL_WIDTH;

            // taskDataã®é †åºã§ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚’ç”Ÿæˆ
            taskData.forEach(function(task, index) {
                // TASK_DATAã‹ã‚‰å¯¾å¿œã™ã‚‹ã‚¬ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã€ã¾ãŸã¯è¨ˆç®—
                var ganttTask = TASK_DATA.find(function(t) { return t.id === task.id; });

                // å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã¯taskã‹ã‚‰ç›´æ¥æ—¥ä»˜æƒ…å ±ã‚’ä½¿ã†
                var startPos = 0;
                var barWidth = 0;
                var barColor = 'from-blue-400 to-blue-600';
                var barLabel = task.name;
                var textColor = 'text-white';
                var borderClass = '';

                if (isAllProjectsMode) {
                    // å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã¯æ—¥ä»˜ã‹ã‚‰ä½ç½®ã‚’è¨ˆç®—
                    var startDate = parseDisplayDate(task.planStart);
                    var endDate = parseDisplayDate(task.planEnd);
                    if (startDate && endDate) {
                        startPos = dateToDayIndex(startDate) * CELL_WIDTH;
                        var days = Math.max(1, Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1);
                        barWidth = days * CELL_WIDTH;
                    }

                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè‰²ã‚’ä½¿ç”¨
                    if (task.projectId && allProjectsData[task.projectId]) {
                        barColor = ''; // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã«ç©ºã«ã™ã‚‹ï¼ˆå¾Œã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè‰²ã‚’é©ç”¨ï¼‰
                    }

                    // è¦ªã‚¿ã‚¹ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ«
                    if (task.type === 'parent') {
                        barColor = 'from-slate-200 to-slate-300';
                        textColor = 'text-slate-700';
                        borderClass = 'border-2 border-slate-400';
                    }
                } else if (ganttTask) {
                    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯TASK_DATAã‹ã‚‰ä½ç½®ã‚’å–å¾—
                    startPos = ganttTask.start;
                    barWidth = ganttTask.width;
                    barColor = ganttTask.color;
                    barLabel = ganttTask.label;
                    textColor = ganttTask.textColor || 'text-white';
                    if (ganttTask.border) {
                        borderClass = 'border-2 ' + ganttTask.border;
                    }
                }

                var rowClass = 'flex items-center task-row border-b gantt-bar-row ' +
                               (task.type === 'parent' ? 'bg-slate-50 border-slate-200' : 'border-slate-100');
                var $row = $('<div>').addClass(rowClass).css('position', 'relative').attr('data-task', task.id);

                // èƒŒæ™¯ã‚»ãƒ«ï¼ˆé€±æœ«è‰²ãƒ»ä»Šæ—¥ãƒãƒ¼ã‚«ãƒ¼ç”¨ï¼‰
                var $bgContainer = $('<div>').addClass('flex').css({ 'position': 'absolute', 'left': 0, 'top': 0, 'bottom': 0 });
                $.each(MONTHS_DATA, function(monthIndex, monthData) {
                    for (var day = 1; day <= monthData.days; day++) {
                        var date = new Date(monthData.year, monthData.month - 1, day);
                        var weekday = date.getDay();
                        var isToday = date.getTime() === TODAY.getTime();
                        var isSaturday = weekday === 6;
                        var isSunday = weekday === 0;

                        var cellClass = 'border-r border-slate-100';
                        if (isToday) {
                            cellClass += ' today-marker';
                        } else if (isSunday) {
                            cellClass += ' weekend-sun';
                        } else if (isSaturday) {
                            cellClass += ' weekend-sat';
                        }
                        if (day === monthData.days) {
                            cellClass = cellClass.replace('border-slate-100', 'border-slate-300');
                        }
                        var $cell = $('<div>').addClass(cellClass).css({ 'min-width': CELL_WIDTH + 'px', 'width': CELL_WIDTH + 'px' });
                        $bgContainer.append($cell);
                    }
                });
                $row.append($bgContainer);

                // ã‚¿ã‚¹ã‚¯ãƒãƒ¼ç”¨ã‚³ãƒ³ãƒ†ãƒŠ
                var $container = $('<div>').addClass('relative flex items-center px-1').css({ 'width': totalWidth + 'px', 'height': '100%', 'z-index': 1 });

                if (startPos !== null && barWidth > 0) {
                    var barClassStr = 'task-bar task-bar-draggable absolute flex items-center ' + borderClass;
                    if (barColor) {
                        barClassStr += ' bg-gradient-to-r ' + barColor;
                    }

                    var $bar = $('<div>')
                        .addClass(barClassStr)
                        .css({
                            'left': startPos + 'px',
                            'width': barWidth + 'px'
                        })
                        .attr('data-task-id', task.id);

                    // å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè‰²ã§ä¸Šæ›¸ã
                    if (isAllProjectsMode && task.projectId && allProjectsData[task.projectId] && task.type !== 'parent') {
                        var projColor = allProjectsData[task.projectId].color;
                        $bar.css({
                            'background': 'linear-gradient(135deg, ' + projColor + ' 0%, ' + adjustColor(projColor, -20) + ' 100%)'
                        });
                    }

                    $bar.html(
                        '<div class="resize-handle resize-left"></div>' +
                        '<span class="text-sm ' + textColor + ' font-semibold ml-3 pointer-events-none">' + barLabel + '</span>' +
                        '<div class="resize-handle resize-right"></div>'
                    );
                    $container.append($bar);
                }

                $row.append($container);
                $ganttBody.append($row);
            });

            // ã‚¿ã‚¹ã‚¯ãƒãƒ¼ã®ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’è¨­å®š
            setupDragHandlers();

            // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã¨ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®é«˜ã•ã‚’åŒæœŸ
            syncPanelHeights();

            // å†ç”Ÿæˆå¾Œã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’åŒæœŸï¼ˆã‚¿ã‚¹ã‚¯ãƒ‘ãƒãƒ«ã®ä½ç½®ã«åˆã‚ã›ã‚‹ï¼‰
            setTimeout(function() {
                var $taskPanel = $('#task-panel');
                var $ganttScroll = $('#gantt-scroll');
                if ($taskPanel.length && $ganttScroll.length) {
                    $ganttScroll.scrollTop($taskPanel.scrollTop());
                }
            }, 200);
        }

        // ãƒ‘ãƒãƒ«é«˜ã•åŒæœŸ
        function syncPanelHeights() {
            setTimeout(function() {
                var $taskList = $('#task-list');
                var $ganttBody = $('#gantt-body');

                if ($taskList.length && $ganttBody.length) {
                    var taskHeight = $taskList.outerHeight();
                    var ganttHeight = $ganttBody.outerHeight();

                    // é«˜ã•ãŒç•°ãªã‚‹å ´åˆã€å¤§ãã„æ–¹ã«åˆã‚ã›ã‚‹
                    var maxHeight = Math.max(taskHeight, ganttHeight);
                    if (taskHeight !== ganttHeight) {
                        $ganttBody.css('min-height', maxHeight + 'px');
                    }
                }
            }, 150);
        }

        // æ—¥ä»˜ã‹ã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸Šã®æ—¥ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
        function dateToDayIndex(date) {
            var targetYear = date.getFullYear();
            var targetMonth = date.getMonth() + 1;
            var targetDay = date.getDate();

            var dayIndex = 0;
            for (var i = 0; i < MONTHS_DATA.length; i++) {
                if (MONTHS_DATA[i].year === targetYear && MONTHS_DATA[i].month === targetMonth) {
                    dayIndex += targetDay - 1;
                    return dayIndex;
                }
                dayIndex += MONTHS_DATA[i].days;
            }
            return dayIndex;
        }

        // è‰²ã‚’æš—ãã™ã‚‹é–¢æ•°
        function adjustColor(hex, amount) {
            var num = parseInt(hex.replace('#', ''), 16);
            var r = Math.max(0, Math.min(255, (num >> 16) + amount));
            var g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            var b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return '#' + (0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1);
        }
    </script>

    <!-- è¤‡æ•°é¸æŠãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
    <div id="selection-toolbar">
        <div class="flex items-center gap-4">
            <span id="selection-count" class="font-semibold">0ä»¶é¸æŠä¸­</span>
            <div class="flex items-center gap-2">
                <button onclick="openBulkEditModal()" class="px-4 py-2 bg-white text-blue-600 rounded-lg hover:bg-blue-50 transition-colors font-medium">
                    <i class="fas fa-edit mr-1"></i>ä¸€æ‹¬å¤‰æ›´
                </button>
                <button onclick="bulkMoveSelected(-1)" class="px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors" title="1æ—¥å‰ã¸ç§»å‹•">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button onclick="bulkMoveSelected(1)" class="px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors" title="1æ—¥å¾Œã¸ç§»å‹•">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <button onclick="clearTaskSelection()" class="px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors" title="é¸æŠè§£é™¤">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸€æ‹¬å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="bulk-edit-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">ä¸€æ‹¬å¤‰æ›´</h3>
                <button onclick="closeBulkEditModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-sm text-slate-600"><span id="bulk-edit-count">0</span>ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’ä¸€æ‹¬å¤‰æ›´ã—ã¾ã™</p>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">æ—¥ä»˜ç§»å‹•ï¼ˆæ—¥æ•°ï¼‰</label>
                    <div class="flex items-center gap-2">
                        <button onclick="adjustBulkDays(-7)" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm">-7æ—¥</button>
                        <button onclick="adjustBulkDays(-1)" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm">-1æ—¥</button>
                        <input type="number" id="bulk-move-days" value="0" class="w-20 px-3 py-2 border border-slate-300 rounded-lg text-center">
                        <button onclick="adjustBulkDays(1)" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm">+1æ—¥</button>
                        <button onclick="adjustBulkDays(7)" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm">+7æ—¥</button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">æ‹…å½“è€…å¤‰æ›´</label>
                    <select id="bulk-assignee" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                        <option value="">å¤‰æ›´ã—ãªã„</option>
                        <option value="å±±ç”°">å±±ç”°</option>
                        <option value="ä½è—¤">ä½è—¤</option>
                        <option value="éˆ´æœ¨">éˆ´æœ¨</option>
                        <option value="ç”°ä¸­">ç”°ä¸­</option>
                        <option value="é«˜æ©‹">é«˜æ©‹</option>
                    </select>
                </div>
            </div>
            <div class="p-4 border-t border-slate-200 flex justify-end gap-2">
                <button onclick="closeBulkEditModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button onclick="applyBulkEdit()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    é©ç”¨
                </button>
            </div>
        </div>
    </div>
</body>
</html>
