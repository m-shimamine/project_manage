# タスク一覧画面 実装計画書

## 1. 概要

### 1.1 目的
`/schedule/tasks` のタスク一覧画面を、モック（`public/mock/tasks/index.html`）と同等の機能・デザインに改修する。

### 1.2 対象ファイル

| 種別 | ファイルパス | 役割 |
|------|-------------|------|
| テンプレート | `app/Views/schedule/task_list.php` | 画面表示 |
| パーシャル | `app/Views/schedule/partials/task_modal.php` | タスク編集モーダル |
| コントローラ | `app/Controllers/ScheduleController.php` | 画面表示処理 |
| API | `app/Controllers/Api/TaskApiController.php` | REST API |
| サービス | `app/Services/TaskService.php` | ビジネスロジック |
| JavaScript | `public/js/schedule/task-list/` | フロントエンド処理（新規作成） |

---

## 2. 機能一覧と処理概要

### 2.1 2段ヘッダーテーブル

**概要**: テーブルヘッダーを2段構成にし、「予定」「実績」でカラムをグループ化して視認性を向上させる。

**処理の流れ**:
1. 1段目ヘッダーで「予定」（5列）と「実績」（4列）をcolspanでグループ化
2. 2段目ヘッダーで各カラムの詳細名を表示
3. 予定列は水色背景、実績列は琥珀色背景で色分け

---

### 2.2 フィルター機能

**概要**: 複数の条件を組み合わせてタスクを絞り込む。フィルターはクライアント側で処理し、サーバー通信なしで即座に結果を表示する。スケジュール画面と同様のUI形式を採用。

**フィルター方式（2種類）**:

#### A. 検索パネル形式（絞込ボタン）
- 「絞込」ボタンをクリックするとパネルが表示/非表示
- パネル内に担当者、ステータス、工程のドロップダウン
- 値変更時に即座にフィルター適用
- 「クリア」ボタンで全フィルターリセット

#### B. ヘッダーフィルター形式（カラムヘッダークリック）
- テーブルヘッダーの工程、担当者、ステータス、遅延カラムをクリック
- クリック位置にドロップダウンメニューを表示
- 値を選択すると即座にフィルター適用
- フィルター適用中のカラムはアイコン色が変化（青色）

**フィルター項目**:
- 工程（ドロップダウン）
- 担当者（ドロップダウン）
- ステータス（ドロップダウン：未着手/進行中/完了/保留）
- 遅延（ドロップダウン：遅延あり/予定通り）
- テキスト検索（タスク名、担当者名、備考で部分一致検索）

**処理の流れ**:
1. 絞り込みボタンまたはヘッダーカラムクリックでフィルターUIを表示
2. 各フィルター条件を選択
3. 即座にAND条件を組み合わせてタスク配列をフィルタリング
4. テーブル行の表示/非表示を切り替え
5. フィルター適用中はトースト通知で件数を表示
6. クリアボタンで全フィルターをリセットし全件表示に戻す

---

### 2.3 編集モード

**概要**: 表示モードと編集モードを切り替え、編集モードでは行の追加・削除・並び替えなどの操作が可能になる。

**処理の流れ**:
1. 「編集」ボタンクリックで編集モードに切り替え
2. 編集モードでは以下が有効化:
   - 右クリックメニュー
   - ドラッグ&ドロップ並び替え
   - 行選択チェックボックス
   - フッターに編集アクションボタン表示
3. 「表示」ボタンまたは「キャンセル」で表示モードに戻る
4. 「一括登録」で変更をサーバーに保存

---

### 2.4 ドラッグ&ドロップ並び替え

**概要**: タスク行をドラッグして並び順を変更する。変更はローカルで即時反映し、保存時にサーバーへ送信する。

**処理の流れ**:
1. 並替カラムのグリップアイコンをドラッグ開始
2. ドラッグ中は行を半透明表示、ドロップ先に青線を表示
3. ドロップ時にタスク配列の順序を入れ替え
4. テーブルを再描画
5. 一括登録時に新しい並び順をAPIで保存（`POST /api/tasks/reorder`）

---

### 2.5 右クリックメニュー

**概要**: タスク行を右クリックすると、行操作用のコンテキストメニューを表示する。タスク用とサブタスク用で別のメニューを表示する。

**タスク用メニュー**:
- 上に行追加 / 下に行追加
- サブタスク追加
- コピーして上に追加 / コピーして下に追加
- 削除

**サブタスク用メニュー**:
- 上にサブタスク追加 / 下にサブタスク追加
- コピーして上に追加 / コピーして下に追加
- 削除

**処理の流れ**:
1. 編集モード時に行を右クリック
2. クリック位置にメニューを表示（画面端では位置調整）
3. メニュー項目クリックで該当操作を実行
4. 他の場所をクリックするとメニューを閉じる

---

### 2.6 一括編集モーダル

**概要**: 複数のタスクを選択し、共通の値を一括で設定する。

**編集可能項目**:
- 担当者
- ステータス
- 進捗率
- 工程

**処理の流れ**:
1. チェックボックスで複数タスクを選択
2. 選択アクションバーの「一括編集」ボタンをクリック
3. モーダルで変更したい項目のみ値を設定（空欄は変更しない）
4. 「適用」で選択タスクに値を一括設定
5. テーブルを再描画

---

### 2.7 クリップボード機能

**概要**: キーボードショートカットでタスクをコピー&ペーストする。

**処理の流れ**:
1. チェックボックスでタスクを選択
2. Ctrl+C でメモリにコピー（「コピーしました」と通知表示）
3. Ctrl+V でメモリのタスクを末尾に追加（新しいIDを割り当て）
4. テーブルを再描画

---

### 2.8 Undo機能（元に戻す）

**概要**: 編集操作を取り消して1つ前の状態に戻す。履歴は最大20件保持する。

**処理の流れ**:
1. 編集操作（追加、削除、変更など）のたびに現在の状態を履歴に保存
2. Ctrl+Z または「元に戻す」ボタンで直前の状態を復元
3. テーブルを再描画
4. 履歴が空の場合はボタンを無効化

---

### 2.9 フッター統計表示

**概要**: タスクの集計情報をフッターにリアルタイム表示する。

**表示項目**:
- 全タスク数
- 完了数
- 進行中数
- 未着手数
- 遅延数

**処理の流れ**:
1. タスク配列をループして各ステータスをカウント
2. 遅延日数が正のタスクを遅延としてカウント
3. フッターの各数値を更新
4. フィルター適用時はフィルター後のタスクで再集計

---

### 2.10 プロジェクトの進捗状況モーダル

**概要**: プロジェクト全体の進捗状況をモーダルでグラフィカルに表示する。ヘッダーの「プロジェクトの進捗状況」ボタンから開く。

**表示項目**:
- プロジェクト名・顧客名
- 全体進捗率（パーセント表示＋プログレスバー）
- 完了タスク数 / 全タスク数
- ステータス別内訳（完了/進行中/未着手/遅延）
- 工程別進捗（各工程のタスク進捗率をバーグラフで表示）

**処理の流れ**:
1. 「プロジェクトの進捗状況」ボタンをクリック
2. モーダルを表示
3. タスクデータから各統計値を集計
4. 進捗バーとカウント数を表示
5. 「閉じる」ボタンまたは背景クリックでモーダルを閉じる

---

### 2.11 インポート機能

**概要**: CSVまたはExcelファイルからタスクを一括登録する。

**対応形式**: CSV（UTF-8）、Excel（.xlsx, .xls）

**処理の流れ**:
1. インポートボタンでモーダルを開く
2. ファイルをドラッグ&ドロップまたは選択
3. ファイルを読み込んでプレビュー表示（最初の10行程度）
4. カラムマッピングを確認
5. 「インポート」でサーバーへ送信（`POST /api/tasks/import`）
6. サーバー側でファイルを解析し、タスクをDB登録
7. 完了後にタスク一覧を再読み込み

---

### 2.12 エクスポート機能

**概要**: タスク一覧をCSVまたはExcel形式でダウンロードする。

**対応形式**: CSV（UTF-8 BOM付き）、Excel（.xlsx）

**処理の流れ**:
1. エクスポートボタンでモーダルを開く
2. 形式（CSV/Excel）と対象（全件/選択のみ）を選択
3. 「エクスポート」でサーバーへリクエスト（`GET /api/tasks/export`）
4. サーバー側でタスクを取得し、指定形式でファイル生成
5. ブラウザでファイルをダウンロード

---

### 2.13 一括日付更新

**概要**: 複数タスクの予定開始日・終了日を、工数と担当者に基づいて自動計算する。

**計算ロジック**:
- 担当者ごとに日付を管理（同じ担当者のタスクは連続して配置）
- 工数から終了日を算出（開始日 + 工数 - 1）
- 土日除外オプション対応（営業日ベース計算）
- 完了タスクは計算対象外

**処理の流れ**:
1. 一括日付更新ボタンでモーダルを開く
2. 開始タスク、終了タスク（任意）、基準日、土日除外オプションを設定
3. 「プレビュー」で計算結果を確認
4. 「適用」でサーバーへ送信（`POST /api/tasks/calculate-dates`）
5. 計算された日付をタスクに反映
6. テーブルを再描画

---

## 3. API一覧

### 3.1 既存API

| エンドポイント | メソッド | 用途 |
|--------------|--------|------|
| `/api/tasks` | GET | タスク一覧取得 |
| `/api/tasks/{id}` | GET | タスク詳細取得 |
| `/api/tasks` | POST | タスク作成 |
| `/api/tasks/{id}` | PUT | タスク更新 |
| `/api/tasks/{id}` | DELETE | タスク削除 |
| `/api/tasks/bulk-update` | POST | 一括更新 |
| `/api/tasks/reorder` | POST | 並び替え |
| `/api/tasks/{id}/copy` | POST | タスクコピー |

### 3.2 追加API

| エンドポイント | メソッド | 用途 | 概要 |
|--------------|--------|------|------|
| `/api/tasks/bulk-delete` | POST | 一括削除 | 指定IDのタスクとそのサブタスクを一括削除 |
| `/api/tasks/export` | GET | エクスポート | CSV/Excel形式でタスクをダウンロード |
| `/api/tasks/import` | POST | インポート | CSV/Excelファイルからタスクを登録 |
| `/api/tasks/calculate-dates` | POST | 一括日付計算 | 担当者・工数ベースで日付を自動計算 |
| `/api/tasks/stats` | GET | 統計情報取得 | ステータス別件数を取得 |

---

## 4. JavaScriptクラス構成

### 4.1 クラス一覧と責務

| クラス名 | 責務 |
|---------|------|
| **TaskListApp** | メインアプリケーション。各モジュールの初期化と統括 |
| **TaskDataManager** | タスクデータの管理。CRUD操作、選択状態、変更検知 |
| **TaskTableRenderer** | テーブルの描画。表示モード/編集モードの切り替え |
| **TaskEventHandler** | イベント処理。ボタンクリック、モーダル操作など |
| **TaskFilterManager** | フィルター処理。条件適用、クリア、フィルター状態管理 |
| **TaskDragDropHandler** | ドラッグ&ドロップ。行の並び替え処理 |
| **TaskContextMenu** | 右クリックメニュー。メニュー表示と操作実行 |
| **TaskClipboard** | クリップボード。コピー&ペースト処理 |
| **TaskUndoManager** | Undo機能。履歴管理と状態復元 |
| **TaskImportExport** | インポート/エクスポート。ファイル読み書き |
| **TaskBulkDateUpdater** | 一括日付更新。日付計算ロジック |
| **TaskKeyboardHandler** | キーボードショートカット。Ctrl+Z/C/V、Delete、Escなど |

### 4.2 データフロー

```
[ユーザー操作]
      ↓
[TaskEventHandler / TaskKeyboardHandler] → イベント検知
      ↓
[TaskListApp] → 各モジュールへ処理を振り分け
      ↓
[TaskDataManager] → データ更新、履歴保存
      ↓
[TaskTableRenderer] → テーブル再描画
      ↓
[フッター統計更新]
```

---

## 5. 操作別処理方式

| 操作 | 処理方式 | API呼出タイミング |
|------|---------|-----------------|
| 行選択 | ローカル | なし |
| 全選択 | ローカル | なし |
| インライン編集 | ローカル | 保存時に一括 |
| 行追加 | ローカル | 保存時に一括 |
| サブタスク追加 | ローカル | 保存時に一括 |
| 行コピー（Ctrl+C） | ローカル | なし |
| 行ペースト（Ctrl+V） | ローカル | 保存時に一括 |
| 行削除 | ローカル → API | 即時または保存時 |
| 元に戻す（Ctrl+Z） | ローカル | なし |
| ドラッグ並替 | ローカル | 保存時に一括 |
| 一括編集 | ローカル → API | 適用時に即時 |
| 一括削除 | API | 即時 |
| 一括登録 | API | 即時 |
| フィルター | ローカル | なし |
| インポート | API | 即時 |
| エクスポート | API | 即時 |
| 一括日付更新 | API | 即時 |

---

## 6. 実装フェーズ

### Phase 1: 基盤整備
- JavaScriptクラス基盤（TaskListApp、TaskDataManager、TaskTableRenderer）
- 2段ヘッダーテンプレート
- フッター統計表示

### Phase 2: 編集機能
- 編集モード切替
- ドラッグ&ドロップ並び替え
- 右クリックメニュー
- 一括編集モーダル
- 一括削除API

### Phase 3: Undo/クリップボード
- Undo機能（履歴20件）
- Ctrl+C/Vコピー&ペースト
- キーボードショートカット（Delete、Enter、Escape）

### Phase 4: フィルター機能
- フィルターパネルUI
- フィルター処理実装
- フィルター状態保持

### Phase 5: インポート/エクスポート
- インポートモーダルUI
- エクスポートモーダルUI
- インポートAPI（CSV/Excel解析）
- エクスポートAPI（CSV/Excel生成）
- テンプレートダウンロード

### Phase 6: 一括日付更新
- 一括日付モーダルUI
- 営業日計算ロジック
- 担当者別日付割当
- プレビュー機能

---

## 7. 検証項目

1. **基本表示**: プロジェクト選択でタスク一覧が正しく表示されること
2. **2段ヘッダー**: 予定/実績のグループ化が正しく表示されること
3. **編集モード**: 切り替えが正しく動作すること
4. **ドラッグ&ドロップ**: 並び替えが正しく動作すること
5. **右クリックメニュー**: タスク/サブタスク別にメニューが表示されること
6. **一括編集**: 選択タスクに値が正しく適用されること
7. **Undo**: Ctrl+Zで操作が取り消されること
8. **クリップボード**: Ctrl+C/Vでコピー&ペーストできること
9. **フィルター（パネル）**: 絞込ボタンでパネルが表示され、各条件で絞り込まれること
10. **フィルター（ヘッダー）**: カラムヘッダークリックでドロップダウンが表示され、選択でフィルター適用されること
11. **プロジェクトの進捗状況**: モーダルが表示され、統計情報が正しく表示されること
12. **インポート**: CSV/Excelファイルからタスクが登録されること
13. **エクスポート**: CSV/Excel形式でダウンロードできること
14. **一括日付更新**: 営業日ベースで日付が計算されること
15. **フッター統計**: 件数が正しく集計されること

---

## 8. 注意事項

### パフォーマンス
- 大量タスク（100件以上）での動作確認が必要
- 必要に応じて仮想スクロールの導入を検討

### セキュリティ
- CSRFトークンの適切な処理
- ユーザー入力値のエスケープ（XSS対策）
- ファイルアップロードの検証（インポート時）

### ブラウザ対応
- Chrome、Firefox、Edgeでの動作確認
- IE11は非対応
